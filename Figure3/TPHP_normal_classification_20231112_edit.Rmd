---
title: "normal_tissue_specificity"
author: ""
date: '2022-12-21'
output: html_document
---

# 0.setup
```{r setup, include=FALSE}
## knitr::opts_chunk$set(echo = TRUE)
# pacman::p_unload(pacman::p_loaded(), character.only = T)
# rm(list = ls())
library(tidyverse)
library(magrittr)
library(readxl)
library(writexl)

setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification')
source('//172.16.13.136/share/members/jiangwenhao/TPHP/my_fun.R')
```


# 1.protein specificity of normal tissues
## Ulhen's classification method
```{r}
source("//172.16.13.136/share/members/yuel/2022/codes/20231113_ulhen_class.R")

df<-read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/20220719_rm_randomNA_normal.xlsx")
ai<-read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/1_202207TPHP_1781file_info_edited_v4.xlsx")
df %<>% filter(DIA_ID != 'DIA_554')
ai %<>% filter(DIA_ID != 'DIA_554')
# remove DIA554 (vagina)


di<-inner_join(ai,df[,c(1,16:ncol(df))],by="FileName")
table(di$patient_ID)
df0<-di[which(di$patient_ID %in% c("1","2","3","4","7","JD-1","JD-2","JD-3","JD-4")),]
write_xlsx(df0,"20231113_TPHP_normal.xlsx")


table(df0$patient_ID)
table(df0$anatomical_classification)
dim(df0) # 497 12410
df1<-apply(df0[,-c(1:18)],c(1,2),as.numeric)
min(df1,na.rm = T) # 9.795163
max(df1,na.rm=T) # 24.00716

df0[,-c(1:18)] <- df1
rio::export(df0, 'TPHP_normalData_for_classification_20231113.xlsx')


pm1<-df1
pm1[is.na(pm1)]<-log2(2^min(pm1,na.rm = T)*0.5)
pm2<-aggregate(2^pm1,by=list(df0$anatomical_classification),median)

tissue_type_clas<-list()
tissue_type_clas[[1]]<-ulhen_class(pm2[,1:50])
for (i in 2:floor(ncol(pm2)/50)){
  tissue_type_clas[[i]]<-ulhen_class(pm2[,c(1,(50*(i-1)+1):(50*i))])
  cat(paste("Processed",i*50,"/",ncol(pm2) ,sep = " "),"\n")
}
tissue_type_clas[[ceiling(ncol(pm2)/50)]]<-ulhen_class(pm2[,c(1,(50*floor(ncol(pm2)/50)+1):ncol(pm2))])
tissue_type_clas_all<-tissue_type_clas%>% reduce_right(full_join, by = "tissue_type")
library(writexl)
write_xlsx(tissue_type_clas_all,"20231113TPHP_51tissue_ulhen_classification.xlsx")



tissue_mean1<-tissue_type_clas_all
symbol<-colnames(tissue_mean1)[-c(1)]
#3774 enriched and group enriched proteins
mean_clas_symbol_list<-apply(tissue_mean1[,-c(1)],1, function (v){
  symbol[which(v=="tissue enriched" | v =="group enriched")]
})
length(unique(unlist(mean_clas_symbol_list))) # 4086

# library(plyr)
en_tab<-sapply(mean_clas_symbol_list,function(v){
  data.frame(t(v))
})
a<-as.data.frame(t(plyr::rbind.fill(en_tab)))
colnames(a)<-tissue_mean1$tissue_type

write.csv(a,"20231113yuel_TPHP_enriched_proteins.csv",row.names = F)



#1629 tissue enriched proteins
mean_clas_symbol_list<-apply(tissue_mean1[,-c(1)],1, function (v){
  symbol[which(v=="tissue enriched" )]
})
length(unique(unlist(mean_clas_symbol_list))) # 1629

# library(plyr)
en_tab<-sapply(mean_clas_symbol_list,function(v){
  data.frame(t(v))
})
b<-as.data.frame(t(plyr::rbind.fill(en_tab)))
colnames(b)<-tissue_mean1$tissue_type
# 
write.csv(b,"20231113yuel_TPHP_tissue_979_enriched_proteins.csv",row.names = F)


tmp <- tissue_mean1 %>%
  pivot_longer(-tissue_type, names_to = 'UniprotID', values_to = 'Classification') %>%
  filter(str_detect(Classification, 'enriched')) %>%
  arrange(desc(Classification), UniprotID, tissue_type)

length(unique(tmp$UniprotID)) # 4057
tmp %>% filter(Classification == 'tissue enriched') %>% pull(UniprotID) %>% unique() %>% length() # 1629
tmp %>% filter(Classification == 'group enriched') %>% pull(UniprotID) %>% unique() %>% length() # 2627

rio::export(tmp, '20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')
rio::export(pm2, '20231113TPHP_normal_tissue_organ_median.xlsx')


dfprot <- rio::import('//172.16.13.136/TPHP/TPL/libs/20220616_fraglib/protein.tsv')
dfprot %<>% select(`Protein ID`, Gene) %>% rename(UniprotID = 'Protein ID')

X <- pm2 %>% column_to_rownames('Group.1') %>% t() %>% as.data.frame() %>% rownames_to_column('UniprotID') %>% right_join(dfprot, .) %>% arrange(UniprotID)
Y <- tissue_type_clas_all %>% column_to_rownames('tissue_type') %>% t() %>% as.data.frame() %>% rownames_to_column('UniprotID') %>% right_join(dfprot, .) %>% arrange(UniprotID)
list(`Normal median matrix` = X, `Tissue specificity` = Y) %>% 
  rio::export('Supplemenrat_table_3_tissue_specificity_20231113.xlsx')

```



### enriched proteins expression heatmap (sample level)
```{r}
df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')

# # uniprot to symbol
# prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
# prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
#   if(length(unique(dfsub$SYMBOL)) > 1){
#     dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
#                         SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
#   }
#   return(dfsub)
# })
# prot_query %<>% setNames(c('UniprotID', 'symbol'))
# protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

dfprot <- rio::import('//172.16.13.136/TPHP/TPL/libs/20220616_fraglib/protein.tsv')
prot_query <- dfprot %>% select(`Protein ID`, Gene) %>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')


# tissue enriched proteins
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  arrange(tissue_type)

df_tisen <- df0 %>%
  select(FileName, DIA_ID, anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)

# keepna
pm <- df_tisen %>% select(-(1:3))
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen$FileName

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
na_pos <- is.na(pm)
na_fill <- min(pm, na.rm = T) + log2(0.1)
pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
pm.scale[na_pos] <- NA
names(pm.scale) <- df_tisen$FileName

prot <- colnames(df_tisen)[-(1:3)]
row.tissue <- protinfo_tisen$tissue_type

pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue=row.tissue,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen$anatomical_classification),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
                   tissue=tissue_color,row.tissue=tissue_color)

# plot
dim(pm_heat)
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_tissue_enriched_heatmap_scale_fill_na_1629protein_496files_20231113.pdf",width=10,height=10)

```

### enriched proteins expression heatmap (organ level)
```{r}
# df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')

# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})
pm2$anatomical_classification %<>% 
  sapply(function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched proteins
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)

# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# keepna
pm <- df_tisen_organ %>% select(-1)
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$anatomical_classification

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-1]
row.tissue <- protinfo_tisen$tissue_type

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue=row.tissue,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen_organ$anatomical_classification),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
                   tissue=tissue_color,row.tissue=tissue_color)

# plot
dim(pm_heat)
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_tissue_enriched_heatmap_scale_1629protein_51organs_20231113.pdf",width=11,height=11)

b <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_tissue_enriched_heatmap_scale_1629protein_51organs_big_20231113.pdf",width=20,height=50)

```



### numbers
```{r}
pacman::p_unload(pacman::p_loaded(), character.only = T)
pacman::p_load(magrittr, tidyverse, hash)
source('//172.16.13.136/share/members/jiangwenhao/TPHP/my_fun.R')

# --------- 1. DDA identification generation ---------
ddaPath <- '//172.16.13.136/TPHP/TPL/libs/FragPipe_protein_20230203/'
tsvs <- list.files(ddaPath, 'protein\\.tsv', recursive = T)
tsvs %<>% stringr::str_detect('no_irt') %>% `!` %>% tsvs[.]
tissues <- stringr::str_replace(tsvs, '_protein\\.tsv', '')

# remove libraries with old version, or CARCINOMA, or multiple organs, or 480 acquired
old_lib <- c('bloodlib_B7_v2', 'BTL', 'nail', 'saliva', 'UMC')
rm_indice <- which(tissues %in% old_lib)
tissues %<>% .[-rm_indice]
tsvs %<>% .[-rm_indice]

rm_indice <- str_which(tissues, 'isoform|swissprot|^CA_|^MP_')
tissues %<>% .[-rm_indice]
tsvs %<>% .[-rm_indice]

# exclude libraries contained in others
rm_indice <- str_which(tissues, 'BIL|BLL|BFL|BOL|BTL|BPL|PIG|WB|WBC|RBC|platelet|plasma|fluid')
tissues %<>% .[-rm_indice]
tsvs %<>% .[-rm_indice]

# remove "v2" suffix
tissues %<>% str_replace('_v2$', '') 

# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tissues <- sapply(tissues, function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})
# length(tissues) # 58


# generate hash table about [tissue: proteins]
all_prot <- list()
for(i in 1:length(tissues)){
  tsv <- tsvs[i]
  tissue <- tissues[i]
  df <- read.delim(stringr::str_c(ddaPath, '/', tsv), stringsAsFactor = F, check.names = F)
  prots <- df$`Protein ID`
  all_prot[[i]] <- prots
}
names(all_prot) <- tissues


# generate matrix
prots_all <- sort(unique(unlist(all_prot)))
rlt <- data.frame(row.names = prots_all)
for(i in 1:length(all_prot)){
  tissue <- names(all_prot)[i]
  prots <- all_prot[[tissue]]
  rlt[, tissue] <- sapply(row.names(rlt), function(v){v %in% prots})
  
}
rlt <- rlt[!grepl(pattern = 'iRT', x = row.names(rlt)), ]
rlt <- cbind(row.names(rlt), rlt)
colnames(rlt)[1] <- ''
rlt[rlt == 'FALSE'] <- 'False'
rlt[rlt == 'TRUE'] <- 'True'
#rlt[, -1] <- apply(rlt[, -1], c(1, 2), as.logical)
write.table(rlt, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/TPHP_DDA_protein_identification_matrix_20231113.tsv', sep = '\t', row.names = F, quote = F)



# --------- 2. DIA identification generation ---------
### directly from classification result
X <- rio::import('20231113TPHP_51tissue_ulhen_classification.xlsx')
Y <- X %>%
  pivot_longer(-tissue_type, names_to = 'prot', values_to = 'class') %>%
  plyr::ddply(c('tissue_type', 'class'), function(dfsub){
    df_ret <- dfsub %>% slice(1) %>% select(tissue_type, class)
    df_ret$n <- nrow(dfsub)
    return(df_ret)
  }) %>%
  setNames(c('Sample type', 'Protein specificity', 'protein_number'))

# get abbreviation of sample types, if possible
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
df_DIA <- get_abbr(Y, 'Sample type', df_abbr = df_abbr)
df_DIA$`Protein specificity` %<>% str_to_sentence()

# remove 'not detected'
df_DIA %<>% filter(`Protein specificity` != 'Not detected')
df_DIA$`Protein specificity` %<>%
  factor(levels = c('Expressed in all tissues', 'Tissue enriched', 'Group enriched', 'Tissue enhanced', 'Mixed'), ordered = T)
df_DIA %<>% arrange(`Sample type`, `Protein specificity`)


# ----------------- Reading DDA data ----------------
DDA_protein <- '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/TPHP_DDA_protein_identification_matrix_20231113.tsv'
df <- read.delim(DDA_protein, stringsAsFactors = F, check.names = F, )

ncol(df) - 1 # number of sample types == 58
# Calculate the number of tissues expressing this protein
df['N_present'] <- apply(df[, -1], 1, function(e){ return(sum(e == 'True')) })

eval(parse(text = stringr::str_c("N <- c(", c("1", "2:7", "8:20", "21:51", "52:57", "58"), ");",
                                 "subdf <- df[df$N_present %in% N, ];",
                                 "present_", c("1", "2_7", "8_20", "21_51", "52_57", "58"), " <- apply(subdf[, -c(1, which(colnames(subdf) == 'N_present'))], 2, function(e){ return(sum(e == 'True')) });")))


present_comb <- data.frame(sample_type = names(present_1), present_1, present_2_7, present_8_20, present_21_51, present_52_57, present_58)
colnames(present_comb) <- c('Sample type', 'Detected in one sample type', 'Detected in 2-7 sample types', 'Detected in 8-20 sample types', 'Detected in 21-51 sample types', 'Detected in 52-57 sample types', 'Detected in all 58 sample types')
df_DDA <- reshape2::melt(present_comb, id = 'Sample type', variable.name = 'Protein specificity', value.name = 'protein_number')
# get abbreviation of sample types, if possible
df_DDA <- get_abbr(df_DDA, 'Sample type', df_abbr = df_abbr)
df_DDA %>% count(`Sample type`) # fluidlib


# --------- Visualization ---------------
pacman::p_load('ggpubr', 'RColorBrewer', 'ggsci')
# function
draw_F2A_barplot <- function(df, char_title, vec_color){
  p <- ggplot(df, aes(x=`Sample type`, y=`protein_number`, fill = `Protein specificity`)) + geom_bar(stat="identity", width=0.9, position="stack")
  
  p <- p +
    scale_fill_manual(values = vec_color)+
    labs(
      y = "Protein number",
      title = char_title
    )+
    guides(fill=guide_legend(nrow = 2))+
    theme(panel.grid = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.text = element_text(size = 12,color = "black"),
          axis.line = element_line(colour = "black"),
          axis.line.x = element_blank(),
          plot.subtitle = element_text(size = 30, hjust = 0, color="black")
    )+
    theme(legend.text = element_text(size = 15, color = "black"),legend.position = 'bottom',
          legend.title = element_text(size = 18, color="black"),)+
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(size = 12, vjust = 0,color = "black", angle = 90),
          axis.ticks.x = element_blank()
    )+
    theme(axis.title.y = element_text(size = 15, hjust = 0.5, color="black", angle = 90),
          axis.text.y = element_text(size = 12,color = "black", angle = 0),
          axis.ticks.y = element_blank()
    )
  return(p)
}
# parameters
ls_color <- list(c(214, 133, 122),
                 c(248, 176, 91),
                 c(240, 228, 66),
                 c(96, 217, 125),
                 c(94, 151, 181),
                 c(129, 117, 153))
vec_color <- hex_col(ls = ls_color)
p1 <- draw_F2A_barplot(df_DDA, 'DDA', vec_color)
p2 <- draw_F2A_barplot(df_DIA, 'DIA', vec_color)
p <- ggarrange(p1, p2,
               ncol = 1, nrow = 2,
               labels = c("A","B"),
               font.label = list(size = 14, face = "bold"))

# output
stringr::str_c('F2_DDA_DIA_', as.character(Sys.Date()), '.pdf') %>%
  ggsave(p, width = 20, height = 9)




```


### ratio
```{r}
X <- rio::import('20231113TPHP_51tissue_ulhen_classification.xlsx')
X[X == 'not detected'] <- 'not detected in over half of the samples'
Y <- X %>%
  pivot_longer(-tissue_type, names_to = 'prot', values_to = 'class') %>%
  plyr::ddply(c('tissue_type', 'class'), function(dfsub){
    df_ret <- dfsub %>% slice(1) %>% select(tissue_type, class)
    df_ret$n <- nrow(dfsub)
    return(df_ret)
  }) %>%
  setNames(c('Sample type', 'Protein specificity', 'protein_number'))

df <- Y %>% pivot_wider(`Sample type`, names_from = `Protein specificity`, values_from = protein_number)
df[is.na(df)] <- 0
colnames(df)[1] <- 'organ'
colnames(df) %<>% str_to_sentence()

df <- plyr::ddply(df, 'Organ', function(dfsub){
  x <- dfsub %>% slice(1) %>% select(-1)
  dfsub[1, -1] <- x / sum(x)
  return(dfsub)
})

# get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
df[, 1] <- sapply(df[, 1], function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

df_longer <- df %>% pivot_longer(-Organ, names_to = 'Classification', values_to = 'Percentage')
df_longer$Classification %<>% str_to_sentence()
df_longer$Classification %<>% factor(levels = rev(c('Tissue enriched', 'Group enriched', 'Tissue enhanced', 'Mixed', 'Not detected in over half of the samples', 'Expressed in all tissues')), ordered = T)

p <- ggplot(df_longer, aes(x=Organ, y=Percentage, fill = Classification)) +
  geom_bar(stat="identity", width=0.9, position="stack")
p <- p +
  scale_fill_brewer(palette = 'Set2')+
  labs(
    y = "Percentage",
  )+
  guides(fill=guide_legend(nrow = 2))+
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text = element_text(size = 12,color = "black"),
        axis.line = element_line(colour = "black"),
        axis.line.x = element_blank(),
        plot.subtitle = element_text(size = 30, hjust = 0, color="black")
  )+
  theme(legend.text = element_text(size = 15, color = "black"),legend.position = 'bottom',
        legend.title = element_text(size = 18, color="black"),)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, vjust = 0.5,color = "black", angle = 90),
        axis.ticks.x = element_blank()
  )+
  theme(axis.title.y = element_text(size = 15, hjust = 0.5, color="black", angle = 90),
        axis.text.y = element_text(size = 12,color = "black", angle = 0),
        axis.ticks.y = element_blank()
  )
ggsave('TPHP_tissue_classification_abundance_percentage_20231113.pdf', p, width = 10, height = 5)




```

### abundance ratio
```{r}
all<-readxl::read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/20220719_rm_randomNA_normal.xlsx")
info<-readxl::read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/1_202207TPHP_1781file_info_edited_v4.xlsx")
dim(info)
head(colnames(all),n=35) #1:15 for sample annotation
table(all$tissue_type)
ai<-inner_join(info,all[,c(1,16:ncol(all))],by = "FileName" )
rownames(ai)<-ai$FileName
head(colnames(ai),n=20)
table(ai$anatomical_classification) #55
tissue<-unique(ai$anatomical_classification)
npm<-apply(ai[,-c(1:18)], c(1,2),as.numeric)
imp<-min(npm,na.rm = T)+log2(0.5)
tissue_list<-list()
dotlist<-list()
boxlist<-list()
for (i in 1:length(tissue)){
  # i=1
  t1<-2^npm[which(ai$anatomical_classification==tissue[i]),]
  t2<-t1[,apply(t1, 2, function(v) sum(is.na(v))/nrow(t1)<0.5)]
  # dim(t2)
  t2[is.na(t2)]<-2^imp
  t3<-apply(t2,2, summary)
  tissue_list[[i]]<-as.data.frame(t2)
  boxlist[[i]]<-as.data.frame(t3)
  su<-sum(t2)
  t4<-data.frame(sum=apply(t2, 2, sum))
  t4$per<-log10(t4$sum/su)
  t4$rank<-rank(-t4$sum)
  dotlist[[i]]<-as.data.frame(t4)
}
names(tissue_list)=names(dotlist)=names(boxlist)<-tissue
# write_xlsx(tissue_list,"//172.16.13.136/share/members/yuel/2022/tables/20220906_tissue_list.xlsx")
# write_xlsx(dotlist,"//172.16.13.136/share/members/yuel/2022/tables/20220906_dot_list.xlsx")
# write_xlsx(boxlist,"//172.16.13.136/share/members/yuel/2022/tables/20220906_box_list.xlsx")

ulhen<-readxl::read_xlsx("20231113TPHP_51tissue_ulhen_classification.xlsx")
# pdf("20231113_abundance_curve.pdf", width = 18, height = 10)###################
# par(mfrow=c(3, 4))##################
ra<-list()
for (i in 1:nrow(ulhen)){
  # i=1
  t<-ulhen$tissue_type[i]
  dp<-dotlist[[t]]
  dp<-dp[order(dp$rank,decreasing = F),]
  dp$pert<-cumsum(10^(dp$per))
  en<-t(ulhen[which(ulhen$tissue_type==t),rownames(dp)])
  # plot(dp$rank, dp$pert, col = '#00000033', pch = 19,xlab = 'Abundance rank', ylab = '%. of total abundance', main = t)
  # abline(h = 0.8, v = min(dp$rank[dp$pert>=0.8]), lty = 2, lwd = 1)
  ex  <- en=="tissue enriched"
  # points(dp$rank[ex], dp$pert[ex], col = 1,bg = brewer.pal(9,"YlOrRd")[6], pch = 21, cex = 2)
  ea<- en=="Expressed in all tissues"
  ## points(dp$rank[ea], dp$pert[ea], col = 1,bg = brewer.pal(11,"RdBu")[9], pch = 21, cex = 1)
  eh<-en=="tissue enhanced"
  mx<-en=="mixed"
  ge<-en=="group enriched"
  nt<-en=="not detected"
  ra[[i]]<-c(sum(10^dp$per[ex]),sum(10^dp$per[ea]),sum(10^dp$per[eh]),sum(10^dp$per[mx]),sum(10^dp$per[ge]),sum(10^dp$per[nt]))
}
# dev.off()

per_tab<-do.call(rbind,ra)
colnames(per_tab)<-c("tissue enriched","Expressed in all tissues","tissue enhanced","mixed","group enriched","not detected")
rownames(per_tab)<-ulhen$tissue_type
write.csv(per_tab, "tissue_classification_abundance_percentage_20231113.csv")##give to jiangwenhao for stacked barplot

# 
# #####################
# ##GOBP enrichment
# library(clusterProfiler)
# library(org.Hs.eg.db)
# bf.list<-list()
# for (i in 1:length(tissue)){
#   # i=1
#   bx<-as.data.frame(t(boxlist[[i]]))
#   # entrez<-bitr(rownames(bx),fromType = "UNIPROT",toType = c("ENTREZID","GENENAME"),OrgDb = "org.Hs.eg.db")
#   bx$UNIPROT<-rownames(bx)
#   # bf<-left_join(bx,entrez,by="UNIPROT")
#   bf.list[[i]]<-enrichGO(bx$UNIPROT,OrgDb = "org.Hs.eg.db",keyType = "UNIPROT",ont = "BP",pvalueCutoff = 0.05)%>% as.data.frame()
#   pro.list<-strsplit(bf.list[[i]]$geneID,split = "/")
#   bf.list[[i]]$medain<-sapply(pro.list,function(v){median(bx[v,]$Median)})
#   bf.list[[i]]$sum<-sapply(pro.list,function(v){sum(bx[v,]$Median)})  
# }
# names(bf.list)<-tissue
# write_xlsx(bf.list,"D:/data/1project/TPL/2022/tables/tissue_GOBP.xlsx")
# write_xlsx(bf.list,"D:/data/1project/TPL/2022/tables/tissue_GOBP.xlsx")
# 
# pdf("D:/data/1project/TPL/2022/figure/20220907_GOBP_abundance_curve_sum.pdf", width = 18, height = 10)###################
# par(mfrow=c(3, 4))##################
# ra<-list()
# for (i in 1:length(tissue)){
#   
#   t<-bf.list[[i]]
#   t$rank2<-rank(-t$sum)
#   # t$rank<-rank(-t$medain)
#   gene.ratio<-sapply(strsplit(t$GeneRatio,split = "/"), function(v) as.numeric(v[1])/as.numeric(v[2]))
#   t1<-t[t$p.adjust<0.001 & gene.ratio> 0.02,]
#   # plot(t$rank, log10(t$medain), col = '#00000033', pch = 19,xlab = 'Abundance rank', ylab = 'log10 tansformed total abundance', main = tissue[i])
#   # points(t1$rank, log10(t1$medain), col = 1,bg = brewer.pal(9,"YlOrRd")[6], pch = 21, cex = 2)
#   # text(label=t1$Description[which.min(t1$rank)],x=t1$rank[which.min(t1$rank)]+120, y=log10(t1$medain[which.min(t1$rank)])-0.005)
#   
#   
#   # # gene.ratio<-sapply(strsplit(t$GeneRatio,split = "/"), function(v) as.numeric(v[1])/as.numeric(v[2]))
#   # t1<-t[t$p.adjust<0.001 & gene.ratio> 0.02,]
#   plot(t$rank2, log10(t$sum), col = '#00000033', pch = 19,xlab = 'Abundance rank', ylab = 'log10 tansformed total abundance', main = tissue[i])
#   points(t1$rank2, log10(t1$sum), col = 1,bg = brewer.pal(9,"YlOrRd")[6], pch = 21, cex = 2)
#   text(label=t1$Description[which.min(t1$rank2)],x=t1$rank[which.min(t1$rank2)]+120, y=log10(t1$sum[which.min(t1$rank2)])-0.005)
#   
# }
# dev.off()
# 
# library(fmsb)
# pdf("TPHP_carcinoma_20organs_14functions_radarchart_nafill_20220906.pdf", width = 30, height = 10)
# # radarchart(mat,
# #            axistype = 1, pcol = curve_colors, #maxmin = F,
# #            plwd = 1, plty = 1,
# #            cglcol = "gray", cglty = 1, axislabcol = "black",
# #            caxislabels = seq(min_range, max_range, length.out = 5),
# #            cglwd = 0.8,
# #            vlcex = 1.6
# # )
# # legend(x = 2, y = 1, legend = rownames(mat)[-(1:2)], bty = "n", pch = 20, col = curve_colors, text.col = "black", cex = 2, pt.cex = 2)
# # dev.off()
# sum.list<-sapply(bf.list, function(v){
#   v$Description
# })
# all_go<-reduce(sum.list,intersect)
# # x <- tibble::rownames_to_column(sum.list,"tissue")
# bp_tab<-as.data.frame(matrix(ncol=length(sum.list),nrow=length(all_go)))
# for (i in 1:length(sum.list)){
#   # i=1
#   t<-bf.list[[i]]
#   rownames(t)<-t$Description
#   bp_tab[,i]<-t[all_go,c("sum")]
# }
# colnames(bp_tab)<-tissue
# rownames(bp_tab)<-all_go
# mat <- as.matrix(log10(bp_tab))
# 
# fivenum(mat)
# min_range <- floor(fivenum(mat)[1])
# max_range <- ceiling(fivenum(mat)[5])
# mat <- rbind(max_range = max_range, min_range = min_range, mat) 
# # mat[is.na(mat)] <- min_range
# sum_intensity<-apply(mat[-c(1,2),], 1, sum)
# rank3<-rank(-sum_intensity)
# highlight<-rownames(mat)[-c(1:2)][which(rank3<=10)]
# # set color
# qual_color_pals <- brewer.pal.info %>% filter(category == "qual")
# all_colors <- Map(brewer.pal, qual_color_pals$maxcolors, rownames(qual_color_pals)) %>%
#   unlist() %>%
#   unique()
# set.seed(1)
# curve_colors <- c(rep("grey",127),sample(all_colors,10))
# names(curve_colors)<-c(setdiff(all_go,highlight),highlight)
# mat<-mat[c("max_range","min_range",names(curve_colors)),]%>%as.data.frame()
# pdf("TPHP_carcinoma_20organs_137functions_radarchart_20220906.pdf", width = 30, height = 10)
# radarchart(mat,
#            axistype = 1, pcol = curve_colors,# maxmin = F,
#            plwd = 1, plty = 1,
#            cglcol = "gray", cglty = 1, axislabcol = "gray",
#            caxislabels = seq(min_range, max_range, length.out = 5),
#            cglwd = 0.8,
#            vlcex = 1.6
# )
# legend(x = 2, y = 1, legend = rownames(mat)[-(1:2)], bty = "n", pch = 20, col = curve_colors, text.col = "black", cex = 2, pt.cex = 2)
# dev.off()
# # 

df <- per_tab %>% as.data.frame() %>% rownames_to_column('organ')
colnames(df)[colnames(df) == 'not detected'] <- 'not detected in over half of the samples'
colnames(df) %<>% str_to_sentence()


# get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
df[, 1] <- sapply(df[, 1], function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

df_longer <- df %>% pivot_longer(-Organ, names_to = 'Classification', values_to = 'Percentage')
df_longer$Classification %<>% str_to_sentence()
df_longer$Classification %<>% factor(levels = rev(c('Tissue enriched', 'Group enriched', 'Tissue enhanced', 'Mixed', 'Not detected in over half of the samples', 'Expressed in all tissues')), ordered = T)


my_colors <- RColorBrewer::brewer.pal(length(fct_unique(df_longer$Classification)), 'Set2')
my_colors[1] <- '#CCCCCC'

p <- ggplot(df_longer, aes(x=Organ, y=Percentage, fill = Classification)) +
  geom_bar(stat="identity", width=0.9, position="stack")
p <- p +
  scale_fill_manual(values = my_colors)+
  # scale_fill_brewer(palette = 'Set2')+
  labs(
    y = "Percentage",
  )+
  guides(fill=guide_legend(nrow = 2))+
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text = element_text(size = 12,color = "black"),
        axis.line = element_line(colour = "black"),
        axis.line.x = element_blank(),
        plot.subtitle = element_text(size = 30, hjust = 0, color="black")
  )+
  theme(legend.text = element_text(size = 15, color = "black"),legend.position = 'bottom',
        legend.title = element_text(size = 18, color="black"),)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, vjust = 0.5,color = "black", angle = 90),
        axis.ticks.x = element_blank()
  )+
  theme(axis.title.y = element_text(size = 15, hjust = 0.5, color="black", angle = 90),
        axis.text.y = element_text(size = 12,color = "black", angle = 0),
        axis.ticks.y = element_blank()
  )
ggsave('TPHP_tissue_classification_abundance_percentage_20231113.pdf', p, width = 11, height = 5.5)




```



### druggable enriched proteins
```{r}
df_drug <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/drug/drugbank_results_all_20230207.csv')
# df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')

# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})
pm2$anatomical_classification %<>% 
  sapply(function(x) {
    x %>%
      str_split('_') %>%
      .[[1]] %>%
      sapply(function(e){
        ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
      }) %>%
      str_c(collapse = '_')
  })

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched druggable proteins
prot_druggable <- df_drug$`Target uniprot` %>% str_split('; ') %>% unlist() %>% unique() %>% sort() %>% .[. != '']

protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  filter(UniprotID %in% all_of(prot_druggable)) %>% # druggable 
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)


# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# keepna
pm <- df_tisen_organ %>% select(-1)
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$anatomical_classification

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-1]
row.tissue <- protinfo_tisen$tissue_type

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue=row.tissue,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen_organ$anatomical_classification),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
  tissue=tissue_color,row.tissue=tissue_color)

# plot
dim(pm_heat)
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_tissue_enriched_druggable_heatmap_scale_356protein_51organs_20231113.pdf",width=12,height=13)
pm_heat %>% rownames_to_column('Target') %>% rio::export('TPHP_normal_Ulhen_tissue_enriched_druggable_heatmap_scale_3569protein_51organs_20231113.xlsx')


### side effect check
side_effect_targets <- c('O15554', 'P14679', 'P20020')
X %>%
  select(tissue_type, all_of(side_effect_targets)) %>%
  rio::export('TPHP_normal_sideEffect_check_20231113.xlsx')
intersect(side_effect_targets, protinfo_tisen$UniprotID)

```


#### unfiltered enriched proteins statcompare specificity
```{r}
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')

# read normal tissue median matrix
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
pm2$anatomical_classification %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

# read tissue enriched and group enriched proteins
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')



# enriched proteins convert uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# only tissue enriched proteins
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)
identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# ------ compapre with previous datasets -----
# create new comparison table
df_source <- readxl::read_excel('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/CELL_2020_TS2.xlsx', sheet = 'H comparison to other studies')
colnames(df_source) <- df_source[2, ]
df_source <- df_source[-c(1:2), ]

# ensemble to uniprotid
swiss<-readxl::read_xlsx("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/cell_ensembel_swissprot_20210713.xlsx")
sum(duplicated(swiss$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`)) #24
sum(duplicated(swiss$Entry)) #0
colnames(swiss)[1]<-"ensembl_id"
df_compare <- df_source %>% left_join(swiss, by = 'ensembl_id')

# rename GTEX data
df_compare %<>% rename(`GTEX_enriched tissue` = `Our_enriched tissue`,
                      GTEX_enrichment_category = 'Our_enrichment_category',
                      UniprotID = Entry)

# seperate duplicated ensembleID
# dup<-swiss[duplicated(swiss$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`),]
# swiss_uni<-swiss[!duplicated(swiss$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`),]
# rownames(swiss_uni)<-swiss_uni$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`
# rownames(dup)<-dup$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`
# 
# 
# 
# cell_df<-as.data.frame(cbind(gene_id,cell_pm1))
# cell_com<-merge(swiss[,c("gene_id","Entry")],cell_df,by="gene_id")
# 
# 
# 
# df_compare <- rio::import("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/20210623_DATABASE_enriched_proteins_compare.xlsx")
# df_compare %>% select(ensembl_id:`GTEX_enriched tissue`)

# # uniprot to symbol
# prot_query <- clusterProfiler::bitr(colnames(df_tisen_organ)[-1], fromType = "UNIPROT", toType = "ENSEMBL", OrgDb = "org.Hs.eg.db", drop = T)
# prot_query %<>% setNames(c("UniprotID", "ensembl_id"))

# merge PHU tissue enriched data with others
# df_compare_new <- prot_query %>%
#   left_join(protinfo_tisen %>% select(-symbol), by = "UniprotID") %>%
#   left_join(df_compare, by = "ensembl_id")


# rename PHU data
protinfo_tisen %<>% rename(PHU_Enriched_Tissue = tissue_type,
                          PHU_enrichment_category = Classification)
df_compare_new <- df_compare %>% right_join(protinfo_tisen, by = 'UniprotID')


# read tissue name mapping table and create pseudo hash table
df_tissue_map <- rio::import('PHU_Wang_GTEX_tissue_map.xlsx')
ht_wang2phu <- ht_gtex2phu <- df_tissue_map$PHU
names(ht_wang2phu) <- df_tissue_map$Wang
names(ht_gtex2phu) <- df_tissue_map$GTEX


# check wheather matched proteins were tissue enriched
df_compare_new$`D.Wang el. al._mapped` <- apply(df_compare_new, 1, function(x){
  tissues <- str_split(x['D.Wang el. al._Enriched_Tissue'], '; ')[[1]] %>% .[!is.na(.)]
  # tissues_chr <- ht_wang2phu[tissues] %>% str_c(collapse = '; ')
  h[[str_to_lower(x['PHU_Enriched_Tissue'])]] %in% ht_wang2phu[str_to_sentence(tissues)]
})

df_compare_new$HPA_mapped <- apply(df_compare_new, 1, function(x){
  tissues <- str_split(x['D.Wang el. al._Enriched_Tissue'], '; ')[[1]] %>% .[!is.na(.)]
  # tissues_chr <- ht_wang2phu[tissues] %>% str_c(collapse = '; ')
  h[[str_to_lower(x['PHU_Enriched_Tissue'])]] %in% ht_wang2phu[str_to_sentence(tissues)]
})

df_compare_new$GTEX_mapped <- apply(df_compare_new, 1, function(x){
  tissues <- str_split(x['GTEX_enriched tissue'], '; ')[[1]] %>% .[!is.na(.)]
  h[[str_to_lower(x['PHU_Enriched_Tissue'])]] %in% ht_gtex2phu[tissues]
})

# df_compare_new$HPA_mapped <- apply(df_compare_new, 1, function(x){
#   tissues <- str_split(x['TPHP_HPA_tissue_type'], ';')[[1]] %>% .[!is.na(.)]
#   h[[str_to_lower(x['tissue_type'])]] %in% sapply(tissues, function(e) h[[str_to_lower(e)]])
# })


# check wheather enriched tissues were matched
# #at least map one tissue
# df_compare_new1 <- df_compare_new %>% filter(`D.Wang el. al._mapped` | GTEX_mapped | HPA_mapped)

df_compare_new1 <- df_compare_new
df_compare_new1$Wang <- ifelse(df_compare_new1$`D.Wang el. al._mapped`, df_compare_new1$`D.Wang el. al_enrichment_category`, NA)
df_compare_new1$HPA <- apply(df_compare_new1, 1, function(x){
  tissues <- str_split(x['D.Wang el. al._Enriched_Tissue'], '; ')[[1]] %>% .[!is.na(.)]
  categories <- str_split(x['HPA_iH_Level'], '; ')[[1]] %>% .[!is.na(.)]
  mapped <- x['HPA_mapped']
  if(all(c('Duodenum', 'Small intestine') %in% tissues)){ # Small intestine covers Duodenum
    tissues <- tissues[tissues != 'Duodenum']
    categories <- categories[tissues != 'Duodenum']
    ret <- unique(categories[which(h[[str_to_lower(x['PHU_Enriched_Tissue'])]] == sapply(tissues, function(e) ht_wang2phu[e]))])
  }
  if(mapped){
    ret <- unique(categories[which(h[[str_to_lower(x['PHU_Enriched_Tissue'])]] == sapply(tissues, function(e) ht_wang2phu[e]))])
  } else{
    ret <- NA
  }
  return(ret)
})
df_compare_new1$GTEX <- ifelse(df_compare_new1$GTEX_mapped, df_compare_new1$GTEX_enrichment_category, NA)
df_compare_new1$HPA_mapped[which(df_compare_new1$HPA %in% c('-', 'Not detected'))] <- F
df_compare_new1$HPA[which(df_compare_new1$HPA %in% c('-', 'Not detected'))] <- NA
df_compare_new1 %<>% mutate(PHU_enrichment_category = str_to_sentence(PHU_enrichment_category)) %>%
  select(UniprotID, symbol, PHU_Enriched_Tissue:GTEX, everything())
rio::export(df_compare_new1, 'PUH_tissue_enriched_proteins_1629_compare_202311113.xlsx')



```


#### unfiltered enriched proteins statdruggable
```{r}
# set order
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')

pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]
organs_ordered %<>% rev() # for mapping to barplot

# start
df_drug <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/drug/drugbank_results_all_20230207.csv')
# df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')

# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})
pm2$anatomical_classification %<>% 
  sapply(function(x) {
    x %>%
      str_split('_') %>%
      .[[1]] %>%
      sapply(function(e){
        ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
      }) %>%
      str_c(collapse = '_')
  })

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched druggable proteins
prot_druggable <- df_drug$`Target uniprot` %>% str_split('; ') %>% unlist() %>% unique() %>% sort() %>% .[. != '']

protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  filter(UniprotID %in% all_of(prot_druggable)) %>% # druggable 
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)
# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


x <- sapply(protinfo_tisen$UniprotID, function(prot){# drugs (id) for each protein
  df_drug %>% filter(str_detect(`Target uniprot`, prot)) %>% pull(`DrugBank ID`) %>% sort() %>% str_c(collapse = ';')
})

df_drug %>%
  filter(str_detect(`Target uniprot`, str_c(prot_druggable, collapse = '|'))) %>% # 8179   26
  rio::export('TPHP_normal_Ulhen_tissue_enriched_druggable_8179drugs_20231113.csv')

protinfo_tisen %>%
  mutate(Drugs = x) %>%
  rio::export('TPHP_normal_Ulhen_tissue_enriched_druggable_356protein_20231113.csv')






# stat
df_drug <- rio::import('TPHP_normal_Ulhen_tissue_enriched_druggable_8179drugs_20231113.csv')
protinfo_tisen <- rio::import('TPHP_normal_Ulhen_tissue_enriched_druggable_356protein_20231113.csv')
length(protinfo_tisen$UniprotID) # 356
length(unique(protinfo_tisen$UniprotID)) # 356

# colnames(protinfo_tisen)
# [1] "tissue_type"    "UniprotID"      "Classification" "symbol"         "Drugs"  
drug_stat <- plyr::ddply(protinfo_tisen, 'UniprotID', function(dfsub){
  drugs <- unique(str_split(dfsub$Drugs, ';')[[1]])
  df_tmp <- df_drug %>% filter(`DrugBank ID` %in% drugs)
  status <- df_tmp %>%
    select(Approved:Investigational) %>%
    apply(1, function(arow){
      names(arow[arow]) %>% sort() %>% str_c(collapse = ';')
    })
  
  actions <- df_tmp %>% pull(`Target actions`)
  data.frame(DrugName = drugs,
             DrugStatus = status,
             DrugActions = actions)
})

dfbar_status <- plyr::ddply(drug_stat, 'UniprotID', function(dfsub){
  dfret <- dfsub %>%
    select(DrugStatus) %>%
    separate_rows(DrugStatus) %>%
    filter(DrugStatus != '') %>%
    count(DrugStatus)
  if(nrow(dfret) == 0){
    dfret <- data.frame(DrugStatus = 'NA',
                        n = 1)
  }
  return(dfret)
})
dfbar_status$UniprotID %<>% factor(., levels = rev(protinfo_tisen$UniprotID), ordered = T)
dfbar_status$DrugStatus %<>% factor(., levels = rev(c('Approved', 'Investigational', 'Experimental', 'Illicit')), ordered = T)
length(unique(dfbar_status$DrugStatus)) # 4 kinds of drug actions



dfbar_actions <- plyr::ddply(drug_stat, 'UniprotID', function(dfsub){
  dfret <- dfsub %>%
    select(DrugActions) %>%
    separate_rows(DrugActions, sep = '; ') %>%
    filter(DrugActions != '') %>%
    count(DrugActions)
  if(nrow(dfret) == 0){
    dfret <- data.frame(DrugActions = 'NA',
                        n = 1)
  }
  return(dfret)
})
dfbar_actions$UniprotID %<>% factor(., levels = rev(protinfo_tisen$UniprotID), ordered = T)
dfbar_actions$DrugActions[dfbar_actions$DrugActions != 'NA'] %<>% str_to_sentence()
dfbar_actions$DrugActions %<>% factor(., levels = rev(c(setdiff(sort(dfbar_actions$DrugActions), 'NA'), 'NA')), ordered = T)
length(unique(dfbar_actions$DrugActions)) # 54 kinds of drug actions

length(unique(dfbar_status$UniprotID)) # 356
length(unique(dfbar_actions$UniprotID)) # 356


drug_stat %>% rio::export('TPHP_normal_Ulhen_tissue_enriched_druggable_356protein_druginfo_20231113.csv')
dfbar_status %>% rio::export('TPHP_normal_Ulhen_tissue_enriched_druggable_356protein_drugstatus_20231113.csv')
dfbar_actions %>% rio::export('TPHP_normal_Ulhen_tissue_enriched_druggable_356protein_drugactions_20231113.csv')
```




### ===cluster -- tissue enriched proteins===
```{r}
# set colors
require(RColorBrewer)
require(dendextend)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
set.seed(10)
label_colors <- sample(col_vector, 50)


pm_heat_cor <- cor(pm_heat, method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor)
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
pm_heat_dend <- as.dendrogram(pm_heat_tree) # create dendrogram object
plot(pm_heat_dend, horiz = T#, leaflab = "none"
     )


par(mar=c(1,1,1,7))
pm_heat_dend %>%
  # set("labels_cex", 0.45) %>%
  set("labels_col", value = label_colors, k=10) %>%
  # set("branches_k_color", value = c("skyblue", "orange", "grey"), k = 3) %>%
  plot(horiz=TRUE, axes=FALSE)
# abline(v = 350, lty = 2)

```


### cluster -- all proteins
```{r}
require(dendextend)
# # set colors
# require(RColorBrewer)
# qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
# col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
# set.seed(10)
# label_colors <- sample(col_vector, 50)


pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
# get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
pm_heat_dend <- as.dendrogram(pm_heat_tree) # create dendrogram object

k10 <- cutree(pm_heat_dend, k = c(5, 10, 20))


pdf('TPHP_normal_tissue_cluster_20231113.pdf', width = 3, height = 20)
set.seed(1)
my_colors <- sample(colorspace::rainbow_hcl(10, c = 70, l  = 50))
pm_heat_dend %>%
  # set("labels_cex", 0.45) %>%
  # set("labels_col", value = my_colors, k=10) %>%
  set("branches_k_color", value = my_colors, k = 10) %>%
  plot(horiz = T, axes = T, xlab = "1-Spearman's rho")
# abline(v = 350, lty = 2)
# colored_bars(cbind(k10[,ncol(k10):1], colorspace::rainbow_hcl(51, c = 70, l  = 50)), pm_heat_dend, rowLabels = c(paste0("k = ", rev(c(5, 10, 20))), "Sample type"), horiz = T)
graphics.off()




write.csv(pm_heat_cor, 'TPHP_normal_tissue_cluster_20231113_spearmanRho.csv', quote = F)

```


### numbers and aundamce ratio by clustering order
```{r}
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]

# ---------  DIA identification generation ---------
### directly from classification result
X <- rio::import('20231113TPHP_51tissue_ulhen_classification.xlsx')
Y <- X %>%
  pivot_longer(-tissue_type, names_to = 'prot', values_to = 'class') %>%
  plyr::ddply(c('tissue_type', 'class'), function(dfsub){
    df_ret <- dfsub %>% slice(1) %>% select(tissue_type, class)
    df_ret$n <- nrow(dfsub)
    return(df_ret)
  }) %>%
  setNames(c('Sample type', 'Protein specificity', 'protein_number'))

# only in c('tissue enriched', 'group enriched', 'tissue enhanced')
Y %<>% filter(`Protein specificity` %in% c('tissue enriched', 'group enriched', 'tissue enhanced'))


# get abbreviation of sample types, if possible
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
df_DIA <- get_abbr(Y, 'Sample type', df_abbr = df_abbr)
df_DIA$`Protein specificity` %<>% str_to_sentence()

# remove 'not detected'
df_DIA %<>% filter(`Protein specificity` != 'Not detected')
df_DIA$`Protein specificity` %<>%
  factor(levels = rev(c('Tissue enriched', 'Group enriched', 'Tissue enhanced', 'Mixed', 'Expressed in all tissues')), ordered = T)
df_DIA$`Sample type` %<>% factor(levels = rev(organs_ordered), ordered = T)
df_DIA %<>% arrange(`Sample type`, `Protein specificity`)


# ----------------- Reading DDA data ----------------
DDA_protein <- '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/TPHP_DDA_protein_identification_matrix_20231113.tsv'
df <- read.delim(DDA_protein, stringsAsFactors = F, check.names = F, )

ncol(df) - 1 # number of sample types == 58
# Calculate the number of tissues expressing this protein
df['N_present'] <- apply(df[, -1], 1, function(e){ return(sum(e == 'True')) })

eval(parse(text = stringr::str_c("N <- c(", c("1", "2:7", "8:20", "21:51", "52:57", "58"), ");",
                                 "subdf <- df[df$N_present %in% N, ];",
                                 "present_", c("1", "2_7", "8_20", "21_51", "52_57", "58"), " <- apply(subdf[, -c(1, which(colnames(subdf) == 'N_present'))], 2, function(e){ return(sum(e == 'True')) });")))


present_comb <- data.frame(sample_type = names(present_1), present_1, present_2_7, present_8_20, present_21_51, present_52_57, present_58)
colnames(present_comb) <- c('Sample type', 'Detected in one sample type', 'Detected in 2-7 sample types', 'Detected in 8-20 sample types', 'Detected in 21-51 sample types', 'Detected in 52-57 sample types', 'Detected in all 58 sample types')
df_DDA <- reshape2::melt(present_comb, id = 'Sample type', variable.name = 'Protein specificity', value.name = 'protein_number')
# get abbreviation of sample types, if possible
df_DDA <- get_abbr(df_DDA, 'Sample type', df_abbr = df_abbr)
df_DDA %>% count(`Sample type`) # fluidlib


# --------- Visualization ---------------
pacman::p_load('ggpubr', 'RColorBrewer', 'ggsci')
# function
draw_F2A_barplot <- function(df, char_title, vec_color){
  df$protein_number <- df$protein_number / 1000
  p <- ggplot(df, aes(x=`Sample type`, y=`protein_number`, fill = `Protein specificity`)) + geom_bar(stat="identity", width=0.9, position="stack")
  
  p <- p +
    scale_fill_manual(values = vec_color)+
    labs(
      y = "Protein number (1000)",
      title = char_title
    )+
    guides(fill=guide_legend(nrow = 2))+
    theme(panel.grid = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.text = element_text(size = 12,color = "black"),
          axis.line = element_line(colour = "black"),
          axis.line.x = element_blank(),
          plot.subtitle = element_text(size = 30, hjust = 0, color="black")
    )+
    theme(legend.text = element_text(size = 15, color = "black"),legend.position = 'bottom',
          legend.title = element_text(size = 18, color="black"),)+
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(size = 12, vjust = 0,color = "black", angle = 90),
          axis.ticks.x = element_blank()
    )+
    theme(axis.title.y = element_text(size = 15, hjust = 0.5, color="black", angle = 90),
          axis.text.y = element_text(size = 12,color = "black", angle = 0),
          axis.ticks.y = element_blank()
    )
  return(p)
}
# parameters
ls_color <- list(c(214, 133, 122),
                 c(248, 176, 91),
                 c(240, 228, 66),
                 c(96, 217, 125),
                 c(94, 151, 181),
                 c(129, 117, 153))
vec_color <- hex_col(ls = ls_color)
my_colors <- c("#FC8D62", "#E5C494", "#984EA3")
# rev(c('Tissue enriched', 'Group enriched', 'Tissue enhanced', 'Mixed', 'Expressed in all tissues'))
# c("#A6D854", "#CCCCCC", "#FC8D62", "#E5C494", "#984EA3")
p1 <- draw_F2A_barplot(df_DDA, 'DDA qualification', vec_color)
p2 <- draw_F2A_barplot(df_DIA, 'DIA qualification', my_colors)
p <- ggarrange(p1, p2,
               ncol = 1, nrow = 2,
               labels = c("A","B"),
               font.label = list(size = 14, face = "bold"))

# output
stringr::str_c('TPHP_DDA_specific_DIA_qualification_', as.character(Sys.Date()), '.pdf') %>%
  ggsave(p, width = 20, height = 9)




# --------------------------
# abundance ratio
all<-readxl::read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/20220719_rm_randomNA_normal.xlsx")
info<-readxl::read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/1_202207TPHP_1781file_info_edited_v4.xlsx")
dim(info)
head(colnames(all),n=35) #1:15 for sample annotation
table(all$tissue_type)
ai<-inner_join(info,all[,c(1,16:ncol(all))],by = "FileName" )
rownames(ai)<-ai$FileName
head(colnames(ai),n=20)
table(ai$anatomical_classification) #55
tissue<-unique(ai$anatomical_classification)
npm<-apply(ai[,-c(1:18)], c(1,2),as.numeric)
imp<-min(npm,na.rm = T)+log2(0.5)
tissue_list<-list()
dotlist<-list()
boxlist<-list()
for (i in 1:length(tissue)){
  # i=1
  t1<-2^npm[which(ai$anatomical_classification==tissue[i]),]
  t2<-t1[,apply(t1, 2, function(v) sum(is.na(v))/nrow(t1)<0.5)]
  # dim(t2)
  t2[is.na(t2)]<-2^imp
  t3<-apply(t2,2, summary)
  tissue_list[[i]]<-as.data.frame(t2)
  boxlist[[i]]<-as.data.frame(t3)
  su<-sum(t2)
  t4<-data.frame(sum=apply(t2, 2, sum))
  t4$per<-log10(t4$sum/su)
  t4$rank<-rank(-t4$sum)
  dotlist[[i]]<-as.data.frame(t4)
}
names(tissue_list)=names(dotlist)=names(boxlist)<-tissue

ulhen<-readxl::read_xlsx("20231113TPHP_51tissue_ulhen_classification.xlsx")
ra<-list()
for (i in 1:nrow(ulhen)){
  # i=1
  t<-ulhen$tissue_type[i]
  dp<-dotlist[[t]]
  dp<-dp[order(dp$rank,decreasing = F),]
  dp$pert<-cumsum(10^(dp$per))
  en<-t(ulhen[which(ulhen$tissue_type==t),rownames(dp)])
  ex  <- en=="tissue enriched"
  ea<- en=="Expressed in all tissues"
  eh<-en=="tissue enhanced"
  mx<-en=="mixed"
  ge<-en=="group enriched"
  nt<-en=="not detected"
  ra[[i]]<-c(sum(10^dp$per[ex]),sum(10^dp$per[ea]),sum(10^dp$per[eh]),sum(10^dp$per[mx]),sum(10^dp$per[ge]),sum(10^dp$per[nt]))
}

per_tab<-do.call(rbind,ra)
colnames(per_tab)<-c("tissue enriched","Expressed in all tissues","tissue enhanced","mixed","group enriched","not detected")
rownames(per_tab)<-ulhen$tissue_type



df <- per_tab %>% as.data.frame() %>% rownames_to_column('organ')
colnames(df)[colnames(df) == 'not detected'] <- 'not detected in over half of the samples'
colnames(df) %<>% str_to_sentence()


# get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
df[, 1] <- sapply(df[, 1], function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))
df[, -1] <- df[, -1] * 100 # for percentage

df_longer <- df %>% pivot_longer(-Organ, names_to = 'Classification', values_to = 'Percentage')
df_longer$Classification %<>% str_to_sentence()
df_longer$Classification %<>% factor(levels = rev(c('Tissue enriched', 'Group enriched', 'Tissue enhanced', 'Mixed', 'Not detected in over half of the samples', 'Expressed in all tissues')), ordered = T)
df_longer$Organ %<>% factor(levels = rev(organs_ordered), ordered = T)


RColorBrewer::brewer.pal(length(fct_unique(df_longer$Classification)), 'Set2')
my_colors <- c("#008AA922", "#A6D854", "#CCCCCC", "#FC8D62", "#E5C494", "#984EA3")

p <- ggplot(df_longer, aes(x=Organ, y=Percentage, fill = Classification)) +
  geom_bar(stat="identity", width=0.9, position="stack")
p <- p +
  scale_fill_manual(values = my_colors)+
  labs(
    y = "Aundance %",
  )+
  guides(fill=guide_legend(nrow = 2))+
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text = element_text(size = 12,color = "black"),
        axis.line = element_line(colour = "black"),
        axis.line.x = element_blank(),
        plot.subtitle = element_text(size = 30, hjust = 0, color="black")
  )+
  theme(legend.text = element_text(size = 15, color = "black"),legend.position = 'bottom',
        legend.title = element_text(size = 18, color="black"),)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, vjust = 0.5,color = "black", angle = 90),
        axis.ticks.x = element_blank()
  )+
  theme(axis.title.y = element_text(size = 15, hjust = 0.5, color="black", angle = 90),
        axis.text.y = element_text(size = 12,color = "black", angle = 0),
        axis.ticks.y = element_blank()
  )
ggsave('TPHP_tissue_classification_abundance_percentage_20231113.pdf', p, width = 20, height = 4.5)







```



### top5 druggable enriched proteins
```{r}
# set order
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]
organs_ordered %<>% rev() # for mapping to barplot

# start
df_drug <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/drug/drugbank_results_all_20230207.csv')
# df_drug %<>% separate_rows(`Target uniprot`) %>% filter(`Target uniprot` != '') # separate uniprot id to rows
# df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')

# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})
pm2$anatomical_classification %<>% 
  sapply(function(x) {
    x %>%
      str_split('_') %>%
      .[[1]] %>%
      sapply(function(e){
        ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
      }) %>%
      str_c(collapse = '_')
  })

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched druggable proteins
prot_druggable <- df_drug$`Target uniprot` %>% str_split('; ') %>% unlist() %>% unique() %>% sort() %>% .[. != '']

protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  filter(UniprotID %in% all_of(prot_druggable)) %>% # druggable 
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)
# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# top5 proteins
rm(list = str_subset(ls(), 'enrich_top'))
enrich_top5_ls <- plyr::dlply(protinfo_tisen, 'tissue_type', function(dfsub){
  # dfsub <- protinfo_tisen %>% filter(tissue_type == 'ADG')
  pm <- df_tisen_organ %>% select(all_of(dfsub$UniprotID))
  med1_over_med2 <- apply(pm, 2, function(acol) { # calculate median_1st / median_2nd
    acol_sorted <- sort(acol, decreasing = T)
    return(acol_sorted[1] / acol_sorted[2])
  })
  enrich_top5 <- sort(med1_over_med2, decreasing = T) %>% head(5) %>% names() # top5
  return(enrich_top5)
})


# top X tissue enriched druggable proteins
prot_druggable <- unlist(enrich_top5_ls) # top5
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  filter(UniprotID %in% all_of(prot_druggable)) %>% # druggable 
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)
# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# keepna
pm <- df_tisen_organ %>% select(-1)
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$anatomical_classification

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-1]
row.tissue <- protinfo_tisen$tissue_type

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue=row.tissue,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen_organ$anatomical_classification),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
  tissue=tissue_color,row.tissue=tissue_color)

# plot
dim(pm_heat)
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=6,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_tissue_enriched_druggable_top5_heatmap_scale_136protein_51organs_20231113.pdf",width=6,height=12)


### side effect check
side_effect_targets <- c('O15554', 'P14679', 'P20020')
# X %>%
#   select(tissue_type, all_of(side_effect_targets))
# intersect(side_effect_targets, protinfo_tisen$UniprotID)

```



#### top5 druggable enriched proteins with > 3 drugs
```{r}
df_drug <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/drug/drugbank_results_all_20230207.csv')
df_drug %<>% separate_rows(`Target uniprot`) %>% filter(`Target uniprot` != '') # separate uniprot id to rows
length(prot_druggable) # 136 top5 enriched proteins

df_top5_drug <- df_drug %>% filter(str_detect(`Target uniprot`, str_c(prot_druggable, collapse = '|')))
dim(df_top5_drug) # 1609 drugs

df_top5_drug_long <- df_top5_drug %>%
  select(`DrugBank ID`:`Withdrawn`, `Target uniprot`) %>%
  separate_rows(`Target uniprot`, sep = '; ') %>%
  filter(`Target uniprot` != '')

df_top5_drug_target <- plyr::ddply(df_top5_drug_long, '`Target uniprot`', function(dfsub){
  data.frame(`Target uniprot` = dfsub$`Target uniprot`[1],
             Drugs = str_c(dfsub$Name, collapse = '; '),
             DrugNumber = length(unique(dfsub$Name)),
             check.names = F)
})
df_top5_prot <- df_top5_drug_target %>% filter(`Target uniprot` %in% prot_druggable)
df_top5_prot %>% filter(`Target uniprot` == 'O15554') # 9 drugs for KCNN4

df_top5_prot_over3drug <- df_top5_prot %>% filter(DrugNumber > 3)
df_top5_prot_over3drug %<>% rev()

df_top5_prot_over3drug %>% select(DrugNumber)


# --------- heatmap ------------
prot_druggable <- df_top5_prot_over3drug$`Target uniprot` # top5
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  filter(UniprotID %in% all_of(prot_druggable)) %>% # druggable 
  dplyr::mutate(tissue_type = factor(tissue_type, levels = organs_ordered, ordered = T)) %>%
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  dplyr::mutate(anatomical_classification = factor(anatomical_classification, levels = organs_ordered, ordered = T)) %>%
  arrange(anatomical_classification)
# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# keepna
pm <- df_tisen_organ %>% select(-1)
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$anatomical_classification

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-1]
row.tissue <- protinfo_tisen$tissue_type

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue=row.tissue,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen_organ$anatomical_classification),
                      row.names = names(pm_heat))

# set colors
# require(RColorBrewer)
# qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
# col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
# 
# set.seed(10)
# tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
# names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
df_color <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/input/PUH_tissue_colorset_20230210.xlsx')
tissue_color <- str_c('#', df_color$color[1:51])
names(tissue_color) <- df_color$tissue[1:51]
tissue_color <- tissue_color[organs_ordered]

ann_colors <- list(#cancer=cancer_color,
  tissue=tissue_color,row.tissue=tissue_color)

# plot
dim(pm_heat)
x <- cumsum(table(ann_row$row.tissue))[-length(cumsum(table(ann_row$row.tissue)))]
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = x[!duplicated(x)],
                        fontsize_row=6,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_tissue_top5_enriched_over3_drugs_druggable_heatmap_scale_53protein_51organs_2023113.pdf",width=8,height=8)

abbr2entire <- df_abbr$Entire %>% str_replace_all('_', ' ') %>% str_to_sentence()
names(abbr2entire) <- df_abbr$Abbr
b <- pheatmap::pheatmap(pm_heat %>% setNames(unname(abbr2entire[colnames(pm_heat)])),
                        color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]),
                        fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col %>% set_rownames(unname(abbr2entire[as.character(ann_col$tissue)])),
                        annotation_row = ann_row,
                        #gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = x[!duplicated(x)],
                        fontsize_row=6,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = T,
                        angle_col = 45,
                        filename = "TPHP_normal_Ulhen_tissue_top5_enriched_over3_drugs_druggable_heatmap_scale_53protein_51organs_colbar_20231113.pdf",width=8,height=8)



# drug numbers for each protein
df_drugnum <- df_top5_prot_over3drug %>% select(`Target uniprot`, DrugNumber) %>%
  mutate(`Target uniprot` = factor(`Target uniprot`, levels = rev(prot), ordered = T)) %>%
  arrange(`Target uniprot`)

gap_row <- x[!duplicated(x)]
tmp <- ann_row %>% set_rownames(str_remove(rownames(.), '_.+$')) %>% 
  rownames_to_column('Target uniprot')
for(i in seq_along(gap_row)){
  tmp %<>% add_row(`Target uniprot` = str_c('NA', i), .after = gap_row[i])
  gap_row <- gap_row + 1
}
df_drugnum <- tmp %>% slice(nrow(tmp):1) %>% full_join(df_drugnum)
df_drugnum$`Target uniprot` %<>% factor(., levels = .)

fivenum(log10(df_drugnum$DrugNumber)) # 0.6020600 0.6989700 0.9542425 1.2787536 2.4800069

p <- ggplot(df_drugnum) + 
  geom_tile(aes(1, `Target uniprot`, fill= log10(DrugNumber)), color = 'black') +
  geom_text(aes(1, `Target uniprot`, label = ifelse(DrugNumber > 0, DrugNumber, NA)), size = 5, color = 'black') +
  scale_fill_gradient(limits = c(floor(min(log10(df_drugnum$DrugNumber))), ceiling(max(log10(df_drugnum$DrugNumber)))),
                      # breaks,
                      low="white", high="#FAA449") +
  labs(
    x = '',
    y = 'Protein'
  )+
  scale_x_discrete(expand = c(0, 0))+
  # coord_cartesian(xlim = c(0, length(unique(df_n_long$Organ))) * 1.05,
  #                 ylim = c(0, length(unique(df_n_long$`Target uniprot`)) * 1.3))+
  #theme_bw()+
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text = element_text(size = 12,color = 'black'),
        axis.line = element_line(color = 'black'),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        plot.subtitle = element_text(size = 30, hjust = 0, color = 'black')
  )+
  theme(strip.text.x = element_text(size = 10, colour = "black"),
        legend.text = element_text(size = 12, color = 'black'), legend.position = 'right',
        legend.title = element_text(size = 15, color = 'black'))+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, vjust = 0.5 ,color = 'black', angle = 90),
        # axis.text.x = element_blank(),
        axis.ticks.x = element_blank()
  )+
  theme(axis.title.y = element_text(size = 12, hjust = 0.5, color = 'black', angle = 90),
        axis.text.y = element_text(size = 10,color = 'black', angle = 0),
        axis.ticks.y = element_blank()
  )
ggsave('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/TPHP_normal_Ulhen_tissue_top5_enriched_over3_drugs_drggable_number_20231113.pdf', p, width = 3.5, height = 10)



# ------ number and ratio -----
df_compare <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/20210623_DATABASE_enriched_proteins_compare.xlsx')
df_compare %>% select(ensembl_id:`GTEX_enriched tissue`)

# uniprot to symbol
prot_query <- clusterProfiler::bitr(colnames(df_tisen_organ)[-1], fromType = "UNIPROT", toType = "ENSEMBL", OrgDb = "org.Hs.eg.db", drop = T)
prot_query %<>% setNames(c('UniprotID', 'ensembl_id'))
df_compare_new <- prot_query %>%
  left_join(protinfo_tisen %>% select(-symbol), by = 'UniprotID') %>% # use 444 proteins
  left_join(df_compare, by = 'ensembl_id')
rio::export(df_compare_new, '20210623_DATABASE_enriched_proteins_compare_update_20231113.xlsx')
df_compare_new %>% count(UniprotID) %>% filter(n > 1)

# edit by manual
df_compare_new <- rio::import('20210623_DATABASE_enriched_proteins_compare_update_20231113_edit0.xlsx')
df_compare_new %<>% filter(UniprotID %in% colnames(df_tisen_organ)) %>%
  select(-contains('TPHP_')) %>% distinct() # 
df_compare_new %<>%
  dplyr::mutate(UniprotID = factor(UniprotID, levels = colnames(df_tisen_organ)[-1], ordered = T)) %>%
  arrange(UniprotID) %>%
  dplyr::mutate(UniprotID = as.character(UniprotID))
setequal(colnames(df_tisen_organ)[-1], df_compare_new$UniprotID) # TRUE
identical(colnames(df_tisen_organ)[-1], df_compare_new$UniprotID) # TRUE

df_lbl <- data.frame(Wang = df_compare_new$`D.Wang el. al_enrichment_category`,
                     GTex = df_compare_new$GTEX_enrichment_category,
                     HPA = df_compare_new$HPA) %>%
  add_column(`Target uniprot` = df_compare_new$UniprotID,
             x = factor(df_compare_new$UniprotID, levels = rev(unique(df_compare_new$UniprotID)), ordered = T),
             y = 1,
             .before = 1)
df_lbl$Wang[-which(df_compare_new$`D.Wang el. al._mapped`)] <- NA
df_lbl$GTex[-which(df_compare_new$GTEX_mapped)] <- NA
df_lbl[is.na(df_lbl)] <- 'NA'
# df_wang <- df_lbl %>% select(x, y, Wang)
# df_gtex <- df_lbl %>% select(x, y, GTex)
# df_hpa <- df_lbl %>% select(x, y, HPA)
df_lbl <- df_drugnum %>% slice(nrow(df_drugnum):1) %>% 
  full_join(df_lbl)
df_lbl$x <- df_lbl$`Target uniprot`
df_lbl$x %<>% factor(., levels = rev(.))

p1 <- ggplot(df_lbl) +
  aes(x = x, y = y, fill = Wang) +
  geom_point(shape = 21, size = 5) +
  scale_fill_manual(values = c('Tissue enriched' = '#984EA3', 'Group enriched' = '#E5C494', 'NA' = 'white')) +
  coord_flip() +
  theme_void() +
  theme(axis.title.y = element_text(size = 12, hjust = 0.5, color = 'black', angle = 90),
          axis.text.y = element_text(size = 10, color = 'black', angle = 0),
          axis.ticks.y = element_blank()
  )

p2 <- ggplot(df_lbl) +
  aes(x = x, y = y, fill = GTex) +
  geom_point(shape = 21, size = 5) +
  scale_fill_manual(values = c('prt_specific' = '#C17768', 'prt_enriched_not_spec' = '#D6C990', 'NA' = 'white', 'High' = '#416F88', 'Medium' = '#34796D')) +
  coord_flip() +
  theme_void() +
  theme(axis.title.y = element_text(size = 12, hjust = 0.5, color = 'black', angle = 90),
          axis.text.y = element_text(size = 10, color = 'black', angle = 0),
          axis.ticks.y = element_blank()
  )

p3 <- ggplot(df_lbl) +
  aes(x = x, y = y, fill = HPA) +
  geom_point(shape = 21, size = 5) +
  scale_fill_manual(values = c('prt_specific' = '#C17768', 'prt_enriched_not_spec' = '#D6C990', 'NA' = 'white', 'High' = '#416F88', 'Medium' = '#55BC6D')) +
  coord_flip() +
  theme_void() +
  theme(axis.title.y = element_text(size = 12, hjust = 0.5, color = 'black', angle = 90),
          axis.text.y = element_text(size = 10, color = 'black', angle = 0),
          axis.ticks.y = element_blank()
  )

p <- ggpubr::ggarrange(p1, p2, p3, nrow = 1)
ggsave('TPHP_normal_Ulhen_tissue_top5_enriched_over3_drugs_druggable_compare_20231113.pdf', p, width = 10, height = 10)



# df_top5_prot_over3drug_stat
df_top5_prot_over3drug_stat <- plyr::ddply(df_top5_prot_over3drug, '`Target uniprot`', function(dfsub){
  drugs <- unique(str_split(dfsub$Drugs, '; ')[[1]])
  df_tmp <- df_top5_drug %>%
    filter(Name %in% drugs, `Target uniprot` == dfsub$`Target uniprot`[1]) %>% 
    distinct()
  
  status <- df_tmp %>%
    select(Approved:Investigational) %>%
    apply(1, function(arow){
      names(arow[arow]) %>% sort() %>% str_c(collapse = ';')
    })

  actions <- df_tmp %>% pull(`Target actions`)
  data.frame(DrugName = drugs,
             DrugStatus = status,
             DrugActions = actions)
})
# rm(dfsub, drugs, df_tmp, df_ret)
# df_top5_prot_over3drug_stat %>% count(DrugStatus)
# df_top5_prot_over3drug_stat %>% count(DrugActions)
# rio::export(df_top5_prot_over3drug_stat, 'df_top5_prot_over3drug_stat.xlsx')


dfbar_status <- plyr::ddply(df_top5_prot_over3drug_stat, '`Target uniprot`', function(dfsub){
  dfret <- dfsub %>%
    select(DrugStatus) %>%
    separate_rows(DrugStatus) %>%
    filter(DrugStatus != '') %>%
    count(DrugStatus)
  return(dfret)
})
dfbar_status$`Target uniprot` %<>% factor(., levels = rev(protinfo_tisen$UniprotID), ordered = T)
dfbar_status$DrugStatus %<>% factor(., levels = rev(c('Approved', 'Investigational', 'Experimental', 'Illicit')), ordered = T)
length(unique(dfbar_status$DrugStatus)) # 4 kinds of drug actions

dfbar_actions <- plyr::ddply(df_top5_prot_over3drug_stat, '`Target uniprot`', function(dfsub){
  dfret <- dfsub %>%
    select(DrugActions) %>%
    separate_rows(DrugActions, sep = '; ') %>%
    filter(DrugActions != '') %>%
    count(DrugActions)
  if(nrow(dfret) == 0){
    dfret <- data.frame(DrugActions = 'NA',
                        n = 1)
  }
  return(dfret)
})
dfbar_actions$`Target uniprot` %<>% factor(., levels = rev(protinfo_tisen$UniprotID), ordered = T)
dfbar_actions$DrugActions[dfbar_actions$DrugActions != 'NA'] %<>% str_to_sentence()
dfbar_actions$DrugActions %<>% factor(., levels = rev(c(setdiff(sort(dfbar_actions$DrugActions), 'NA'), 'NA')), ordered = T)
length(unique(dfbar_actions$DrugActions)) # 45 kinds of drug actions

length(unique(dfbar_status$`Target uniprot`))
length(unique(dfbar_actions$`Target uniprot`))


dfbar_status$`Target uniprot` %<>% as.character()
dfbar_status <- df_drugnum %>% slice(nrow(df_drugnum):1) %>% 
  full_join(dfbar_status)
dfbar_status$`Target uniprot` %<>% factor(., levels = rev(unique(.)))

p1 <- ggplot() +
  geom_bar(data = dfbar_status, aes(x = `Target uniprot`, y = n, fill = DrugStatus, group = DrugStatus), position="fill", stat="identity") +
  geom_text(data = df_top5_prot_over3drug_stat %>% count(`Target uniprot`, name = 'DrugNumber'),
            aes(x = `Target uniprot`, y = 1.01, label = DrugNumber),
            color = "black", size = 3, angle = 0, hjust = 0) + 
  labs(y = 'Ratio') +
  scale_fill_brewer(palette = "PuBu", direction = 1) +
  coord_flip() +
  theme_minimal() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank())
  

action_colors <- str_c('#', df_color$color)[1:length(levels(dfbar_actions$DrugActions))]
names(action_colors) <- levels(dfbar_actions$DrugActions)
action_colors['NA'] <- '#DDDDDD'

# p2 <- ggplot() +
#   geom_bar(data = dfbar_actions, aes(x = `Target uniprot`, y = n, fill = DrugActions, group = DrugActions), position="fill", stat="identity") +
#   labs(y = 'Ratio') +
#   scale_fill_manual(values = action_colors) +
#   coord_flip() +
#   theme_minimal() +
#   theme(panel.background = element_blank(),
#         panel.grid = element_blank())
# 
# ggsave('TPHP_normal_Ulhen_tissue_top5_enriched_over3_drugs_druggable_status_20231113.pdf', p1, width = 3, height = 10)






#60%targets>10%actions  percent > 10%count > 0.6*length(prot_druggable) 
length(prot_druggable) # 53
dfbar_actions_percent <- plyr::ddply(df_top5_prot_over3drug_stat, '`Target uniprot`', function(dfsub){
  dfret <- dfsub %>%
    select(DrugActions) %>%
    separate_rows(DrugActions, sep = '; ') %>%
    filter(DrugActions != '') %>%
    count(DrugActions)
  dfret$n <- dfret$n / sum(dfret$n)
  if(nrow(dfret) == 0){
    dfret <- data.frame(DrugActions = 'NA',
                        n = 1)
  }
  return(dfret)
})


dfbar_actions_percent %>%
  filter(n > 0.1) %>%
  count(DrugActions) %>%
  filter(n > 0.6*length(prot_druggable) )
#   DrugActions  n
# 1   inhibitor 45
# 2   substrate 45

drug_action_selected <- dfbar_actions_percent %>%
  filter(n > 0.1) %>%
  count(DrugActions) %>%
  arrange(desc(n)) %>%
  slice(1:12) %>%
  pull(DrugActions)

length(drug_action_selected) # 12
drug_action_selected %<>% str_to_sentence()


dfbar_actions_select1 <- dfbar_actions %>% filter(DrugActions %in% drug_action_selected)
dfbar_actions_select2 <- dfbar_actions %>% filter(!(DrugActions %in% drug_action_selected))
dfbar_actions_select2$DrugActions <- 'Others'
dfbar_actions_select <- rbind(dfbar_actions_select1, dfbar_actions_select2)
dfbar_actions_select$DrugActions %<>% factor(., levels = c(drug_action_selected, 'Others'), ordered = T)

action_colors <- str_c('#', df_color$color)[1:length(levels(dfbar_actions_select$DrugActions))]
names(action_colors) <- levels(dfbar_actions_select$DrugActions)
# action_colors['NA'] <- '#DDDDDD'


dfbar_actions_select$`Target uniprot` %<>% as.character()
dfbar_actions_select <- df_drugnum %>% slice(nrow(df_drugnum):1) %>% 
  full_join(dfbar_actions_select)
dfbar_actions_select$`Target uniprot` %<>% factor(., levels = rev(unique(.)))

p3 <- ggplot() +
  geom_bar(data = dfbar_actions_select, aes(x = `Target uniprot`, y = n, fill = DrugActions, group = DrugActions), position="fill", stat="identity") +
  labs(y = 'Ratio') +
  scale_fill_manual(values = action_colors) +
  coord_flip() +
  theme_minimal() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank())
ggsave('TPHP_normal_Ulhen_tissue_top5_enriched_over3_drugs_druggable_actions12_20231113.pdf', p3, width = 4, height = 10)

p <- ggpubr::ggarrange(p1, p3, nrow = 1)
ggsave('TPHP_normal_Ulhen_tissue_top5_enriched_over3_drugs_druggable_status_actions12_20231113.pdf', p, width = 8, height = 10)





dfbar_actions$`Target uniprot` %<>% as.character()
dfbar_actions <- df_drugnum %>% slice(nrow(df_drugnum):1) %>% 
  full_join(dfbar_actions)
dfbar_actions$`Target uniprot` %<>% factor(., levels = rev(unique(.)))
p2 <- ggplot() +
    geom_bar(data = dfbar_actions, aes(x = `Target uniprot`, y = n, fill = DrugActions, group = DrugActions), position="fill", stat="identity") +
    labs(y = 'Ratio') +
    scale_fill_manual(values = action_colors) +
    coord_flip() +
    theme_minimal() +
    theme(panel.background = element_blank(),
          panel.grid = element_blank())
ggsave('TPHP_normal_Ulhen_tissue_top5_enriched_over3_drugs_druggable_actions_20231113.pdf', p2, width = 10, height = 10)


```





##====AdaTiSS====
```{r}
source('//172.16.13.114/share/members/yuel/1project/1ref/figure/F2A/R/R/AdaTiSS_fn.R')

rem <- pm1 %>%
  as.data.frame() %>%
  add_column(
  FileName = df0$FileName,
  tissue_name = df0$tissue_name,
  anatomical_location = df0$anatomical_location,
  anatomical_classification = df0$anatomical_classification,
  .before = 1)



rownames(pm1) <- rem$FileName
pm1 %<>% t()
prot_all_missed <- apply(pm1, 1, function(xrow){
  length(unique(xrow)) == 1
})
pm1 <- pm1[!(rownames(pm1) %in% names(prot_all_missed[prot_all_missed])), ]
rem %<>% select(-names(prot_all_missed[prot_all_missed]))

typeof(pm1) # double
adatiss <- AdaTiSS(as.matrix(pm1))
ts<-as.data.frame(adatiss$ada.s)
pi<-as.data.frame(adatiss$pop.fit.mx)
write.csv(ts,"20221222_adatiss_normal_zscore.csv")
write.csv(pi,"20221222_adatiss_normal_pi0hat.csv")

df_na<-aggregate(rem, by=list(rem$anatomical_classification),function(v){
  sum(is.na(v))/length(v)})
rownames(df_na)<-df_na$Group.1

ts_median<-aggregate(t(ts), by=list(rem$anatomical_classification),FUN=function(v){
  median(v,na.rm = T)
})
rownames(ts_median)<-ts_median$Group.1
ts_median_num<-apply(ts_median[,-1], c(1,2), as.numeric)


#remove proteins of NA ts_score in all tissue types(HIGH MISSING)
ts_na<-apply(ts_median_num, 2, function(v){
  sum(is.na(v))/nrow(ts_median_num)
})
if (length(which(ts_na==1))!=0){
  ts_median_num2<-ts_median_num[,-which(ts_na==1)]
  df_na2<-df_na[,-which(ts_na==1)]
} else {ts_median_num2<-ts_median_num
df_na2<-df_na
}
ts_median_num2[is.na(ts_median_num2)]=-50
#select enriched proteins
#1.median(TS) >4 while in other tissue median(TS) <=2.5
pre1<-apply(ts_median_num2, 2, function(v){
  t=which.max(v)
  if (v[t]>4 & max(v[-t],na.rm = T)<=2.5) {rownames(ts_median_num2)[t]}
})
pre2<-unlist(pre1)
# pre3<-pre2[!is.null(pre2)]
pro.list1<-names(pre2)

# 2.<50% NA in the chosen tissue type
pro.list2<-list()
n=0
for (i in 1:length(pre2)){
  # i=1
  t<-pre2[i]
  p<-pro.list1[i]
  na<-df_na2[t,p]
  ts<-ts_median_num2[t,p]
  if (na<0.5){
    n=n+1
    pro.list2[[n]]<-c(t,p,na,ts)}
}
en<-do.call(rbind,pro.list2)
colnames(en)<-c("anatomical_classification","protein","intra-tissue missing","ts_score")
dim(en) # 595   4
# View(en)
write.csv(en,"20221222TPHP_ADATISS_595_enriched.csv")






#select top 3
table(en[,1])
require(org.Hs.eg.db)
en1 <- en %>%
  as.data.frame() %>%
  dplyr::group_by(anatomical_classification) %>%
  dplyr::arrange(desc(ts_score), .by_group = T) %>%
  dplyr::slice(1:3) %>%
  dplyr::ungroup()

uni_entr <- clusterProfiler::bitr(en1$protein,fromType = "UNIPROT",toType = "ENTREZID",OrgDb = "org.Hs.eg.db",drop = T)
uni_entr$`gene name` <- toTable(org.Hs.egSYMBOL[uni_entr$ENTREZID])$symbol
uni_entr %<>% dplyr::rename(protein = UNIPROT) %>% dplyr::select(protein, `gene name`)
dup_prots <- uni_entr$protein[base::duplicated(uni_entr$protein)]
uni_entr1 <- uni_entr[!(uni_entr$protein %in% dup_prots), ]
uni_entr2 <- uni_entr[uni_entr$protein %in% dup_prots, ]
uni_entr2 %<>%
  dplyr::group_by(protein) %>%
  dplyr::summarise(`gene name` = stringr::str_c(`gene name`, collapse = ';'))
uni_entr <- rbind(uni_entr1, uni_entr2)

en1 <- dplyr::full_join(en1, uni_entr, by = 'protein')
write.csv(en1,"20221222TPHP_ADATISS_111_enriched_edit.csv")

#select top 6 out of nail platelet urine , 186 proteins left
en1<-read.csv("20221222TPHP_ADATISS_111_enriched_edit.csv",check.names = F)
com1<-do.call(rbind,lapply(unique(en1$anatomical_classification), function(v){rem[grep(v,rem$anatomical_classification),]}))
com2<-com1[,en1$protein]
com3<-as.data.frame(cbind(com1[,c(1:16)],com2))
library(dplyr)
com4<-com3 %>%dplyr::arrange(anatomical_classification, anatomical_location, tissue_name)
writexl::write_xlsx(com4,"20221222_adatiss_specific_123_protein_matrix.xlsx")

```



```{r}
dfada1 <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/20221222TPHP_ADATISS_595_enriched.csv')
dfada2 <- rio::import('//172.16.13.114/share/members/jiangwenhao/TPHP/202200720/normal_classification/20220731TPHP_ADATISS_534_enriched.csv')


setdiff(dfada1$protein, dfada2$protein)
setdiff(dfada2$protein, dfada1$protein)
'O15554' %in% dfada1$protein
'O15554' %in% dfada2$protein
'P20020' %in% dfada2$protein
'P20020' %in% dfada1$protein


```



# 1_table.combine tables
## sheet1 -- All tissue enriched proteins
```{r}
# set order
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')

pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]
organs_ordered %<>% rev() # for mapping to barplot

# read matrix
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')

# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})
pm2$anatomical_classification %<>% 
  sapply(function(x) {
    x %>%
      str_split('_') %>%
      .[[1]] %>%
      sapply(function(e){
        ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
      }) %>%
      str_c(collapse = '_')
  })

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched proteins
# protinfo_tisen <- protinfo %>%
#   filter(Classification == 'tissue enriched') %>%
#   arrange(tissue_type)
# 
# df_tisen_organ <- pm2 %>%
#   select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
#   arrange(anatomical_classification)
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  dplyr::mutate(tissue_type = factor(tissue_type, levels = organs_ordered, ordered = T)) %>%
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  dplyr::mutate(anatomical_classification = factor(anatomical_classification, levels = organs_ordered, ordered = T)) %>%
  arrange(anatomical_classification)

# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# keepna
pm <- df_tisen_organ %>% select(-1)
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$anatomical_classification

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-1]
row.tissue <- protinfo_tisen$tissue_type

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue=row.tissue,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen_organ$anatomical_classification),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
  tissue=tissue_color,row.tissue=tissue_color)

# plot
dim(pm_heat)

sheet1 <- pm_heat %>% rownames_to_column('Tissue enriched protein') # All tissue enriched proteins


```

## sheet2 -- All tissue enriched proteins comparison dataset
```{r}
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')

# read normal tissue median matrix
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
pm2$anatomical_classification %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

# read tissue enriched and group enriched proteins
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')



# enriched proteins convert uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# only tissue enriched proteins
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)
# protinfo_tisen <- protinfo %>%
#   filter(Classification == 'tissue enriched') %>% # tissue enriched
#   dplyr::mutate(tissue_type = factor(tissue_type, levels = organs_ordered, ordered = T)) %>%
#   arrange(tissue_type) %>%
#   dplyr::mutate(tissue_type = as.character(tissue_type))
# 
# df_tisen_organ <- pm2 %>%
#   select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
#   dplyr::mutate(anatomical_classification = factor(anatomical_classification, levels = organs_ordered, ordered = T)) %>%
#   arrange(anatomical_classification) %>%
#   dplyr::mutate(anatomical_classification = as.character(anatomical_classification))
identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# ------ compapre with previous datasets -----
# create new comparison table
df_source <- readxl::read_excel('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/CELL_2020_TS2.xlsx', sheet = 'H comparison to other studies')
colnames(df_source) <- df_source[2, ]
df_source <- df_source[-c(1:2), ]

# ensemble to uniprotid
swiss<-readxl::read_xlsx("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/cell_ensembel_swissprot_20210713.xlsx")
sum(duplicated(swiss$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`)) #24
sum(duplicated(swiss$Entry)) #0
colnames(swiss)[1]<-"ensembl_id"
df_compare <- df_source %>% left_join(swiss, by = 'ensembl_id')

# rename GTEX data
df_compare %<>% rename(`GTEX_enriched tissue` = `Our_enriched tissue`,
                       GTEX_enrichment_category = 'Our_enrichment_category',
                       UniprotID = Entry)

# seperate duplicated ensembleID
# dup<-swiss[duplicated(swiss$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`),]
# swiss_uni<-swiss[!duplicated(swiss$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`),]
# rownames(swiss_uni)<-swiss_uni$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`
# rownames(dup)<-dup$`yourlist:M202107125BF3C56A578D7D6DFD1FC81EE5DA77300C6321S`
# 
# 
# 
# cell_df<-as.data.frame(cbind(gene_id,cell_pm1))
# cell_com<-merge(swiss[,c("gene_id","Entry")],cell_df,by="gene_id")
# 
# 
# 
# df_compare <- rio::import("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/20210623_DATABASE_enriched_proteins_compare.xlsx")
# df_compare %>% select(ensembl_id:`GTEX_enriched tissue`)

# # uniprot to symbol
# prot_query <- clusterProfiler::bitr(colnames(df_tisen_organ)[-1], fromType = "UNIPROT", toType = "ENSEMBL", OrgDb = "org.Hs.eg.db", drop = T)
# prot_query %<>% setNames(c("UniprotID", "ensembl_id"))

# merge PHU tissue enriched data with others
# df_compare_new <- prot_query %>%
#   left_join(protinfo_tisen %>% select(-symbol), by = "UniprotID") %>%
#   left_join(df_compare, by = "ensembl_id")


# rename PHU data
protinfo_tisen %<>% rename(PHU_Enriched_Tissue = tissue_type,
                           PHU_enrichment_category = Classification)
df_compare_new <- df_compare %>% right_join(protinfo_tisen, by = 'UniprotID')


# read tissue name mapping table and create pseudo hash table
df_tissue_map <- rio::import('PHU_Wang_GTEX_tissue_map.xlsx')
ht_wang2phu <- ht_gtex2phu <- df_tissue_map$PHU
names(ht_wang2phu) <- df_tissue_map$Wang
names(ht_gtex2phu) <- df_tissue_map$GTEX


# check wheather matched proteins were tissue enriched
df_compare_new$`D.Wang el. al._mapped` <- apply(df_compare_new, 1, function(x){
  tissues <- str_split(x['D.Wang el. al._Enriched_Tissue'], '; ')[[1]] %>% .[!is.na(.)]
  # tissues_chr <- ht_wang2phu[tissues] %>% str_c(collapse = '; ')
  h[[str_to_lower(x['PHU_Enriched_Tissue'])]] %in% ht_wang2phu[str_to_sentence(tissues)]
})

df_compare_new$HPA_mapped <- apply(df_compare_new, 1, function(x){
  tissues <- str_split(x['D.Wang el. al._Enriched_Tissue'], '; ')[[1]] %>% .[!is.na(.)]
  # tissues_chr <- ht_wang2phu[tissues] %>% str_c(collapse = '; ')
  h[[str_to_lower(x['PHU_Enriched_Tissue'])]] %in% ht_wang2phu[str_to_sentence(tissues)]
})

df_compare_new$GTEX_mapped <- apply(df_compare_new, 1, function(x){
  tissues <- str_split(x['GTEX_enriched tissue'], '; ')[[1]] %>% .[!is.na(.)]
  h[[str_to_lower(x['PHU_Enriched_Tissue'])]] %in% ht_gtex2phu[tissues]
})

# df_compare_new$HPA_mapped <- apply(df_compare_new, 1, function(x){
#   tissues <- str_split(x['TPHP_HPA_tissue_type'], ';')[[1]] %>% .[!is.na(.)]
#   h[[str_to_lower(x['tissue_type'])]] %in% sapply(tissues, function(e) h[[str_to_lower(e)]])
# })


# check wheather enriched tissues were matched
# #at least map one tissue
# df_compare_new1 <- df_compare_new %>% filter(`D.Wang el. al._mapped` | GTEX_mapped | HPA_mapped)

df_compare_new1 <- df_compare_new
df_compare_new1$Wang <- ifelse(df_compare_new1$`D.Wang el. al._mapped`, df_compare_new1$`D.Wang el. al_enrichment_category`, NA)
df_compare_new1$HPA <- apply(df_compare_new1, 1, function(x){
  tissues <- str_split(x['D.Wang el. al._Enriched_Tissue'], '; ')[[1]] %>% .[!is.na(.)]
  categories <- str_split(x['HPA_iH_Level'], '; ')[[1]] %>% .[!is.na(.)]
  mapped <- x['HPA_mapped']
  if(all(c('Duodenum', 'Small intestine') %in% tissues)){ # Small intestine covers Duodenum
    tissues <- tissues[tissues != 'Duodenum']
    categories <- categories[tissues != 'Duodenum']
    ret <- unique(categories[which(h[[str_to_lower(x['PHU_Enriched_Tissue'])]] == sapply(tissues, function(e) ht_wang2phu[e]))])
  }
  if(mapped){
    ret <- unique(categories[which(h[[str_to_lower(x['PHU_Enriched_Tissue'])]] == sapply(tissues, function(e) ht_wang2phu[e]))])
  } else{
    ret <- NA
  }
  return(ret)
})
df_compare_new1$GTEX <- ifelse(df_compare_new1$GTEX_mapped, df_compare_new1$GTEX_enrichment_category, NA)
df_compare_new1$HPA_mapped[which(df_compare_new1$HPA %in% c('-', 'Not detected'))] <- F
df_compare_new1$HPA[which(df_compare_new1$HPA %in% c('-', 'Not detected'))] <- NA
df_compare_new1 %<>% mutate(PHU_enrichment_category = str_to_sentence(PHU_enrichment_category)) %>%
  select(UniprotID, symbol, PHU_Enriched_Tissue:GTEX, everything())
df_compare_new1$PHU_Enriched_Tissue %<>% sapply(function(e) h[[str_to_lower(e)]])

prot_ordered <- sapply(sheet1$`Tissue enriched protein`, function(e) str_split(e, '_')[[1]] %>% head(1))
rownames(df_compare_new1) <- df_compare_new1$UniprotID
df_compare_new1 <- df_compare_new1[prot_ordered, ]
sheet2 <- df_compare_new1 # All tissue enriched proteins comparison dataset

```


## sheet3-5 -- drug informations
```{r}
# set order
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')

pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]
organs_ordered %<>% rev() # for mapping to barplot

# start
df_drug <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/drug/drugbank_results_all_20230207.csv')
# df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')

# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})
pm2$anatomical_classification %<>% 
  sapply(function(x) {
    x %>%
      str_split('_') %>%
      .[[1]] %>%
      sapply(function(e){
        ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
      }) %>%
      str_c(collapse = '_')
  })

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched druggable proteins
prot_druggable <- df_drug$`Target uniprot` %>% str_split('; ') %>% unlist() %>% unique() %>% sort() %>% .[. != '']

# protinfo_tisen <- protinfo %>%
#   filter(Classification == 'tissue enriched') %>% # tissue enriched
#   filter(UniprotID %in% all_of(prot_druggable)) %>% # druggable 
#   arrange(tissue_type)
# 
# df_tisen_organ <- pm2 %>%
#   select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
#   arrange(anatomical_classification)
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  filter(UniprotID %in% all_of(prot_druggable)) %>% # druggable 
  dplyr::mutate(tissue_type = factor(tissue_type, levels = organs_ordered, ordered = T)) %>%
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  dplyr::mutate(anatomical_classification = factor(anatomical_classification, levels = organs_ordered, ordered = T)) %>%
  arrange(anatomical_classification)
# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


x <- sapply(protinfo_tisen$UniprotID, function(prot){# drugs (id) for each protein
  df_drug %>% filter(str_detect(`Target uniprot`, prot)) %>% pull(`DrugBank ID`) %>% sort() %>% str_c(collapse = ';')
})


# stat
df_drug <- rio::import('TPHP_normal_Ulhen_tissue_enriched_druggable_8179drugs_20231113.csv')
protinfo_tisen <- rio::import('TPHP_normal_Ulhen_tissue_enriched_druggable_356protein_20231113.csv')
length(protinfo_tisen$UniprotID) # 356
length(unique(protinfo_tisen$UniprotID)) # 356

# colnames(protinfo_tisen)
# [1] "tissue_type"    "UniprotID"      "Classification" "symbol"         "Drugs"  
drug_stat <- plyr::ddply(protinfo_tisen, 'UniprotID', function(dfsub){
  drugs <- unique(str_split(dfsub$Drugs, ';')[[1]])
  df_tmp <- df_drug %>% filter(`DrugBank ID` %in% drugs)
  status <- df_tmp %>%
    select(Approved:Investigational) %>%
    apply(1, function(arow){
      names(arow[arow]) %>% sort() %>% str_c(collapse = ';')
    })
  
  actions <- df_tmp %>% pull(`Target actions`)
  data.frame(DrugName = drugs,
             DrugStatus = status,
             DrugActions = actions)
})

dfbar_status <- plyr::ddply(drug_stat, 'UniprotID', function(dfsub){
  dfret <- dfsub %>%
    select(DrugStatus) %>%
    separate_rows(DrugStatus) %>%
    filter(DrugStatus != '') %>%
    count(DrugStatus)
  if(nrow(dfret) == 0){
    dfret <- data.frame(DrugStatus = 'NA',
                        n = 1)
  }
  return(dfret)
})
dfbar_status$UniprotID %<>% factor(., levels = rev(protinfo_tisen$UniprotID), ordered = T)
dfbar_status$DrugStatus %<>% factor(., levels = rev(c('Approved', 'Investigational', 'Experimental', 'Illicit')), ordered = T)
length(unique(dfbar_status$DrugStatus)) # 4 kinds of drug actions



dfbar_actions <- plyr::ddply(drug_stat, 'UniprotID', function(dfsub){
  dfret <- dfsub %>%
    select(DrugActions) %>%
    separate_rows(DrugActions, sep = '; ') %>%
    filter(DrugActions != '') %>%
    count(DrugActions)
  if(nrow(dfret) == 0){
    dfret <- data.frame(DrugActions = 'NA',
                        n = 1)
  }
  return(dfret)
})
dfbar_actions$UniprotID %<>% factor(., levels = rev(protinfo_tisen$UniprotID), ordered = T)
dfbar_actions$DrugActions[dfbar_actions$DrugActions != 'NA'] %<>% str_to_sentence()
dfbar_actions$DrugActions %<>% factor(., levels = rev(c(setdiff(sort(dfbar_actions$DrugActions), 'NA'), 'NA')), ordered = T)
length(unique(dfbar_actions$DrugActions)) # 54 kinds of drug actions

length(unique(dfbar_status$UniprotID)) # 356
length(unique(dfbar_actions$UniprotID)) # 356

sheet3 <- plyr::ddply(drug_stat, 'UniprotID', function(dfsub){
  df_ret <- dfsub[1, ]
  df_ret$DrugName <- dfsub$DrugName %>% str_c(collapse = '-')
  df_ret$DrugStatus <- ifelse(dfsub$DrugStatus != '', drug_stat$DrugActions, ' ') %>% str_c(collapse = '-')
  df_ret$DrugActions <- ifelse(dfsub$DrugActions != '', drug_stat$DrugActions, ' ') %>% str_c(collapse = '-')
  df_ret$DrugNumber <- length(dfsub$DrugName)
  return(df_ret)
}) # tissue enriched drug targets

# sheet3 <- drug_stat # All drug information
sheet4 <- dfbar_status # All drug status
sheet5 <- dfbar_actions # All drug action


```


## sheet6 -- top5 enriched 3-drug targets
```{r}
# set order
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]
organs_ordered %<>% rev() # for mapping to barplot

# start
df_drug <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/drug/drugbank_results_all_20230207.csv')
# df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_classification = 'Group.1')
tmp <- rio::import('20231113yuel_TPHP_tissue_enriched1629_group_enriched2627_4057prot.csv')

# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
  x %>%
    str_split('_') %>%
    .[[1]] %>%
    sapply(function(e){
      ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
    }) %>%
    str_c(collapse = '_')
})
pm2$anatomical_classification %<>% 
  sapply(function(x) {
    x %>%
      str_split('_') %>%
      .[[1]] %>%
      sapply(function(e){
        ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
      }) %>%
      str_c(collapse = '_')
  })

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched druggable proteins
prot_druggable <- df_drug$`Target uniprot` %>% str_split('; ') %>% unlist() %>% unique() %>% sort() %>% .[. != '']

protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  filter(UniprotID %in% all_of(prot_druggable)) %>% # druggable 
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification)
# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# top5 proteins
enrich_top5_ls <- plyr::dlply(protinfo_tisen, 'tissue_type', function(dfsub){
  # dfsub <- protinfo_tisen %>% filter(tissue_type == 'ADG')
  pm <- df_tisen_organ %>% select(all_of(dfsub$UniprotID))
  med1_over_med2 <- apply(pm, 2, function(acol) { # calculate median_1st / median_2nd
    acol_sorted <- sort(acol, decreasing = T)
    return(acol_sorted[1] / acol_sorted[2])
  })
  enrich_top5 <- sort(med1_over_med2, decreasing = T) %>% head(5) %>% names() # top5
  return(enrich_top5)
})


# top X tissue enriched druggable proteins
prot_druggable <- unlist(enrich_top5_ls) # top5
length(prot_druggable) # 132 top5 enriched proteins

df_top5_drug <- df_drug %>% filter(str_detect(`Target uniprot`, str_c(prot_druggable, collapse = '|')))
dim(df_top5_drug) # 1138 drugs

df_top5_drug_long <- df_top5_drug %>%
  select(`DrugBank ID`:`Withdrawn`, `Target uniprot`) %>%
  separate_rows(`Target uniprot`, sep = '; ') %>%
  filter(`Target uniprot` != '')

df_top5_drug_target <- plyr::ddply(df_top5_drug_long, '`Target uniprot`', function(dfsub){
  data.frame(`Target uniprot` = dfsub$`Target uniprot`[1],
             Drugs = str_c(dfsub$Name, collapse = '; '),
             DrugNumber = length(unique(dfsub$Name)),
             check.names = F)
})
df_top5_prot <- df_top5_drug_target %>% filter(`Target uniprot` %in% prot_druggable)
df_top5_prot %>% filter(`Target uniprot` == 'O15554') # 9 drugs for KCNN4

df_top5_prot_over3drug <- df_top5_prot %>% filter(DrugNumber > 3)
df_top5_prot_over3drug %<>% rev()

# top5en_prot_over3drug <- df_top5_prot_over3drug$`Target uniprot`


prot_ordered58 <- prot_ordered %>% factor(levels = df_top5_prot_over3drug$`Target uniprot`) %>% na.omit() %>% as.character()

sheet6 <- sheet1 %>%
  mutate(label = sapply(sheet1$`Tissue enriched protein`, function(e) str_split(e, '_')[[1]][1])) %>%
  column_to_rownames('label') %>%
  .[prot_ordered58, ] # Top5 enriched 3-drug targets 58


sheet7 <- sheet2 %>%
  mutate(label = UniprotID) %>%
  column_to_rownames('label') %>%
  .[prot_ordered58, ] # Targets 58 comparison dataset


# df_top5_prot_over3drug_stat
df_top5_prot_over3drug_stat <- plyr::ddply(df_top5_prot_over3drug, '`Target uniprot`', function(dfsub){
  drugs <- unique(str_split(dfsub$Drugs, '; ')[[1]])
  df_tmp <- df_top5_drug %>%
    filter(Name %in% drugs)
  
  status <- df_tmp %>%
    select(Approved:Investigational) %>%
    apply(1, function(arow){
      names(arow[arow]) %>% sort() %>% str_c(collapse = ';')
    })
  
  actions <- df_tmp %>% pull(`Target actions`)
  data.frame(DrugName = drugs,
             DrugStatus = status,
             DrugActions = actions)
})


dfbar_status <- plyr::ddply(df_top5_prot_over3drug_stat, '`Target uniprot`', function(dfsub){
  dfret <- dfsub %>%
    select(DrugStatus) %>%
    separate_rows(DrugStatus) %>%
    filter(DrugStatus != '') %>%
    count(DrugStatus)
  return(dfret)
})
dfbar_status$`Target uniprot` %<>% factor(., levels = rev(protinfo_tisen$UniprotID), ordered = T)
dfbar_status$DrugStatus %<>% factor(., levels = rev(c('Approved', 'Investigational', 'Experimental', 'Illicit')), ordered = T)
length(unique(dfbar_status$DrugStatus)) # 4 kinds of drug actions

dfbar_actions <- plyr::ddply(df_top5_prot_over3drug_stat, '`Target uniprot`', function(dfsub){
  dfret <- dfsub %>%
    select(DrugActions) %>%
    separate_rows(DrugActions, sep = '; ') %>%
    filter(DrugActions != '') %>%
    count(DrugActions)
  if(nrow(dfret) == 0){
    dfret <- data.frame(DrugActions = 'NA',
                        n = 1)
  }
  return(dfret)
})
dfbar_actions$`Target uniprot` %<>% factor(., levels = rev(protinfo_tisen$UniprotID), ordered = T)
dfbar_actions$DrugActions[dfbar_actions$DrugActions != 'NA'] %<>% str_to_sentence()
dfbar_actions$DrugActions %<>% factor(., levels = rev(c(setdiff(sort(dfbar_actions$DrugActions), 'NA'), 'NA')), ordered = T)
length(unique(dfbar_actions$DrugActions)) # 45 kinds of drug actions

length(unique(dfbar_status$`Target uniprot`)) # 58
length(unique(dfbar_actions$`Target uniprot`)) # 58

dfbar_actions_percent <- plyr::ddply(df_top5_prot_over3drug_stat, '`Target uniprot`', function(dfsub){
  dfret <- dfsub %>%
    select(DrugActions) %>%
    separate_rows(DrugActions, sep = '; ') %>%
    filter(DrugActions != '') %>%
    count(DrugActions)
  dfret$n <- dfret$n / sum(dfret$n)
  if(nrow(dfret) == 0){
    dfret <- data.frame(DrugActions = 'NA',
                        n = 1)
  }
  return(dfret)
})


dfbar_actions_percent %>%
  filter(n > 0.1) %>%
  count(DrugActions) %>%
  filter(n > 0.6*length(prot_druggable) )
#   DrugActions  n
# 1   inhibitor 49
# 2   substrate 49

drug_action_selected <- dfbar_actions_percent %>%
  filter(n > 0.1) %>%
  count(DrugActions) %>%
  arrange(desc(n)) %>%
  slice(1:12) %>%
  pull(DrugActions)

length(drug_action_selected) # 12
drug_action_selected %<>% str_to_sentence()



dfbar_actions_select1 <- dfbar_actions %>% filter(DrugActions %in% drug_action_selected)
dfbar_actions_select2 <- dfbar_actions %>% filter(!(DrugActions %in% drug_action_selected))
dfbar_actions_select2$DrugActions <- 'Others'
dfbar_actions_select <- rbind(dfbar_actions_select1, dfbar_actions_select2)
dfbar_actions_select$DrugActions %<>% factor(., levels = c(drug_action_selected, 'Others'), ordered = T)


sheet8 <- sheet3 %>%
  mutate(label = UniprotID) %>%
  column_to_rownames('label') %>%
  .[prot_ordered58, ] # Targets 58 drug

dfbar_status %<>% mutate(`Target uniprot` = factor(`Target uniprot`, levels = prot_ordered58, ordered = T))
dfbar_status %>%
  group_by(`Target uniprot`) %>%
  summarise(Percent = n/sum(n)) %>%
  left_join(dfbar_status, .)


dfbar_status$`Target uniprot` %<>% factor(levels = prot_ordered58, ordered = T)
sheet9 <- plyr::ddply(dfbar_status, '`Target uniprot`', function(dfsub){
  dfsub$Percent <- dfsub$n / sum(dfsub$n)
  return(dfsub)
}) # Targets 58 drug status


dfbar_actions_select$`Target uniprot` %<>% factor(levels = prot_ordered58, ordered = T)
sheet10 <- plyr::ddply(dfbar_actions_select, '`Target uniprot`', function(dfsub){
  dfsub$Percent <- dfsub$n / sum(dfsub$n)
  return(dfsub)
}) # Targets 58 drug action


```



## output
```{r}
list(
  'All tissue enriched proteins' = sheet1,
  'All comparison dataset' = sheet2,
  'Tissue enriched drug' = sheet3,
  'All drug status' = sheet4,
  'All drug action' = sheet5,
  'Top5 enriched 3-drug targets 58' = sheet6,
  'Targets 58 comparison dataset' = sheet7,
  'Targets 58 drug' = sheet8,
  'Targets 58 drug status' = sheet9,
  'Targets 58 drug action' = sheet10
) %>% rio::export('PHU_figure3_table_20231113.xlsx')

```



# 2.Unsupervised clustering
## read matrix
```{r}
source("//172.16.13.136/share/members/jiangwenhao/code/myQC.R")

df_info <- readxl::read_excel('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/matrix/202207TPHP_1781file_info_edited_v4.xlsx')

# df<-readxl::read_excel('//172.16.13.136/share/members/yuel/sample_info/20220719_rm_randomNA_normal.xlsx',
#                        col_types = c(rep('guess', 16), rep('numeric', 12391)), na = '')
# dim(df)
# colnames(df) %>% head
# colnames(df) %>% tail
# colnames(df)[1:16]
df0 <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/TPHP_normalData_for_classification_20231113.xlsx')
dim(df0) # 496 12410
colnames(df0) %>% head
colnames(df0) %>% tail
colnames(df0)[1:19]


pm <- df0 %>% dplyr::select(FileName, 19:12410)
df1 <- df_info %>% inner_join(pm, by = 'FileName') %>% arrange(anatomical_classification, anatomical_location, tissue_name)
dim(df1) # 497 12410
colnames(df1)[1:19]


# 
df1 %>% count(anatomical_classification) %>% arrange(n)
df1 %>% count(anatomical_classification) %>% arrange(n) %>% View
df2 <- df1 %>% dplyr::select(FileName, tissue_name, anatomical_location, anatomical_classification, 19:12410)
dim(df2) # 497 12396
df_type <- df2 %>% dplyr::select(1:4)
pm <- df2 %>% dplyr::select(1, 5:12396) %>% column_to_rownames('FileName') %>% t() %>% as.data.frame()
nafill <- min(pm, na.rm = T) + log2(0.8) # min * 0.8
pm <- df2 %>% dplyr::select(1, 5:12396) %>% column_to_rownames('FileName') %>% t() %>% as.data.frame()
pm %<>% removeRowsAllNa()
pm_fillna <- pm
pm_fillna[is.na(pm_fillna)] <- nafill



# df_type[df_type$tissue_name == 'cerebellum', 'anatomical_classification'] <- 'cerebellum'

```



## Ulhen classification list
```{r}
df_u <- read.csv('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/20231113yuel_TPHP_enriched_proteins.csv', check.names = F)

prot_u <- unlist(df_u)[!is.na(unlist(df_u))] %>% unique
prot_unique <- sort(prot_u)
prot_unique <- intersect(prot_unique, rownames(pm_fillna))


df_select <- pm[prot_unique, ] %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column('FileName') %>%
  inner_join(df_type, ., by = 'FileName')

df_med <- df_select %>%
  dplyr::group_by(anatomical_classification) %>%
  dplyr::summarise_at(dplyr::vars(-(1:3)), median, na.rm = T) # 3 == 4 - 1

dim(df_med) # 51 4058


```


##PCA based t-SNE
### ** function **
```{r}
# Martin Sill's method
# https://github.com/mwsill/mnp_training/blob/master/R/RSpectra_pca.R
require(RSpectra)
require(Rtsne)

prcomp_svds <-
  function(x, retx = TRUE, center = TRUE, scale. = FALSE, tol = NULL, k=10, ...){
    chkDots(...)
    x <- as.matrix(x)
    x <- scale(x, center = center, scale = scale.)
    cen <- attr(x, "scaled:center")
    sc <- attr(x, "scaled:scale")
    if(any(sc == 0))
      stop("cannot rescale a constant/zero column to unit variance")
    s <- svds(x, k)
    s$d <- s$d / sqrt(max(1, nrow(x) - 1))
    if (!is.null(tol)) {
      ## we get rank at least one even for a 0 matrix.
      rank <- sum(s$d > (s$d[1L]*tol))
      if (rank < ncol(x)) {
        s$v <- s$v[, 1L:rank, drop = FALSE]
        s$d <- s$d[1L:rank]
      }
    }
    dimnames(s$v) <-
      list(colnames(x), paste0("PC", seq_len(ncol(s$v))))
    r <- list(sdev = s$d, rotation = s$v,
              center = if(is.null(cen)) FALSE else cen,
              scale = if(is.null(sc)) FALSE else sc)
    if (retx) r$x <- x %*% s$v
    class(r) <- "prcomp"
    r
  }


```

<!-- ###test -->
<!-- ```{r test} -->
<!-- df3 <- df_med %>% column_to_rownames('anatomical_classification') -->
<!-- na_ratio <- apply(df3, 2, function(col){sum(is.na(col)) / length(col)}) -->
<!-- hist(na_ratio) -->
<!-- df3[, na_ratio < 0.5] -->

<!-- df3[is.na(df3)] <- nafill -->

<!-- rowNormalization <- T -->
<!-- colNormalization <- F -->

<!-- DF <- df3 -->

<!-- if (rowNormalization) { -->
<!--   M <-data.frame(t(apply(DF, 1, function(v) { -->
<!--     (v - mean(v, na.rm = T)) / sd(v, na.rm = T) -->
<!--   }))) -->
<!--   #print('Normalization by row is done!') -->
<!-- } -->
<!-- if (colNormalization) { -->
<!--   M <- apply(DF, 2, function(v) { -->
<!--     (v - mean(v, na.rm = T)) / sd(v, na.rm = T) -->
<!--   }) -->
<!-- } -->

<!-- m1 <- prcomp(M) -->
<!-- summary(m1) -->
<!-- m1$x; # pca -->
<!-- m1$rotation # eigen$vectors -->
<!-- m1$sdev ^ 2 # eigen$values -->

<!-- plot(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2)) # 50+ -->
<!-- (cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2))[94] # NA -->
<!-- which(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2) <= 0.763) %>% max() # 30 -->
<!-- which(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2) <= 0.9) %>% max() # 40 -->
<!-- (cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2))[39] # 0.8774948 -->

<!-- ``` -->


<!-- ```{r} -->
<!-- # Martin Sill's method -->
<!-- # https://github.com/mwsill/mnp_training/blob/master/R/RSpectra_pca.R -->
<!-- require(RSpectra) -->
<!-- require(Rtsne) -->

<!-- prcomp_svds <- -->
<!--   function(x, retx = TRUE, center = TRUE, scale. = FALSE, tol = NULL, k=10, ...){ -->
<!--     chkDots(...) -->
<!--     x <- as.matrix(x) -->
<!--     x <- scale(x, center = center, scale = scale.) -->
<!--     cen <- attr(x, "scaled:center") -->
<!--     sc <- attr(x, "scaled:scale") -->
<!--     if(any(sc == 0)) -->
<!--       stop("cannot rescale a constant/zero column to unit variance") -->
<!--     s <- svds(x, k) -->
<!--     s$d <- s$d / sqrt(max(1, nrow(x) - 1)) -->
<!--     if (!is.null(tol)) { -->
<!--       ## we get rank at least one even for a 0 matrix. -->
<!--       rank <- sum(s$d > (s$d[1L]*tol)) -->
<!--       if (rank < ncol(x)) { -->
<!--         s$v <- s$v[, 1L:rank, drop = FALSE] -->
<!--         s$d <- s$d[1L:rank] -->
<!--       } -->
<!--     } -->
<!--     dimnames(s$v) <- -->
<!--       list(colnames(x), paste0("PC", seq_len(ncol(s$v)))) -->
<!--     r <- list(sdev = s$d, rotation = s$v, -->
<!--               center = if(is.null(cen)) FALSE else cen, -->
<!--               scale = if(is.null(sc)) FALSE else sc) -->
<!--     if (retx) r$x <- x %*% s$v -->
<!--     class(r) <- "prcomp" -->
<!--     r -->
<!--   } -->

<!-- y <- as.factor(colnames(df3)) -->

<!-- # calculate first 167 PCs -->
<!-- DF <- df3 -->
<!-- pca <- prcomp_svds(DF, retx = T, center = T, scale. = T, tol = NULL, k = 40) -->
<!-- View(pca$x) -->

<!-- # Notice -->
<!-- # perplexity    numeric; Perplexity parameter (should not be bigger -->
<!-- #               than 3 * perplexity < nrow(X) - 1, see details for -->
<!-- #               interpretation) -->

<!-- # calculate tSNE -->
<!-- set.seed(2020) -->
<!-- res <- Rtsne(pca$x,pca=F,max_iter=2500,theta=0,verbose=T, -->
<!--              perplexity = floor((nrow(pca$x) - 1) / 3)) -->

<!-- # scatterplot tSNE -->
<!-- plot(res$Y,pch=19,col=y) -->


<!-- # # calculate tSNE -->
<!-- # set.seed(2020) -->
<!-- # res <- Rtsne(pca$x,pca=F,max_iter=50000,theta=0,verbose=T, -->
<!-- #              perplexity = floor((nrow(pca$x) - 1) / 3)) -->
<!-- #  -->
<!-- # # scatterplot tSNE -->
<!-- # plot(res$Y,pch=19,col=y) -->
<!-- ``` -->

<!-- ### organ clustering -->
<!-- ```{r} -->
<!-- # Martin Sill's method -->
<!-- # https://github.com/mwsill/mnp_training/blob/master/R/RSpectra_pca.R -->
<!-- require(RSpectra) -->
<!-- require(Rtsne) -->

<!-- prcomp_svds <- -->
<!--   function(x, retx = TRUE, center = TRUE, scale. = FALSE, tol = NULL, k=10, ...){ -->
<!--     chkDots(...) -->
<!--     x <- as.matrix(x) -->
<!--     x <- scale(x, center = center, scale = scale.) -->
<!--     cen <- attr(x, "scaled:center") -->
<!--     sc <- attr(x, "scaled:scale") -->
<!--     if(any(sc == 0)) -->
<!--       stop("cannot rescale a constant/zero column to unit variance") -->
<!--     s <- svds(x, k) -->
<!--     s$d <- s$d / sqrt(max(1, nrow(x) - 1)) -->
<!--     if (!is.null(tol)) { -->
<!--       ## we get rank at least one even for a 0 matrix. -->
<!--       rank <- sum(s$d > (s$d[1L]*tol)) -->
<!--       if (rank < ncol(x)) { -->
<!--         s$v <- s$v[, 1L:rank, drop = FALSE] -->
<!--         s$d <- s$d[1L:rank] -->
<!--       } -->
<!--     } -->
<!--     dimnames(s$v) <- -->
<!--       list(colnames(x), paste0("PC", seq_len(ncol(s$v)))) -->
<!--     r <- list(sdev = s$d, rotation = s$v, -->
<!--               center = if(is.null(cen)) FALSE else cen, -->
<!--               scale = if(is.null(sc)) FALSE else sc) -->
<!--     if (retx) r$x <- x %*% s$v -->
<!--     class(r) <- "prcomp" -->
<!--     r -->
<!--   } -->

<!-- y <- as.factor(colnames(df3)) -->

<!-- # calculate first 167 PCs -->
<!-- # DF <- t(df3) -->
<!-- DF <- as.matrix(df3) -->
<!-- pca <- prcomp_svds(DF, retx = T, center = T, scale. = T, tol = NULL, k = 40) -->
<!-- View(pca$x) -->

<!-- # Notice -->
<!-- # perplexity    numeric; Perplexity parameter (should not be bigger -->
<!-- #               than 3 * perplexity < nrow(X) - 1, see details for -->
<!-- #               interpretation) -->


<!-- # calculate tSNE -->
<!-- set.seed(2020) -->
<!-- res <- Rtsne(pca$x,pca=F,max_iter=2500,theta=0,verbose=T, -->
<!--              perplexity = floor((nrow(pca$x) - 1) / 3)) -->

<!-- # scatterplot tSNE -->
<!-- plot(res$Y,pch=19,col=y) -->


<!-- # calculate tSNE -->
<!-- set.seed(2020) -->
<!-- res <- Rtsne(pca$x,pca=F,max_iter=50000,theta=0,verbose=T, -->
<!--              perplexity = floor((nrow(pca$x) - 1) / 3)) -->

<!-- # scatterplot tSNE -->
<!-- plot(res$Y,pch=19,col=y) -->
<!-- ``` -->


<!-- <!-- ### k=50 --> -->
<!-- <!-- ```{r} --> -->
<!-- <!-- pca <- prcomp_svds(DF, retx = T, center = T, scale. = T, tol = NULL, k = 50) --> -->
<!-- <!-- View(pca$x) --> -->

<!-- <!-- # calculate tSNE --> -->
<!-- <!-- set.seed(2020) --> -->
<!-- <!-- res <- Rtsne(pca$x,pca=F,max_iter=50000,theta=0,verbose=T, --> -->
<!-- <!--              perplexity = floor((nrow(pca$x) - 1) / 3)) --> -->

<!-- <!-- # scatterplot tSNE --> -->
<!-- <!-- plot(res$Y,pch=19,col=y) --> -->
<!-- <!-- ``` --> -->


<!-- ####t-SNE 20 clusters -->
<!-- ```{r} -->
<!-- library(ggrepel) -->

<!-- tsne <- res$Y %>% as.data.frame -->
<!-- colnames(tsne) <- c('tsne1', 'tsne2') -->
<!-- hc <- hclust(dist(tsne)) -->

<!-- info <- tsne -->
<!-- info$hclust <- factor(cutree(hc, 20)) -->
<!-- info$anatomical_classification <- rownames(DF) -->
<!-- # info %<>% left_join(df_type, by = 'anatomical_classification') -->
<!-- info %<>% mutate(hclust = str_c('Cluster ', hclust)) -->
<!-- rownames(info) <- info$anatomical_classification -->

<!-- canvasXpress::canvasXpress(data=list(y=info[, 1:2]), -->
<!--                            varAnnot=info, -->
<!--                            scatterPlotMatrix=F, -->
<!--                            title='t-SNE', -->
<!--                            colorBy ='anatomical_classification', -->
<!--                            legendColumns=1, -->
<!--                            width = 1200, -->
<!--                            height=600, -->
<!--                            roundedPolygonRadius=3) -->
<!-- rio::export(info, "TPHP_adatiss_dboverlap_tsne20220731.xlsx") -->


<!-- hc.cent <- info %>% -->
<!--   group_by(hclust) %>% -->
<!--   dplyr::select(tsne1, tsne2) %>% -->
<!--   summarize_all(mean) -->

<!-- p <- ggplot(info, aes(x = tsne1, y = tsne2, colour = hclust)) +  -->
<!--   geom_point(alpha = 0.3) +  -->
<!--   theme_bw() + -->
<!--   geom_label_repel(aes(label = hclust),  -->
<!--                    data = hc.cent) + -->
<!--   guides(colour = 'none') + -->
<!--   ggtitle("")#+ -->
<!--   # theme(legend.position = 'top', -->
<!--   #           legend.text = element_text(size = 25,color = "black"), -->
<!--   #           legend.title = element_blank() , -->
<!--   #           #legend.title = element_text(size=20,color="black") , -->
<!--   #           panel.grid.major =element_blank(), -->
<!--   #           panel.grid.minor = element_blank(), -->
<!--   #           panel.background = element_blank(), -->
<!--   #           axis.line = element_line(colour = "black"))+ -->
<!--   #     theme(panel.grid =element_blank())+ -->
<!--   #     theme(axis.text = element_text(size = 20,color = "black"))+ -->
<!--   #     theme(axis.text.x = element_text(size = 20,color = "black", angle = 0))+ -->
<!--   #     theme(plot.subtitle=element_text(size=60, hjust=0, color="black"))+ -->
<!--   #     theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+ -->
<!--   #     theme(axis.title.y=element_text(size=30, hjust=0.5, color="black")) -->

<!-- print(p) -->
<!-- ggsave("TPHP_adatiss_dboverlap_tsne20220731.pdf",p,width=8,height=8) -->


<!-- ``` -->


<!-- ####t-SNE 5 clusters -->
<!-- ```{r} -->
<!-- library(ggrepel) -->

<!-- tsne <- res$Y %>% as.data.frame -->
<!-- colnames(tsne) <- c('tsne1', 'tsne2') -->
<!-- hc <- hclust(dist(tsne)) -->

<!-- info <- tsne -->
<!-- info$hclust <- factor(cutree(hc, 5)) -->
<!-- info$anatomical_classification <- rownames(DF) -->
<!-- # info %<>% left_join(df_type, by = 'anatomical_classification') -->
<!-- info %<>% mutate(hclust = str_c('Cluster ', hclust)) -->
<!-- rownames(info) <- info$anatomical_classification -->

<!-- canvasXpress::canvasXpress(data=list(y=info[, 1:2]), -->
<!--                            varAnnot=info, -->
<!--                            scatterPlotMatrix=F, -->
<!--                            title='t-SNE', -->
<!--                            colorBy ='anatomical_classification', -->
<!--                            legendColumns=1, -->
<!--                            width = 1200, -->
<!--                            height=600, -->
<!--                            roundedPolygonRadius=3) -->
<!-- # rio::export(info, "TPHP_adatiss_dboverlap_tsne20220731.xlsx") -->


<!-- hc.cent <- info %>% -->
<!--   group_by(hclust) %>% -->
<!--   dplyr::select(tsne1, tsne2) %>% -->
<!--   summarize_all(mean) -->

<!-- p <- ggplot(info, aes(x = tsne1, y = tsne2, colour = hclust)) +  -->
<!--   geom_point(alpha = 0.3) +  -->
<!--   theme_bw() + -->
<!--   geom_label_repel(aes(label = hclust),  -->
<!--                    data = hc.cent) + -->
<!--   guides(colour = 'none') + -->
<!--   ggtitle("")#+ -->
<!--   # theme(legend.position = 'top', -->
<!--   #           legend.text = element_text(size = 25,color = "black"), -->
<!--   #           legend.title = element_blank() , -->
<!--   #           #legend.title = element_text(size=20,color="black") , -->
<!--   #           panel.grid.major =element_blank(), -->
<!--   #           panel.grid.minor = element_blank(), -->
<!--   #           panel.background = element_blank(), -->
<!--   #           axis.line = element_line(colour = "black"))+ -->
<!--   #     theme(panel.grid =element_blank())+ -->
<!--   #     theme(axis.text = element_text(size = 20,color = "black"))+ -->
<!--   #     theme(axis.text.x = element_text(size = 20,color = "black", angle = 0))+ -->
<!--   #     theme(plot.subtitle=element_text(size=60, hjust=0, color="black"))+ -->
<!--   #     theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+ -->
<!--   #     theme(axis.title.y=element_text(size=30, hjust=0.5, color="black")) -->

<!-- print(p) -->
<!-- # ggsave("TPHP_adatiss_dboverlap_tsne20220731.pdf",p,width=8,height=8) -->


<!-- ``` -->





### File clustering
```{r}
# df3 <- df_select %>% column_to_rownames('FileName') %>% select(-(1:3))
# na_ratio <- apply(df3, 2, function(col){sum(is.na(col)) / length(col)})
# hist(na_ratio)
# df3[, na_ratio < 0.5]
# 
# df3[is.na(df3)] <- nafill
# 
# rowNormalization <- T
# colNormalization <- F
# 
# DF <- df3


DF <- df2 %>% column_to_rownames('FileName') %>% dplyr::select(-(1:3))
DF[is.na(DF)] <- nafill
M <-data.frame(t(apply(DF, 1, function(v) {
  (v - mean(v, na.rm = T)) / sd(v, na.rm = T)
})))
m1 <- prcomp(M)
# summary(m1)
# m1$x; # pca
# m1$rotation # eigen$vectors
# m1$sdev ^ 2 # eigen$values

plot(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2)) # 500+
(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2))[94] # 0.696017
which(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2) <= 0.763) %>% max() # 147
which(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2) <= 0.9) %>% max() # 306
(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2))[310] # 0.902446


y <- as.factor(colnames(DF))
pca <- prcomp_svds(DF, retx = T, center = F, scale. = T, tol = NULL, k = 310)


# calculate tSNE
set.seed(2020)
res <- Rtsne(pca$x,pca=F,max_iter=2500,theta=0,verbose=T,
             perplexity = floor((nrow(pca$x) - 1) / 3))

# scatterplot tSNE
plot(res$Y,pch=19,col=y)


# # calculate tSNE (iter == 50000)
# set.seed(2020)
# res <- Rtsne(pca$x,pca=F,max_iter=50000,theta=0,verbose=T,
#              perplexity = floor((nrow(pca$x) - 1) / 3))
# # scatterplot tSNE
# plot(res$Y,pch=19,col=y)



tsne <- res$Y %>% as.data.frame
colnames(tsne) <- c('tsne1', 'tsne2')
hc <- hclust(dist(tsne))

info <- tsne
info$hclust <- factor(cutree(hc, 20))
info$FileName <- rownames(DF)
# info %<>% left_join(df_type, by = 'anatomical_classification')
info %<>% mutate(hclust = str_c('Cluster ', hclust))
info %<>% left_join(df_type, by = 'FileName')
rownames(info) <- info$FileName

canvasXpress::canvasXpress(data=list(y=info[, 1:2]),
                           varAnnot=info,
                           scatterPlotMatrix=F,
                           title='t-SNE',
                           colorBy ='anatomical_classification',
                           legendColumns=1,
                           width = 1200,
                           height=600,
                           roundedPolygonRadius=3)

hc.cent <- info %>%
  group_by(hclust) %>%
  dplyr::select(tsne1, tsne2) %>%
  summarize_all(mean)

p <- ggplot(info, aes(x = tsne1, y = tsne2, colour = hclust)) + 
  geom_point(alpha = 0.3) + 
  theme_bw() +
  ggrepel::geom_label_repel(aes(label = hclust), 
                   data = hc.cent) +
  guides(colour = 'none') +
  ggtitle("")#+
# theme(legend.position = 'top',
#           legend.text = element_text(size = 25,color = "black"),
#           legend.title = element_blank() ,
#           #legend.title = element_text(size=20,color="black") ,
#           panel.grid.major =element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#           axis.line = element_line(colour = "black"))+
#     theme(panel.grid =element_blank())+
#     theme(axis.text = element_text(size = 20,color = "black"))+
#     theme(axis.text.x = element_text(size = 20,color = "black", angle = 0))+
#     theme(plot.subtitle=element_text(size=60, hjust=0, color="black"))+
#     theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
#     theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))

print(p)
ggsave('20231113_51normal_tissue_pca_based_tsne_clustering.pdf', p, width = 10, height = 10)
info %>%
  arrange(hclust, anatomical_classification, anatomical_location, tissue_name) %>%
  rio::export('20231113_51normal_tissue_pca_based_tsne_clustering.xlsx')



# get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
info$anatomical_classification <- sapply(info$anatomical_classification, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))



# set order
pm2 <- rio::import('20231113TPHP_normal_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]

info$anatomical_classification %<>% factor(levels = organs_ordered, ordered = T)
info %<>% arrange(anatomical_classification)

# # set colors
df_color <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/input/PUH_tissue_colorset_20230210.xlsx')
tissue_color <- str_c('#', df_color$color[1:51])
names(tissue_color) <- df_color$tissue[1:51]
tissue_color <- tissue_color[organs_ordered]
tissue_color_shape <-
  data.frame(anatomical_classification = sort(unique(info$anatomical_classification)),
             color = tissue_color)
info %<>% left_join(tissue_color_shape, by = 'anatomical_classification')
# 
# p <- ggplot(info) + 
#   geom_point(aes(x = tsne1, y = tsne2, color = anatomical_classification), shape = 16) +
#   # geom_point(color='black', shape=21, size=4, aes(fill=factor(group))) +
#   # scale_fill_manual(values = tissue_color) +
#   scale_color_manual(values = tissue_color) +
#   theme_bw()
# ggsave('20231113_51normal_tissue_pca_based_tsne_clustering_custom.pdf', p, width = 10, height = 10)


my_colors <- c('#368FC6', '#55BC6D', '#D8894E', '#7C0823', '#9D7DDB', '#000000')
my_shapes <- c(1, 2, 6, 3, 4, 15, 17:19)

shape_color_pairs <- expand.grid(my_shapes, my_colors)

p <- ggplot(info) + 
  geom_point(aes(x = tsne1, y = tsne2, shape = anatomical_classification, color = anatomical_classification), size = 4)+
  scale_shape_manual(values = shape_color_pairs[, 1])+
  scale_color_manual(values = as.character(shape_color_pairs[, 2]))+
  theme_bw()
ggsave('20231113_51normal_tissue_pca_based_tsne_clustering_custom.pdf', p, width = 10, height = 10)


# patient label
info_all <- rio::import('//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_2_sample_info/202207TPHP_1781file_info_edited_v4.xlsx')
info <- info_all %>% select(FileName, patient_ID) %>% left_join(info, ., by = 'FileName')

ggplot(info) + 
  geom_point(aes(x = tsne1, y = tsne2, shape = patient_ID, color = patient_ID), size = 4)+
  scale_shape_manual(values = shape_color_pairs[, 1])+
  scale_color_manual(values = as.character(shape_color_pairs[, 2]))+
  theme_bw()




p_patient <- ggplot(info) + 
  geom_point(aes(x = tsne1, y = tsne2, color = patient_ID), size = 4, shape = 'circle')+
  scale_color_brewer(palette = 'Set3') +
  # scale_shape_manual(values = shape_color_pairs[, 1])+
  # scale_color_manual(values = unname(tissue_color))+
  theme_bw()
ggsave('20231113_51normal_tissue_pca_based_tsne_clustering_custom_patient.pdf', p_patient, width = 10, height = 10)


```

# 3.===protein specificity of nervous system===
## Ulhen's classification method
```{r}
source("//172.16.13.136/share/members/yuel/2022/codes/20231113_ulhen_class.R")

# df<-read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/20220719_rm_randomNA_normal.xlsx")
# ai<-read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/1_202207TPHP_1781file_info_edited_v4.xlsx")
# di<-inner_join(ai,df[,c(1,16:ncol(df))],by="FileName")
# table(di$patient_ID)
# df0<-di[which(di$patient_ID %in% c("1","2","3","4","7","JD-1","JD-2","JD-3","JD-4")),]
# # write_xlsx(df0,"20231113_TPHP_normal.xlsx")
# 
# 
# table(df0$patient_ID)
# table(df0$anatomical_classification)
# dim(df0) # 497 12410
# df1<-apply(df0[,-c(1:18)],c(1,2),as.numeric)
# min(df1,na.rm = T) # 9.795163
# max(df1,na.rm=T) # 24.00716
# 
# df0[,-c(1:18)] <- df1
# # rio::export(df0, 'TPHP_normalData_for_classification_20231113.xlsx')

df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
df0 %<>% filter(anatomical_classification %in% c('brain', 'nerve', 'spinal cord'))
# df0 %>% count(anatomical_location) %>% arrange(n)
rio::export(df0, 'TPHP_normalData_nervous_for_classification_20230216.xlsx')

df1<-apply(df0[,-c(1:18)],c(1,2),as.numeric)

pm1<-df1
pm1[is.na(pm1)]<-log2(2^min(pm1,na.rm = T)*0.5)
pm2<-aggregate(2^pm1,by=list(df0$anatomical_location),median)

tissue_type_clas<-list()
tissue_type_clas[[1]]<-ulhen_class(pm2[,1:50])
for (i in 2:floor(ncol(pm1)/50)){
  tissue_type_clas[[i]]<-ulhen_class(pm2[,c(1,(50*(i-1)+1):(50*i))])
  cat(paste("Processed",i*50,"/",ncol(pm1) ,sep = " "),"\n")
}
tissue_type_clas[[ceiling(ncol(pm1)/50)]]<-ulhen_class(pm2[,c(1,(50*floor(ncol(pm1)/50)+1):ncol(pm1))])
tissue_type_clas_all<-tissue_type_clas%>% reduce_right(full_join, by = "tissue_type")
library(writexl)
write_xlsx(tissue_type_clas_all,"20230216TPHP_nervous_tissue_ulhen_classification.xlsx")
tissue_type_clas_all <- rio::import('20230216TPHP_nervous_tissue_ulhen_classification.xlsx')


tissue_mean1<-tissue_type_clas_all
symbol<-colnames(tissue_mean1)[-c(1)]
#3774 enriched and group enriched proteins
mean_clas_symbol_list<-apply(tissue_mean1[,-c(1)],1, function (v){
  symbol[which(v=="tissue enriched" | v =="group enriched")]
})
length(unique(unlist(mean_clas_symbol_list))) # 3561

# library(plyr)
en_tab<-sapply(mean_clas_symbol_list,function(v){
  data.frame(t(v))
})
a<-as.data.frame(t(plyr::rbind.fill(en_tab)))
colnames(a)<-tissue_mean1$tissue_type

write.csv(a,"20230216yuel_TPHP_nervous_enriched_proteins.csv",row.names = F)



#1629 tissue enriched proteins
mean_clas_symbol_list<-apply(tissue_mean1[,-c(1)],1, function (v){
  symbol[which(v=="tissue enriched" )]
})
length(unique(unlist(mean_clas_symbol_list))) # 1222

# library(plyr)
en_tab<-sapply(mean_clas_symbol_list,function(v){
  data.frame(t(v))
})
b<-as.data.frame(t(plyr::rbind.fill(en_tab)))
colnames(b)<-tissue_mean1$tissue_type
# 
write.csv(b,"20231113yuel_TPHP_nervous_tissue_228_enriched_proteins.csv",row.names = F)


tmp <- tissue_mean1 %>%
  pivot_longer(-tissue_type, names_to = 'UniprotID', values_to = 'Classification') %>%
  filter(str_detect(Classification, 'enriched')) %>%
  arrange(desc(Classification), UniprotID, tissue_type)

length(unique(tmp$UniprotID)) # 3561
tmp %>% filter(Classification == 'tissue enriched') %>% pull(UniprotID) %>% unique() %>% length() # 1222
tmp %>% filter(Classification == 'group enriched') %>% pull(UniprotID) %>% unique() %>% length() # 2224

rio::export(tmp, '20230216yuel_TPHP_nervous_tissue_enriched1222_group_enriched2224_3561prot.csv')
rio::export(pm2, '20230216TPHP_nervous_tissue_organ_median.xlsx')
```



### enriched proteins expression heatmap (sample level)
```{r}
df0 <- rio::import('TPHP_normalData_nervous_for_classification_20230216.xlsx')
tmp <- rio::import('20230216yuel_TPHP_nervous_tissue_enriched1222_group_enriched2224_3561prot.csv')

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched proteins
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  arrange(tissue_type)

df_tisen <- df0 %>%
  select(FileName, DIA_ID, anatomical_location, anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification, anatomical_location)


X <- df_tisen %>%
  distinct(anatomical_location, anatomical_classification)
  
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  left_join(X, by = c('tissue_type' = 'anatomical_location')) %>%
  arrange(anatomical_classification, tissue_type)

df_tisen <- df0 %>%
  select(FileName, DIA_ID, anatomical_location, anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification, anatomical_location)

# keepna
pm <- df_tisen %>% select(-(1:4))
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen$FileName

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
na_pos <- is.na(pm)
na_fill <- min(pm, na.rm = T) + log2(0.1)
pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
pm.scale[na_pos] <- NA
names(pm.scale) <- df_tisen$FileName

prot <- colnames(df_tisen)[-(1:4)]
row.tissue <- protinfo_tisen$tissue_type

pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue= factor(row.tissue, levels = unique(row.tissue), ordered = T),
                      #row.location = row.location,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen$anatomical_location, levels = unique(df_tisen$anatomical_location), ordered = T), 
                      organ = factor(df_tisen$anatomical_classification, levels = unique(df_tisen$anatomical_classification), ordered = T),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
organ_color <- c('#CE9797', '#345D89', '#3C9191')
names(organ_color) <- c('nerve', 'brain', 'spinal cord')
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
  tissue=tissue_color, organ = organ_color,row.tissue=tissue_color)

# plot
dim(pm_heat)
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(ann_row$row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_Ulhen_nervous_tissue_enriched_heatmap_scale_fill_na_1222protein_134files_20230216.pdf",width=10,height=10)

```

### enriched proteins expression heatmap (organ level)
```{r}
# df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
pm2 <- rio::import('20230216TPHP_nervous_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_location = 'Group.1')
tmp <- rio::import('20230216yuel_TPHP_nervous_tissue_enriched1222_group_enriched2224_3561prot.csv')

# # map to abbreviation
# df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
# h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
# tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
#   x %>%
#     str_split('_') %>%
#     .[[1]] %>%
#     sapply(function(e){
#       ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
#     }) %>%
#     str_c(collapse = '_')
# })
# pm2$anatomical_classification %<>% 
#   sapply(function(x) {
#     x %>%
#       str_split('_') %>%
#       .[[1]] %>%
#       sapply(function(e){
#         ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
#       }) %>%
#       str_c(collapse = '_')
#   })

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched proteins
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  arrange(tissue_type)

df_tisen <- df0 %>%
  select(FileName, DIA_ID, anatomical_location, anatomical_classification, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_classification, anatomical_location)


X <- df_tisen %>%
  distinct(anatomical_location, anatomical_classification)

protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  left_join(X, by = c('tissue_type' = 'anatomical_location')) %>%
  arrange(anatomical_classification, tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_location, all_of(protinfo_tisen$UniprotID)) %>%
  mutate(anatomical_location = factor(anatomical_location, levels = unique(df_tisen$anatomical_location), ordered = T)) %>%
  arrange(anatomical_location) %>%
  right_join(X, ., by = 'anatomical_location')

# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# map to abbreviation
protinfo_tisen$anatomical_classification
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
protinfo_tisen$anatomical_classification <- sapply(protinfo_tisen$anatomical_classification, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)) %>% factor(levels = c('CE', 'SPI', 'NEV'), ordered = T)
df_tisen_organ$anatomical_classification <- sapply(df_tisen_organ$anatomical_classification, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)) %>% factor(levels = c('CE', 'SPI', 'NEV'), ordered = T)
protinfo_tisen %<>% arrange(anatomical_classification, tissue_type)
df_tisen_organ %<>% arrange(anatomical_classification, anatomical_location) %>%
  select(1:2, protinfo_tisen$UniprotID)


# keepna
pm <- df_tisen_organ %>% select(-(1:2))
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$anatomical_location

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-(1:2)]
row.tissue <- protinfo_tisen$tissue_type

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue= factor(row.tissue, levels = unique(row.tissue), ordered = T),
                      row.organ = protinfo_tisen$anatomical_classification,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen_organ$anatomical_location, levels = unique(df_tisen_organ$anatomical_location), ordered = T), 
                      organ = factor(df_tisen_organ$anatomical_classification, levels = unique(df_tisen_organ$anatomical_classification), ordered = T),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# tissue_color <- rep('#888888', length(unique(ann_col$tissue)))
# names(tissue_color) <- unique(ann_col$tissue)
# organ_color <- c('#CE9797', '#345D89', '#3C9191')
# names(organ_color) <- c('CE', 'SPI', 'NEV')
df_color <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/input/PUH_tissue_colorset_20230210.xlsx')
organ_color <- str_c('#', df_color$color[1:51])
names(organ_color) <- df_color$tissue[1:51]
organ_color <- organ_color[c('CE', 'SPI', 'NEV')]
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
  tissue=tissue_color, organ = organ_color,row.tissue=tissue_color,row.organ = organ_color)

# plot
dim(pm_heat)
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(ann_row$row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = T, 
                        filename = "TPHP_normal_Ulhen_nervous_tissue_enriched_heatmap_scale_1222protein_40organs_20231113.pdf",width=11,height=11)

b <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(ann_row$row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_nervous_tissue_enriched_heatmap_scale_1222protein_40organs_big_20231113.pdf",width=20,height=50)

```

#### top enriched proteins
```{r}
# topX proteins
rm(list = str_subset(ls(), 'enrich_top'))
topN <- 3 # top3
enrich_topN_ls <- plyr::dlply(protinfo_tisen, 'tissue_type', function(dfsub){
  # dfsub <- protinfo_tisen %>% filter(tissue_type == 'ADG')
  pm <- df_tisen_organ %>% select(all_of(dfsub$UniprotID))
  med1_over_med2 <- apply(pm, 2, function(acol) { # calculate median_1st / median_2nd
    acol_sorted <- sort(acol, decreasing = T)
    return(acol_sorted[1] / acol_sorted[2])
  })
  enrich_topN <- sort(med1_over_med2, decreasing = T) %>% head(topN) %>% names() # topN
  return(enrich_topN)
})


# top X tissue enriched proteins
prot_selected <- unlist(enrich_topN_ls) # topN




protinfo_tisen %<>% filter(UniprotID %in% prot_selected) %>%
  arrange(anatomical_classification, tissue_type)
df_tisen_organ %<>%
  select(1:2, protinfo_tisen$UniprotID)


# keepna
pm <- df_tisen_organ %>% select(-(1:2))
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$anatomical_location

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-(1:2)]
row.tissue <- protinfo_tisen$tissue_type

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue= factor(row.tissue, levels = unique(row.tissue), ordered = T),
                      row.organ = protinfo_tisen$anatomical_classification,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen_organ$anatomical_location, levels = unique(df_tisen_organ$anatomical_location), ordered = T), 
                      organ = factor(df_tisen_organ$anatomical_classification, levels = unique(df_tisen_organ$anatomical_classification), ordered = T),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# tissue_color <- rep('#888888', length(unique(ann_col$tissue)))
# names(tissue_color) <- unique(ann_col$tissue)
# organ_color <- c('#CE9797', '#345D89', '#3C9191')
# names(organ_color) <- c('CE', 'SPI', 'NEV')
df_color <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/input/PUH_tissue_colorset_20230210.xlsx')
organ_color <- str_c('#', df_color$color[1:51])
names(organ_color) <- df_color$tissue[1:51]
organ_color <- organ_color[c('CE', 'SPI', 'NEV')]
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
  tissue=tissue_color, organ = organ_color,row.tissue=tissue_color,row.organ = organ_color)

dim(pm_heat)
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(ann_row$row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=6,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_nervous_tissue_top3_enriched_heatmap_scale_109protein_40organs_20231113.pdf",width=11,height=11)

```

### === top enriched proteins -- old ===
```{r}
# set order
pm2 <- rio::import('20230216TPHP_nervous_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
# rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]
organs_ordered %<>% rev() # for mapping to barplot

# start
# df_drug <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/drug/drugbank_results_all_20230207.csv')
# df0 <- rio::import('TPHP_normalData_for_classification_20231113.xlsx')
pm2 <- rio::import('20230216TPHP_nervous_tissue_organ_median.xlsx')
pm2 %<>% rename(anatomical_location = 'Group.1')
tmp <- rio::import('20230216yuel_TPHP_nervous_tissue_enriched1222_group_enriched2224_3561prot.csv')

# # map to abbreviation
# df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
# h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
# tmp$tissue_type <- sapply(tmp$tissue_type, function(x) {
#   x %>%
#     str_split('_') %>%
#     .[[1]] %>%
#     sapply(function(e){
#       ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
#     }) %>%
#     str_c(collapse = '_')
# })
# pm2$anatomical_location %<>% 
#   sapply(function(x) {
#     x %>%
#       str_split('_') %>%
#       .[[1]] %>%
#       sapply(function(e){
#         ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
#       }) %>%
#       str_c(collapse = '_')
#   })

# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$UniprotID, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('UniprotID', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'UniprotID')

# tissue enriched proteins
# prot_selected <- df_drug$`Target uniprot` %>% str_split('; ') %>% unlist() %>% unique() %>% sort() %>% .[. != '']

protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  # filter(UniprotID %in% all_of(prot_selected)) %>% # druggable 
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_location, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_location)
# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# topX proteins
rm(list = str_subset(ls(), 'enrich_top'))
topN <- 3 # top3
enrich_topN_ls <- plyr::dlply(protinfo_tisen, 'tissue_type', function(dfsub){
  # dfsub <- protinfo_tisen %>% filter(tissue_type == 'ADG')
  pm <- df_tisen_organ %>% select(all_of(dfsub$UniprotID))
  med1_over_med2 <- apply(pm, 2, function(acol) { # calculate median_1st / median_2nd
    acol_sorted <- sort(acol, decreasing = T)
    return(acol_sorted[1] / acol_sorted[2])
  })
  enrich_topN <- sort(med1_over_med2, decreasing = T) %>% head(topN) %>% names() # topN
  return(enrich_topN)
})


# top X tissue enriched proteins
prot_selected <- unlist(enrich_topN_ls) # topN
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>% # tissue enriched
  filter(UniprotID %in% all_of(prot_selected)) %>% # top X
  arrange(tissue_type)

df_tisen_organ <- pm2 %>%
  select(anatomical_location, all_of(protinfo_tisen$UniprotID)) %>%
  arrange(anatomical_location)
# identical(colnames(df_tisen_organ)[-1], protinfo_tisen$UniprotID) # TRUE


# keepna
pm <- df_tisen_organ %>% select(-1)
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$anatomical_location

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-1]
row.tissue <- protinfo_tisen$tissue_type

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$UniprotID, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$UniprotID)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.tissue= factor(row.tissue, levels = unique(row.tissue), ordered = T),
                      row.organ = protinfo_tisen$anatomical_classification,
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(tissue = factor(df_tisen_organ$anatomical_location, levels = unique(df_tisen_organ$anatomical_location), ordered = T), 
                      organ = factor(df_tisen_organ$anatomical_classification, levels = unique(df_tisen_organ$anatomical_classification), ordered = T),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)
tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# tissue_color <- rep('#888888', length(unique(ann_col$tissue)))
# names(tissue_color) <- unique(ann_col$tissue)
# organ_color <- c('#CE9797', '#345D89', '#3C9191')
# names(organ_color) <- c('CE', 'SPI', 'NEV')
df_color <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/input/PUH_tissue_colorset_20230210.xlsx')
organ_color <- str_c('#', df_color$color[1:51])
names(organ_color) <- df_color$tissue[1:51]
organ_color <- organ_color[c('CE', 'SPI', 'NEV')]
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(#cancer=cancer_color,
  tissue=tissue_color, organ = organ_color,row.tissue=tissue_color,row.organ = organ_color)

# plot
dim(pm_heat) # 109  40
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=6,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_normal_Ulhen_nervous_tissue_enriched_top3_heatmap_scale_109protein_40locations_20230218.pdf",width=8,height=12)
protinfo_tisen %>% rio::export('TPHP_normal_Ulhen_nervous_tissue_enriched_top3.xlsx')


df_tm <- readxl::read_excel('//172.16.13.136/share/members/jiangwenhao/TPHP/input/targets_and_families.xlsx', sheet = 1)
df_tm1 <- df_tm %>% select(Type, `Human SwissProt`) %>% filter(`Human SwissProt` %in% colnames(df_tisen_organ)[-1])

```


### check GPCR and missing protein
#### Check GPCR
```{r}
df_tm <- readxl::read_excel('//172.16.13.136/share/members/jiangwenhao/TPHP/input/targets_and_families.xlsx', sheet = 1)

tmp <- rio::import('20230216yuel_TPHP_nervous_tissue_enriched1222_group_enriched2224_3561prot.csv')
nervous_en <- tmp %>% filter(Classification == 'tissue enriched') %>% pull(UniprotID)


df_nervous_target <- tmp %>% filter(Classification == 'tissue enriched') %>%
  inner_join(df_tm, by = c('UniprotID' = 'Human SwissProt'))

dim(df_nervous_target) # 205   39
df_nervous_target %>% rio::export('20230216yuel_TPHP_nervous_tissue_enriched1222_205target_11gpcr.xlsx')





```


#### check missing protein
```{r}
# missing proteins
df_miss <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/missing_proteins/missing_understudied_proteins.xlsx')


df_nervous_miss <- tmp %>% filter(Classification == 'tissue enriched') %>%
  inner_join(df_miss, by = 'UniprotID')

dim(df_nervous_miss) # 15  6
df_nervous_miss %>% rio::export('20230216yuel_TPHP_nervous_tissue_enriched1222_151understudiedOrMissing.xlsx')


```


# 4.All normal samples
start with new tables
'//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_2_sample_info/20231113TPHP_1781file_info_edited_v5.xlsx'

## Ulhen's classification method (2023-02-22)
```{r}
rm(list = ls())
library(tidyverse)
library(magrittr)
library(readxl)
library(writexl)

source("//172.16.13.136/share/members/yuel/2022/codes/20231113_ulhen_class.R")

# df<-read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/20220719_rm_randomNA_normal.xlsx")
df<-read_xlsx("//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_1_protein_matrix/20220701TPHP_1783file_info_onlyfilename-id_pm_swissprot1025.xlsx", col_types = c(rep('guess', 21), rep('numeric', 13479)))
ai<-read_xlsx('//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_2_sample_info/20231113TPHP_1781file_info_edited_v5.xlsx')

colnames(df)[1:22]

# new info covering
di <- df %>% select(-(Precursors:`Admisssion ID`)) %>% inner_join(ai, ., by = 'FileName')
di %>% count(sample_type)
di %<>% filter(sample_type %in% c('Normal', 'Fetal'))
# di %>% count(patient_ID) %>% rio::export('all_normal_patientid.xlsx')


dp <- rio::import('//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_2_sample_info/Supplemenrat_table_1_patinet_info.xlsx')

# change fetal labels
di[which(di$patient_ID == 'fetal8'), 'patient_ID'] <- dp$Patient_ID[dp$`Original id` == 'fetal 8']
di[which(di$patient_ID == 'fetal11'), 'patient_ID'] <- dp$Patient_ID[dp$`Original id` == 'fetal 11']
di[which(di$patient_ID == 'fetal12'), 'patient_ID'] <- dp$Patient_ID[dp$`Original id` == 'fetal 12']
di[which(di$patient_ID == 'fetal13'), 'patient_ID'] <- dp$Patient_ID[dp$`Original id` == 'fetal 13']
di[which(di$patient_ID == 'E'), 'patient_ID'] <- dp$Patient_ID[dp$`Original id` == 'E']
di[which(di$patient_ID == 'L'), 'patient_ID'] <- dp$Patient_ID[dp$`Original id` == 'L']
di[which(di$patient_ID == 'K'), 'patient_ID'] <- dp$Patient_ID[dp$`Original id` == 'K']
di[which(di$patient_ID == 'F'), 'patient_ID'] <- dp$Patient_ID[dp$`Original id` == 'F']

# setdiff(di$patient_ID, dp$Patient_ID) # NA
# setdiff(dp$Patient_ID, di$patient_ID) # "WL_1", "WL_2", "WL_3", "WL_4", "WL_5", "WL_6", "WL_7", "WL_8", "EX_FE_5", "EX_FE_6", "EX_FE_7", "EX_FE_8", "EX_FE_9"
# di %>% filter(patient_ID %in% c('L', 'E', 'K', 'F')) # 90 rows

colnames(di)[1:18]
di[, -(1:17)] <- log2(di[, -(1:17)])
df0 <- di
write_xlsx(df0,"20231113_TPHP_normalAll.xlsx")


table(df0$patient_ID)
table(df0$anatomical_classification)
dim(df0) # 675 13496
df1<-apply(df0[,-c(1:17)],c(1,2),as.numeric)
min(df1,na.rm = T) # 5.442346
max(df1,na.rm=T) # 32.20984

df0[,-c(1:17)] <- df1
rio::export(df0, 'TPHP_normalAllData_for_classification_20231113.xlsx')


pm1<-df1
pm1[is.na(pm1)]<-log2(2^min(pm1,na.rm = T)*0.5)
pm2<-aggregate(2^pm1,by=list(df0$anatomical_classification),median)

tissue_type_clas<-list()
tissue_type_clas[[1]]<-ulhen_class(pm2[,1:50])
for (i in 2:floor(ncol(pm1)/50)){
  tissue_type_clas[[i]]<-ulhen_class(pm2[,c(1,(50*(i-1)+1):(50*i))])
  cat(paste("Processed",i*50,"/",ncol(pm1) ,sep = " "),"\n")
}
tissue_type_clas[[ceiling(ncol(pm1)/50)]]<-ulhen_class(pm2[,c(1,(50*floor(ncol(pm1)/50)+1):ncol(pm1))])
tissue_type_clas_all<-tissue_type_clas%>% reduce_right(full_join, by = "tissue_type")
library(writexl)
write_xlsx(tissue_type_clas_all,"20231113TPHP_normalAll_64tissue_ulhen_classification.xlsx")



tissue_mean1<-tissue_type_clas_all
symbol<-colnames(tissue_mean1)[-c(1)]
#3945 enriched and group enriched proteins
mean_clas_symbol_list<-apply(tissue_mean1[,-c(1)],1, function (v){
  symbol[which(v=="tissue enriched" | v =="group enriched")]
})
length(unique(unlist(mean_clas_symbol_list))) # 5454

# library(plyr)
en_tab<-sapply(mean_clas_symbol_list,function(v){
  data.frame(t(v))
})
a<-as.data.frame(t(plyr::rbind.fill(en_tab)))
colnames(a)<-tissue_mean1$tissue_type

write.csv(a,"20231113yuel_TPHP_normalAll_enriched_proteins.csv",row.names = F)



#2529 tissue enriched proteins
mean_clas_symbol_list<-apply(tissue_mean1[,-c(1)],1, function (v){
  symbol[which(v=="tissue enriched" )]
})
length(unique(unlist(mean_clas_symbol_list))) # 2529

# library(plyr)
en_tab<-sapply(mean_clas_symbol_list,function(v){
  data.frame(t(v))
})
b<-as.data.frame(t(plyr::rbind.fill(en_tab)))
colnames(b)<-tissue_mean1$tissue_type
# 
write.csv(b,"20231113yuel_TPHP_normalAll_tissue_2529_enriched_proteins.csv",row.names = F)


tmp <- tissue_mean1 %>%
  pivot_longer(-tissue_type, names_to = 'UniprotID', values_to = 'Classification') %>%
  filter(str_detect(Classification, 'enriched')) %>%
  arrange(desc(Classification), UniprotID, tissue_type)

length(unique(tmp$UniprotID)) # 5454
tmp %>% filter(Classification == 'tissue enriched') %>% pull(UniprotID) %>% unique() %>% length() # 2529
tmp %>% filter(Classification == 'group enriched') %>% pull(UniprotID) %>% unique() %>% length() # 3400

rio::export(tmp, '20231113yuel_TPHP_normalAll_tissue_enriched2529_group_enriched3400_5454prot.csv')
rio::export(pm2, '20231113TPHP_normalAll_tissue_organ_median.xlsx')
```


## Unsupervised clustering
## read matrix
```{r}
source("//172.16.13.136/share/members/jiangwenhao/code/myQC.R")

df0 <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/TPHP_normalAllData_for_classification_20231113.xlsx')
df_info <- df0 %>% select(1:17)
df_info %<>% left_join(dp, by = c(patient_ID = 'Patient_ID'))
dim(df0) # 675 13496
colnames(df0)[1:18]

pm <- df0 %>% dplyr::select(FileName, 18:ncol(df0))
df1 <- df_info %>% inner_join(pm, by = 'FileName') %>% arrange(anatomical_classification, anatomical_location, tissue_name)
dim(df1) # 675 13502
colnames(df1)[1:18]


# 
df1 %>% count(anatomical_classification) %>% arrange(n) %>% View
df2 <- df1 %>% dplyr::select(FileName, tissue_name, anatomical_location, anatomical_classification, 19:ncol(df1))
dim(df2) # 675 13488

colnames(df2)[1:10]
df_type <- df2 %>% dplyr::select(1:9)
pm <- df2 %>% dplyr::select(1, 10:ncol(df2)) %>% column_to_rownames('FileName') %>% t() %>% as.data.frame()
nafill <- min(pm, na.rm = T) + log2(0.8) # min * 0.8
pm <- df2 %>% dplyr::select(1, 10:ncol(df2)) %>% column_to_rownames('FileName') %>% t() %>% as.data.frame()
pm %<>% removeRowsAllNa()
pm_fillna <- pm
pm_fillna[is.na(pm_fillna)] <- nafill



# df_type[df_type$tissue_name == 'cerebellum', 'anatomical_classification'] <- 'cerebellum'

```



## Ulhen classification list
```{r}
df_u <- read.csv('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/20231113yuel_TPHP_normalAll_enriched_proteins.csv', check.names = F)

prot_u <- unlist(df_u)[!is.na(unlist(df_u))] %>% unique
prot_unique <- sort(prot_u)
prot_unique <- intersect(prot_unique, rownames(pm_fillna))


df_select <- pm[prot_unique, ] %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column('FileName') %>%
  inner_join(df_type, ., by = 'FileName')

df_med <- df_select %>%
  dplyr::group_by(anatomical_classification) %>%
  dplyr::summarise_at(dplyr::vars(-(1:3)), median, na.rm = T) # 3 == 4 - 1

dim(df_med) # 64 5455


```


##PCA based t-SNE
### ** function **
```{r}
# Martin Sill's method
# https://github.com/mwsill/mnp_training/blob/master/R/RSpectra_pca.R
require(RSpectra)
require(Rtsne)

prcomp_svds <-
  function(x, retx = TRUE, center = TRUE, scale. = FALSE, tol = NULL, k=10, ...){
    chkDots(...)
    x <- as.matrix(x)
    x <- scale(x, center = center, scale = scale.)
    cen <- attr(x, "scaled:center")
    sc <- attr(x, "scaled:scale")
    if(any(sc == 0))
      stop("cannot rescale a constant/zero column to unit variance")
    s <- svds(x, k)
    s$d <- s$d / sqrt(max(1, nrow(x) - 1))
    if (!is.null(tol)) {
      ## we get rank at least one even for a 0 matrix.
      rank <- sum(s$d > (s$d[1L]*tol))
      if (rank < ncol(x)) {
        s$v <- s$v[, 1L:rank, drop = FALSE]
        s$d <- s$d[1L:rank]
      }
    }
    dimnames(s$v) <-
      list(colnames(x), paste0("PC", seq_len(ncol(s$v))))
    r <- list(sdev = s$d, rotation = s$v,
              center = if(is.null(cen)) FALSE else cen,
              scale = if(is.null(sc)) FALSE else sc)
    if (retx) r$x <- x %*% s$v
    class(r) <- "prcomp"
    r
  }


```

<!-- ###test -->
<!-- ```{r test} -->
<!-- df3 <- df_med %>% column_to_rownames('anatomical_classification') -->
<!-- na_ratio <- apply(df3, 2, function(col){sum(is.na(col)) / length(col)}) -->
<!-- hist(na_ratio) -->
<!-- df3[, na_ratio < 0.5] -->

<!-- df3[is.na(df3)] <- nafill -->

<!-- rowNormalization <- T -->
<!-- colNormalization <- F -->

<!-- DF <- df3 -->

<!-- if (rowNormalization) { -->
<!--   M <-data.frame(t(apply(DF, 1, function(v) { -->
<!--     (v - mean(v, na.rm = T)) / sd(v, na.rm = T) -->
<!--   }))) -->
<!--   #print('Normalization by row is done!') -->
<!-- } -->
<!-- if (colNormalization) { -->
<!--   M <- apply(DF, 2, function(v) { -->
<!--     (v - mean(v, na.rm = T)) / sd(v, na.rm = T) -->
<!--   }) -->
<!-- } -->

<!-- m1 <- prcomp(M) -->
<!-- summary(m1) -->
<!-- m1$x; # pca -->
<!-- m1$rotation # eigen$vectors -->
<!-- m1$sdev ^ 2 # eigen$values -->

<!-- plot(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2)) # 50+ -->
<!-- (cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2))[94] # NA -->
<!-- which(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2) <= 0.763) %>% max() # 31 -->
<!-- which(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2) <= 0.9) %>% max() # 43 -->
<!-- (cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2))[39] # 0.8481693 -->

<!-- ``` -->


<!-- ```{r} -->
<!-- # Martin Sill's method -->
<!-- # https://github.com/mwsill/mnp_training/blob/master/R/RSpectra_pca.R -->
<!-- require(RSpectra) -->
<!-- require(Rtsne) -->

<!-- prcomp_svds <- -->
<!--   function(x, retx = TRUE, center = TRUE, scale. = FALSE, tol = NULL, k=10, ...){ -->
<!--     chkDots(...) -->
<!--     x <- as.matrix(x) -->
<!--     x <- scale(x, center = center, scale = scale.) -->
<!--     cen <- attr(x, "scaled:center") -->
<!--     sc <- attr(x, "scaled:scale") -->
<!--     if(any(sc == 0)) -->
<!--       stop("cannot rescale a constant/zero column to unit variance") -->
<!--     s <- svds(x, k) -->
<!--     s$d <- s$d / sqrt(max(1, nrow(x) - 1)) -->
<!--     if (!is.null(tol)) { -->
<!--       ## we get rank at least one even for a 0 matrix. -->
<!--       rank <- sum(s$d > (s$d[1L]*tol)) -->
<!--       if (rank < ncol(x)) { -->
<!--         s$v <- s$v[, 1L:rank, drop = FALSE] -->
<!--         s$d <- s$d[1L:rank] -->
<!--       } -->
<!--     } -->
<!--     dimnames(s$v) <- -->
<!--       list(colnames(x), paste0("PC", seq_len(ncol(s$v)))) -->
<!--     r <- list(sdev = s$d, rotation = s$v, -->
<!--               center = if(is.null(cen)) FALSE else cen, -->
<!--               scale = if(is.null(sc)) FALSE else sc) -->
<!--     if (retx) r$x <- x %*% s$v -->
<!--     class(r) <- "prcomp" -->
<!--     r -->
<!--   } -->

<!-- y <- as.factor(colnames(df3)) -->

<!-- # calculate first 167 PCs -->
<!-- DF <- df3 -->
<!-- pca <- prcomp_svds(DF, retx = T, center = T, scale. = T, tol = NULL, k = 40) -->
<!-- View(pca$x) -->

<!-- # Notice -->
<!-- # perplexity    numeric; Perplexity parameter (should not be bigger -->
<!-- #               than 3 * perplexity < nrow(X) - 1, see details for -->
<!-- #               interpretation) -->

<!-- # calculate tSNE -->
<!-- set.seed(2020) -->
<!-- res <- Rtsne(pca$x,pca=F,max_iter=2500,theta=0,verbose=T, -->
<!--              perplexity = floor((nrow(pca$x) - 1) / 3)) -->

<!-- # scatterplot tSNE -->
<!-- plot(res$Y,pch=19,col=y) -->


<!-- # # calculate tSNE -->
<!-- # set.seed(2020) -->
<!-- # res <- Rtsne(pca$x,pca=F,max_iter=50000,theta=0,verbose=T, -->
<!-- #              perplexity = floor((nrow(pca$x) - 1) / 3)) -->
<!-- #  -->
<!-- # # scatterplot tSNE -->
<!-- # plot(res$Y,pch=19,col=y) -->
<!-- ``` -->

<!-- ### organ clustering -->
<!-- ```{r} -->
<!-- # Martin Sill's method -->
<!-- # https://github.com/mwsill/mnp_training/blob/master/R/RSpectra_pca.R -->
<!-- require(RSpectra) -->
<!-- require(Rtsne) -->

<!-- prcomp_svds <- -->
<!--   function(x, retx = TRUE, center = TRUE, scale. = FALSE, tol = NULL, k=10, ...){ -->
<!--     chkDots(...) -->
<!--     x <- as.matrix(x) -->
<!--     x <- scale(x, center = center, scale = scale.) -->
<!--     cen <- attr(x, "scaled:center") -->
<!--     sc <- attr(x, "scaled:scale") -->
<!--     if(any(sc == 0)) -->
<!--       stop("cannot rescale a constant/zero column to unit variance") -->
<!--     s <- svds(x, k) -->
<!--     s$d <- s$d / sqrt(max(1, nrow(x) - 1)) -->
<!--     if (!is.null(tol)) { -->
<!--       ## we get rank at least one even for a 0 matrix. -->
<!--       rank <- sum(s$d > (s$d[1L]*tol)) -->
<!--       if (rank < ncol(x)) { -->
<!--         s$v <- s$v[, 1L:rank, drop = FALSE] -->
<!--         s$d <- s$d[1L:rank] -->
<!--       } -->
<!--     } -->
<!--     dimnames(s$v) <- -->
<!--       list(colnames(x), paste0("PC", seq_len(ncol(s$v)))) -->
<!--     r <- list(sdev = s$d, rotation = s$v, -->
<!--               center = if(is.null(cen)) FALSE else cen, -->
<!--               scale = if(is.null(sc)) FALSE else sc) -->
<!--     if (retx) r$x <- x %*% s$v -->
<!--     class(r) <- "prcomp" -->
<!--     r -->
<!--   } -->

<!-- y <- as.factor(colnames(df3)) -->

<!-- # calculate first 167 PCs -->
<!-- # DF <- t(df3) -->
<!-- DF <- as.matrix(df3) -->
<!-- pca <- prcomp_svds(DF, retx = T, center = T, scale. = T, tol = NULL, k = 40) -->
<!-- View(pca$x) -->

<!-- # Notice -->
<!-- # perplexity    numeric; Perplexity parameter (should not be bigger -->
<!-- #               than 3 * perplexity < nrow(X) - 1, see details for -->
<!-- #               interpretation) -->


<!-- # calculate tSNE -->
<!-- set.seed(2020) -->
<!-- res <- Rtsne(pca$x,pca=F,max_iter=2500,theta=0,verbose=T, -->
<!--              perplexity = floor((nrow(pca$x) - 1) / 3)) -->

<!-- # scatterplot tSNE -->
<!-- plot(res$Y,pch=19,col=y) -->


<!-- # calculate tSNE -->
<!-- set.seed(2020) -->
<!-- res <- Rtsne(pca$x,pca=F,max_iter=50000,theta=0,verbose=T, -->
<!--              perplexity = floor((nrow(pca$x) - 1) / 3)) -->

<!-- # scatterplot tSNE -->
<!-- plot(res$Y,pch=19,col=y) -->
<!-- ``` -->


<!-- <!-- ### k=50 --> -->
<!-- <!-- ```{r} --> -->
<!-- <!-- pca <- prcomp_svds(DF, retx = T, center = T, scale. = T, tol = NULL, k = 50) --> -->
<!-- <!-- View(pca$x) --> -->

<!-- <!-- # calculate tSNE --> -->
<!-- <!-- set.seed(2020) --> -->
<!-- <!-- res <- Rtsne(pca$x,pca=F,max_iter=50000,theta=0,verbose=T, --> -->
<!-- <!--              perplexity = floor((nrow(pca$x) - 1) / 3)) --> -->

<!-- <!-- # scatterplot tSNE --> -->
<!-- <!-- plot(res$Y,pch=19,col=y) --> -->
<!-- <!-- ``` --> -->


<!-- ####t-SNE 20 clusters -->
<!-- ```{r} -->
<!-- library(ggrepel) -->

<!-- tsne <- res$Y %>% as.data.frame -->
<!-- colnames(tsne) <- c('tsne1', 'tsne2') -->
<!-- hc <- hclust(dist(tsne)) -->

<!-- info <- tsne -->
<!-- info$hclust <- factor(cutree(hc, 20)) -->
<!-- info$anatomical_classification <- rownames(DF) -->
<!-- # info %<>% left_join(df_type, by = 'anatomical_classification') -->
<!-- info %<>% mutate(hclust = str_c('Cluster ', hclust)) -->
<!-- rownames(info) <- info$anatomical_classification -->

<!-- canvasXpress::canvasXpress(data=list(y=info[, 1:2]), -->
<!--                            varAnnot=info, -->
<!--                            scatterPlotMatrix=F, -->
<!--                            title='t-SNE', -->
<!--                            colorBy ='anatomical_classification', -->
<!--                            legendColumns=1, -->
<!--                            width = 1200, -->
<!--                            height=600, -->
<!--                            roundedPolygonRadius=3) -->
<!-- rio::export(info, "TPHP_adatiss_dboverlap_tsne20220731.xlsx") -->


<!-- hc.cent <- info %>% -->
<!--   group_by(hclust) %>% -->
<!--   dplyr::select(tsne1, tsne2) %>% -->
<!--   summarize_all(mean) -->

<!-- p <- ggplot(info, aes(x = tsne1, y = tsne2, colour = hclust)) +  -->
<!--   geom_point(alpha = 0.3) +  -->
<!--   theme_bw() + -->
<!--   geom_label_repel(aes(label = hclust),  -->
<!--                    data = hc.cent) + -->
<!--   guides(colour = 'none') + -->
<!--   ggtitle("")#+ -->
<!--   # theme(legend.position = 'top', -->
<!--   #           legend.text = element_text(size = 25,color = "black"), -->
<!--   #           legend.title = element_blank() , -->
<!--   #           #legend.title = element_text(size=20,color="black") , -->
<!--   #           panel.grid.major =element_blank(), -->
<!--   #           panel.grid.minor = element_blank(), -->
<!--   #           panel.background = element_blank(), -->
<!--   #           axis.line = element_line(colour = "black"))+ -->
<!--   #     theme(panel.grid =element_blank())+ -->
<!--   #     theme(axis.text = element_text(size = 20,color = "black"))+ -->
<!--   #     theme(axis.text.x = element_text(size = 20,color = "black", angle = 0))+ -->
<!--   #     theme(plot.subtitle=element_text(size=60, hjust=0, color="black"))+ -->
<!--   #     theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+ -->
<!--   #     theme(axis.title.y=element_text(size=30, hjust=0.5, color="black")) -->

<!-- print(p) -->
<!-- ggsave("TPHP_adatiss_dboverlap_tsne20220731.pdf",p,width=8,height=8) -->


<!-- ``` -->


<!-- ####t-SNE 5 clusters -->
<!-- ```{r} -->
<!-- library(ggrepel) -->

<!-- tsne <- res$Y %>% as.data.frame -->
<!-- colnames(tsne) <- c('tsne1', 'tsne2') -->
<!-- hc <- hclust(dist(tsne)) -->

<!-- info <- tsne -->
<!-- info$hclust <- factor(cutree(hc, 5)) -->
<!-- info$anatomical_classification <- rownames(DF) -->
<!-- # info %<>% left_join(df_type, by = 'anatomical_classification') -->
<!-- info %<>% mutate(hclust = str_c('Cluster ', hclust)) -->
<!-- rownames(info) <- info$anatomical_classification -->

<!-- canvasXpress::canvasXpress(data=list(y=info[, 1:2]), -->
<!--                            varAnnot=info, -->
<!--                            scatterPlotMatrix=F, -->
<!--                            title='t-SNE', -->
<!--                            colorBy ='anatomical_classification', -->
<!--                            legendColumns=1, -->
<!--                            width = 1200, -->
<!--                            height=600, -->
<!--                            roundedPolygonRadius=3) -->
<!-- # rio::export(info, "TPHP_adatiss_dboverlap_tsne20220731.xlsx") -->


<!-- hc.cent <- info %>% -->
<!--   group_by(hclust) %>% -->
<!--   dplyr::select(tsne1, tsne2) %>% -->
<!--   summarize_all(mean) -->

<!-- p <- ggplot(info, aes(x = tsne1, y = tsne2, colour = hclust)) +  -->
<!--   geom_point(alpha = 0.3) +  -->
<!--   theme_bw() + -->
<!--   geom_label_repel(aes(label = hclust),  -->
<!--                    data = hc.cent) + -->
<!--   guides(colour = 'none') + -->
<!--   ggtitle("")#+ -->
<!--   # theme(legend.position = 'top', -->
<!--   #           legend.text = element_text(size = 25,color = "black"), -->
<!--   #           legend.title = element_blank() , -->
<!--   #           #legend.title = element_text(size=20,color="black") , -->
<!--   #           panel.grid.major =element_blank(), -->
<!--   #           panel.grid.minor = element_blank(), -->
<!--   #           panel.background = element_blank(), -->
<!--   #           axis.line = element_line(colour = "black"))+ -->
<!--   #     theme(panel.grid =element_blank())+ -->
<!--   #     theme(axis.text = element_text(size = 20,color = "black"))+ -->
<!--   #     theme(axis.text.x = element_text(size = 20,color = "black", angle = 0))+ -->
<!--   #     theme(plot.subtitle=element_text(size=60, hjust=0, color="black"))+ -->
<!--   #     theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+ -->
<!--   #     theme(axis.title.y=element_text(size=30, hjust=0.5, color="black")) -->

<!-- print(p) -->
<!-- # ggsave("TPHP_adatiss_dboverlap_tsne20220731.pdf",p,width=8,height=8) -->


<!-- ``` -->





### File clustering
```{r}
# df3 <- df_select %>% column_to_rownames('FileName') %>% select(-(1:3))
# na_ratio <- apply(df3, 2, function(col){sum(is.na(col)) / length(col)})
# hist(na_ratio)
# df3[, na_ratio < 0.5]
# 
# df3[is.na(df3)] <- nafill
# 
# rowNormalization <- T
# colNormalization <- F
# 
# DF <- df3

colnames(df2)[1:10]
DF <- df2 %>% dplyr::select(-(2:9)) %>% column_to_rownames('FileName') 
DF[is.na(DF)] <- nafill
M <-data.frame(t(apply(DF, 1, function(v) {
  (v - mean(v, na.rm = T)) / sd(v, na.rm = T)
})))
m1 <- prcomp(M)
# summary(m1)
# m1$x; # pca
# m1$rotation # eigen$vectors
# m1$sdev ^ 2 # eigen$values

plot(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2)) # 600+
(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2))[94] # 0.6546899
which(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2) <= 0.763) %>% max() # 203
which(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2) <= 0.9) %>% max() # 418
(cumsum(m1$sdev ^ 2)/sum(m1$sdev ^ 2))[420] # 0.9006005


y <- as.factor(colnames(DF))
pca <- prcomp_svds(DF, retx = T, center = F, scale. = T, tol = NULL, k = 420)


# calculate tSNE
set.seed(2020)
res <- Rtsne(pca$x,pca=F,max_iter=2500,theta=0,verbose=T,
             perplexity = floor((nrow(pca$x) - 1) / 3))

# scatterplot tSNE
plot(res$Y,pch=19,col=y)


# # calculate tSNE (iter == 50000)
# set.seed(2020)
# res <- Rtsne(pca$x,pca=F,max_iter=50000,theta=0,verbose=T,
#              perplexity = floor((nrow(pca$x) - 1) / 3))
# # scatterplot tSNE
# plot(res$Y,pch=19,col=y)



tsne <- res$Y %>% as.data.frame
colnames(tsne) <- c('tsne1', 'tsne2')
hc <- hclust(dist(tsne))

info <- tsne
info$hclust <- factor(cutree(hc, 20))
info$FileName <- rownames(DF)
# info %<>% left_join(df_type, by = 'anatomical_classification')
info %<>% mutate(hclust = str_c('Cluster ', hclust))
info %<>% left_join(df_type, by = 'FileName')
rownames(info) <- info$FileName

canvasXpress::canvasXpress(data=list(y=info[, 1:2]),
                           varAnnot=info,
                           scatterPlotMatrix=F,
                           title='t-SNE',
                           colorBy ='anatomical_classification',
                           legendColumns=1,
                           width = 1200,
                           height=600,
                           roundedPolygonRadius=3)

hc.cent <- info %>%
  group_by(hclust) %>%
  dplyr::select(tsne1, tsne2) %>%
  summarize_all(mean)

p <- ggplot(info, aes(x = tsne1, y = tsne2, colour = hclust)) + 
  geom_point(alpha = 0.3) + 
  theme_bw() +
  ggrepel::geom_label_repel(aes(label = hclust), 
                   data = hc.cent) +
  guides(colour = 'none') +
  ggtitle("")#+
# theme(legend.position = 'top',
#           legend.text = element_text(size = 25,color = "black"),
#           legend.title = element_blank() ,
#           #legend.title = element_text(size=20,color="black") ,
#           panel.grid.major =element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#           axis.line = element_line(colour = "black"))+
#     theme(panel.grid =element_blank())+
#     theme(axis.text = element_text(size = 20,color = "black"))+
#     theme(axis.text.x = element_text(size = 20,color = "black", angle = 0))+
#     theme(plot.subtitle=element_text(size=60, hjust=0, color="black"))+
#     theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
#     theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))

print(p)
ggsave('20231113_64normalAll_tissue_pca_based_tsne_clustering.pdf', p, width = 10, height = 10)
info %>%
  arrange(hclust, anatomical_classification, anatomical_location, tissue_name) %>%
  rio::export('20231113_64normalAll_tissue_pca_based_tsne_clustering.xlsx')



# get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
info$anatomical_classification <- sapply(info$anatomical_classification, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))



# set order
pm2 <- rio::import('20231113TPHP_normalAll_tissue_organ_median.xlsx')
pm2 %<>% column_to_rownames('Group.1')
rownames(pm2) %<>% sapply(function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

pm_heat_cor <- cor(t(pm2), method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
organs_ordered <- pm_heat_tree$labels[pm_heat_tree$order]

info$anatomical_classification %<>% factor(levels = organs_ordered, ordered = T)
info %<>% arrange(anatomical_classification)

# # # set colors
# df_color <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/input/PUH_tissue_colorset_20230210.xlsx')
# tissue_color <- str_c('#', df_color$color[1:51])
# names(tissue_color) <- df_color$tissue[1:51]
# tissue_color <- tissue_color[organs_ordered]
# tissue_color_shape <-
#   data.frame(anatomical_classification = sort(unique(info$anatomical_classification)),
#              color = tissue_color)
# info %<>% left_join(tissue_color_shape, by = 'anatomical_classification')
# 
# p <- ggplot(info) + 
#   geom_point(aes(x = tsne1, y = tsne2, color = anatomical_classification), shape = 16) +
#   # geom_point(color='black', shape=21, size=4, aes(fill=factor(group))) +
#   # scale_fill_manual(values = tissue_color) +
#   scale_color_manual(values = tissue_color) +
#   theme_bw()
# ggsave('20231113_51normal_tissue_pca_based_tsne_clustering_custom.pdf', p, width = 10, height = 10)


my_colors <- c('#368FC6', '#55BC6D', '#D8894E', '#7C0823', '#9D7DDB', '#F0EA43', '#000000', '#888888')
my_shapes <- c(1, 2, 6, 3, 4, 15, 17:19)

shape_color_pairs <- expand.grid(my_shapes, my_colors)

p <- ggplot(info) + 
  geom_point(aes(x = tsne1, y = tsne2, shape = anatomical_classification, color = anatomical_classification), size = 2)+
  scale_shape_manual(values = shape_color_pairs[, 1])+
  scale_color_manual(values = as.character(shape_color_pairs[, 2]))+
  theme_bw()
ggsave('20231113_64normalAll_tissue_pca_based_tsne_clustering_custom.pdf', p, width = 10, height = 10)


# patient label
info <- df_info %>% select(setdiff(colnames(df_info), colnames(info)), FileName) %>% left_join(info, ., by = 'FileName')

p_patient <- ggplot(info) + 
  geom_point(aes(x = tsne1, y = tsne2, shape = patient_ID, color = patient_ID), size = 2)+
  scale_shape_manual(values = shape_color_pairs[, 1])+
  scale_color_manual(values = as.character(shape_color_pairs[, 2]))+
  theme_bw()


# p_patient <- ggplot(info) + 
#   geom_point(aes(x = tsne1, y = tsne2, color = patient_ID), size = 4, shape = 'circle')+
#   scale_color_brewer(palette = 'Set3') +
#   # scale_shape_manual(values = shape_color_pairs[, 1])+
#   # scale_color_manual(values = unname(tissue_color))+
#   theme_bw()
ggsave('20231113_64normalAll_tissue_pca_based_tsne_clustering_custom_patient.pdf', p_patient, width = 10, height = 10)



# gender label
p_gender <- ggplot(info) + 
  geom_point(aes(x = tsne1, y = tsne2, color = Gender), size = 2)+
  # scale_shape_manual(values = shape_color_pairs[, 1])+
  # scale_color_manual(values = as.character(shape_color_pairs[, 2]))+
  theme_bw()

ggsave('20231113_64normalAll_tissue_pca_based_tsne_clustering_custom_gender.pdf', p_gender, width = 10, height = 10)


# batch label
info$Date <- str_extract(info$FileName, '^[A-Z]+[0-9]+')
info[info$Date == 'M202006203', 'Date'] <- 'M20200623'
info$Batch <- str_extract(info$Date, '^[A-Z]+[0-9]{6}')
unique(info$Batch)
info$Batch <- factor(info$Batch, levels = c("K202006", "M202006", "K202007", "M202007", "M202008", "M202012", "M202101", "N202104", "N202105", "N202106", "N202204"), ordered = T)

p_batch <- ggplot(info) + 
  geom_point(aes(x = tsne1, y = tsne2, color = Batch), size = 2)+
  scale_color_manual(values = RColorBrewer::brewer.pal(n = length(unique(info$Batch)), name = 'Spectral'))+
  theme_bw()

ggsave('20231113_64normalAll_tissue_pca_based_tsne_clustering_custom_batch.pdf', p_batch, width = 10, height = 10)

```




#EOF