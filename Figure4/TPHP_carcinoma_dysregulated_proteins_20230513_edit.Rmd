---
title: "Carcinoma_dysregulated_proteins"
author: ""
date: '2022-12-22'
output: html_document
---

```{r setup, include=FALSE}
## knitr::opts_chunk$set(echo = TRUE)
# pacman::p_unload(pacman::p_loaded(), character.only = T)
# rm(list = ls())
library(tidyverse)
library(magrittr)
library(readxl)
library(writexl)
library(RColorBrewer)
setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/')

```


global missing ratio
cancer organ
- select missing <= 50%
- NA fill
- FC, t.test
- p adjust

NAsub-matrixmatrix
gastric carcinoma remains adenocarcinoma only


# 2023-03-18 CA-SCA-poolmatrix
//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_1_protein_matrix/TPHP_CA-SCA-pool_pm_qu_log2_limma_20220705.csv
```{r}
df_info <- readxl::read_excel('Z:/members/jiangwenhao/to_yl/20220701TPHP_1783file_117pool_info_onlyfilename-id_pm_swissprot1025.xlsx', col_types = c(rep('guess', 21), rep('numeric', 13479)))
df_info %<>% select(1:21)

# df_full <- rio::import('//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_1_protein_matrix/TPHP_CA-SCA-pool_pm_qu_log2_limma_20220705.csv')
df_full <- read.csv('//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_1_protein_matrix/TPHP_CA-SCA-pool_pm_qu_log2_limma_20220705.csv', check.names = F)
colnames(df_full)[1] <- 'X'
df_full %<>%
  column_to_rownames('X') %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column('FileName')
df_full %<>% right_join(df_info, ., by = "FileName")

df_full %>% colnames() %>% head(22)



pm<-read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/20220714TPHP_CA_remove_05NA_1099_9800.xlsx",col_types = "text")
pm_full <- df_full %>% select(DIA_ID, 22:ncol(df_full))

# pm_full %>% count(DIA_ID) %>% filter(n > 1)
# pm %>% count(DIA_ID) %>% filter(n > 1)
# pm_full_agg <- pm_full %>%
#   filter(!is.na(DIA_ID)) %>%
#   group_by(DIA_ID) %>% summarise_all(mean, na.rm = T)
# pm_new <- pm_full_agg %>% filter(DIA_ID %in% pm$DIA_ID)
# rm(pm_full_agg, pm_new)

# # check
# pm_full %>% filter(DIA_ID %in% pm$DIA_ID)
# x1 <- pm_full %>% filter(DIA_ID %in% pm$DIA_ID) %>% count(DIA_ID) %>% filter(n > 1)
# x2 <- pm %>% count(DIA_ID) %>% filter(n > 1)
# 
# merge(x1, x2, all = T, by = 'DIA_ID') %>% filter(is.na(n.y))
# # SCA_529	
# # SCA_697
# 
# pm %>% filter(DIA_ID %in% c('SCA_529', 'SCA_697')) %>% View()
# pm_full %>% filter(DIA_ID %in% c('SCA_529', 'SCA_697')) %>% mutate_at(vars(-1), 'log2')
# pm_full %>% filter(DIA_ID %in% c('SCA_529', 'SCA_697')) %>% apply(1, function(x){sum(is.na(x)) / length(x)})
# # 0.4967359 0.4010386 0.3984421 0.5411721

pm_full1 <- pm_full %>%
  filter(DIA_ID %in% pm$DIA_ID) %>%
  filter(!(DIA_ID %in% c('SCA_529', 'SCA_697')))
pm_full2 <- pm_full %>% filter(DIA_ID %in% c('SCA_529', 'SCA_697')) %>%
  filter(DIA_ID %in% pm$DIA_ID) %>%
  slice(2, 3) # select row 2, 3
pm_new <- rbind(pm_full1, pm_full2) %>%
  filter(DIA_ID %in% pm$DIA_ID)

pm %<>% arrange(DIA_ID)
pm_new %<>% arrange(DIA_ID)
identical(pm$DIA_ID, pm_new$DIA_ID) # TRUE
pm_new <- cbind(pm[, 1:5], pm_new[, -1])


# check new matrix (full matrix)
identical(pm$DIA_ID, pm_new$DIA_ID) # TRUE
na_cols <- which(apply(pm_new, 2, function(x) sum(is.na(x)) / length(x)) == 1) # all is NA (4 proteins)
pm_new %<>% select(-all_of(na_cols))
pm_new %>% rio::export("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230116TPHP_CA_remove_allNA_1099_13392.xlsx")
```







# 2023-03-18 differently expressed
```{r}
# pm_old <- read_xlsx("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20221228TPHP_CA_remove_allNA_1099_13392.xlsx",col_types = "text")
pm <- readxl::read_excel("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230116TPHP_CA_remove_allNA_1099_13392.xlsx",
                col_types = c(rep('guess', 5), rep('numeric', 13392)), na = '')
X <- as.matrix(pm[,-c(1:5)])
sum(is.na(X)) / length(X) # 0.4484331

#20220905 CA/ADJ differentiated proteins in each organ
#imputation of MAs and replicates

pm3<-apply(pm[,-c(1:5)],c(1,2),as.numeric)
min(pm3,na.rm = T)#7.802752
na.sum<-apply(pm3, 2, function(v) is.na(v)/length(v))
sum(na.sum==1)
# group.na.sum<-aggregate(pm3, by=list(pm$cancer_type,pm$organ),function(v){
#   apply(as.data.frame(v), 2, function(x) is.na(x)/length(x))
# })

set.seed(2022)
na_pools <- min(pm3,na.rm = T)+log2(0.5)+log2(rnorm(10000000,mean=1,sd=0.001))

# pm3[is.na(pm3)]<-sample(min(pm3,na.rm = T)+log2(0.5)+log2(rnorm(10000000,mean=1,sd=0.001)),size = sum(is.na(unlist(pm3))))


pm4<-aggregate(2^pm3,by=list(pm$DIA_ID),median,na.rm=T)
pm4<-pm4[!is.na(pm4$Group.1),]

#remove unpaired ca/adj samples
tab<-as.data.frame(cbind(data.frame(DIA_ID=pm4$Group.1),
                         pm[match(pm4$Group.1,pm$DIA_ID),2:5]))
si_pm_ca<-as.data.frame(cbind(tab,log2(pm4[,-1])))              
si_pm_ca2<-si_pm_ca[which(si_pm_ca$patient_ID %in% na.omit(unique(si_pm_ca$patient_ID[duplicated(si_pm_ca$patient_ID)]))),]
tmp<-aggregate(si_pm_ca2$DIA_ID,by=list(si_pm_ca2$patient_ID),length)
# sis2<-distinct(sis)
si_pm_ca3<-si_pm_ca2[!is.na(si_pm_ca2$organ),]#remove back


#differentiated analysis
label_vec <- unique(si_pm_ca2$cancer_type)
types_vec <- unique(si_pm_ca2$organ)
type_col <- 'organ'
pdfPath <- '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_dysregulated_filter50NAByOrgan.pdf'
main_volcano_title <- 'CA/ADJ volcano plot'
main_tsv_name <- '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_CA_ADJ_volcanoplot_filter50NAByOrgan_2-fc_0.05p_'
df<-si_pm_ca3
pairedT=T
cutoff_fc = 2.0
cuttoff_p = 0.05
dir.create(stringr::str_c(stringr::str_split(pdfPath, '/')[[1]][-length(stringr::str_split(pdfPath, '/')[[1]])], collapse = '/'), recursive = T)
# select paired rows, then columns
df_pair <- df[df$cancer_type %in% label_vec, ]
df_pair <- df_pair[order(df_pair$patient_ID), ]
# remove gastric poorly cohesive and mixed carcinoma
df_pair %<>%
  filter(!(tissue_name %in% c('gastric poorly cohesive carcinoma', 'gastric mixed carcinoma'))) %>%
  select(-iRT3, -iRT7)
dim(df_pair) # 998 13395
colnames(df_pair)[1:6]
13395 - 5 == 13390
rio::export(df_pair, '20230318_CA_ADJ_pairs_for_DPA_998_13390prot.xlsx')


df_pair <- readxl::read_excel("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_CA_ADJ_pairs_for_DPA_998_13390prot.xlsx",
                col_types = c(rep('guess', 5), rep('numeric', 13390)), na = '') %>%
  as.data.frame()
fcs <- list(); pValues_t <- list(); pAdjs_t <- list(); pValues_wilcox <- list(); pAdjs_wilcox <- list(); names_ls <- list()
tmp_ls <- list() # to save all `df_tmp` tables
# Step1: calculate fold change and p value
for(i in 1:length(types_vec)){
  # select one library type data per loop
  #df_tmp <- df_pair[df_pair[, type_col] == types_vec[i], ]
  # i=1
  df_tmp <- df_pair[sapply(df_pair[, type_col], function(e){grepl(e, types_vec[i])}), ]
  pm_tmp <- df_tmp %>% select(-(1:5))
  pm_tmp <- pm_tmp[, apply(pm_tmp, 2, function(x) sum(is.na(x)) / length(x)) <= 0.5] # remove NA > 50%
  tmp_ls[[i]] <- cbind(df_tmp[, (1:5)], pm_tmp) # save unfilled tables
  
  pm_tmp[is.na(pm_tmp)] <- sample(na_pools, size = sum(is.na(unlist(pm_tmp))))
  df_tmp <- cbind(df_tmp[, (1:5)], pm_tmp)
  
  tmp <- table(df_tmp$cancer_type)
  # continue to the next loop if the runs of any label less than two or the label types_vec less than two
  if( any(tmp < 2) | length(tmp) %% 2 | length(tmp) < 2 ){ print(str_c('Skipped: ', i, ' -- ', types_vec[i])); next; }
  # select rows and remove columns with all values being NA
  df_tmp <- df_tmp[, !(colnames(df_tmp) %in% c(type_col, 'DDA_lib_type'))]
  df_tmp <- df_tmp[, apply(df_tmp, 2, function(v){ sum(is.na(v)) < nrow(df_tmp) })]
  
  # prepare plotting information
  cancer_type <- df_tmp$cancer_type
  lbls <- label_vec
  
  mat <- apply(df_tmp[, !(colnames(df_tmp)) %in% colnames(df)[1:5]], c(1, 2), as.numeric)
  dim(mat)
  
  ## assign NA to log2(min)
  #min_log2 <- log2(min(2 ^ mat, na.rm = T) * 0.8)
  #mat[is.na(mat)] <- min_log2
  
  fc <- apply(2 ^ mat, 2, function(x){
    log2(mean(na.omit(x[cancer_type==lbls[1]])) / mean(na.omit(x[cancer_type == lbls[2]])))
  })
  pValue_t <- apply(mat, 2, function(v) {
    p1 <- try(t.test(v[cancer_type == lbls[1]], v[cancer_type == lbls[2]], paired = T, var.equal = F)$p.value)
    return(p1)
  })
  pValue_wilcox <- apply(2 ^ mat, 2, function(v) {
    p1 <- try(wilcox.test(v[cancer_type == lbls[1]], v[cancer_type == lbls[2]], paired = T, var.equal = F)$p.value)
    return(p1)
  })
  pAdj_t <- p.adjust(pValue_t,method="BH")
  pAdj_wilcox <- p.adjust(pValue_wilcox,method="BH")
  fcs[[i]] <- fc; pValues_t[[i]] <- pValue_t; pAdjs_t[[i]] <- pAdj_t
  pValues_wilcox[[i]] <- pValue_wilcox; pAdjs_wilcox[[i]] <- pAdj_wilcox
  names_ls[[i]] <- colnames(df_tmp[, !(colnames(df_tmp)  %in% colnames(df)[1:5])])
}

dftmp_comb <- reduce(tmp_ls, full_join)
# rio::export(dftmp_comb, '20230224_PUH_submatrix_combine_5_missing_log2.csv')
dftmp_comb[, -(1:5)] <- 2 ^ dftmp_comb[, -(1:5)]
# rio::export(dftmp_comb, '20230224_PUH_submatrix_combine_5_missing.csv')




df_infov5 <- rio::import('//172.16.13.114/share/members/yuel/1project/0_TPHP/1_data/0_2_sample_info/20230222TPHP_1781file_info_edited_v5.xlsx')
dftmp_comb_ <- df_infov5 %>%
  distinct(DIA_ID, anatomical_classification) %>%
  left_join(dftmp_comb, ., by = 'DIA_ID') %>%
  rename(sample_type = cancer_type) %>%
  select(DIA_ID, sample_type, tissue_name, patient_ID, anatomical_classification, organ, everything())
rio::export(dftmp_comb_, '//172.16.13.136/share/members/yuel/2022/tables/20230318_PUH_submatrix_combine_5_missing.csv')

# create CA-Adj difference matrix
sub_com <- rio::import('//172.16.13.136/share/members/yuel/2022/tables/20230318_PUH_submatrix_combine_5_missing.csv')
rem4_m<-sub_com[,-c(1:6)]
imp<-min(rem4_m,na.rm = T)*0.5
rem4_m[is.na(rem4_m)] <- imp
# sub_com[, -(1:6)] <- rem4_m
cf0<-cbind(sub_com[,1:6],rem4_m)%>%as.data.frame()
cf0[grep("SCA_149",cf0$DIA_ID),4]<-"770666-2"
cf0[grep("SCA_150",cf0$DIA_ID),4]<-"770666-2"
cf0[grep("SCA_1$",cf0$DIA_ID),4]<-"811335-2"
cf0[grep("SCA_2$",cf0$DIA_ID),4]<-"811335-2"
a<-table(cf0$patient_ID)%>%as.data.frame()
# tmp<-aggregate(cf0$DIA_ID,by=list(cf0$patient_ID),length)

cf1<-cf0[which(cf0$patient_ID %in% na.omit(unique(cf0$patient_ID[duplicated(cf0$patient_ID)]))),]
cf2<-split(cf0,f=cf0$patient_ID)
pat<-unique(cf1$patient_ID)
difflist<-list()
for (i in 1:length(pat)){
  print(i)
  # i=46
  difflist[[i]]<-cf2[[i]][which(cf2[[i]]$sample_type=="carcinoma"),-c(1:6)] - cf2[[i]][which( cf2[[i]]$sample_type=="adjacent"),-c(1:6)]
}
# cf3<-do.call(rbind,difflist)
cf4<-as.data.frame(cbind(cf0[match(names(cf2),cf0$patient_ID),c(1:6)],(do.call(rbind,difflist))))
write.csv(cf4,"//172.16.13.136/share/members/yuel/2022/tables/20230318_PUH_submatrix_combine_05NA_paired_diff_matrix_v2.csv")
write.csv(cf4,"20230318_PUH_submatrix_combine_05NA_paired_diff_matrix_v2.csv")





df_diff_all <- lapply(seq_along(types_vec), function(i){
  data.frame(
    protein = names_ls[[i]],
    log2FC = fcs[[i]],
    p_t = pValues_t[[i]],
    pAdj_t = pAdjs_t[[i]],
    p_wilcox = pValues_wilcox[[i]],
    pAdj_wilcox = pAdjs_wilcox[[i]]
  )
}) %>%
  setNames(types_vec) %>%
  plyr::ldply(.id = 'organ') %>%
  mutate_at('organ', as.character) %>%
  arrange(organ, protein, pAdj_t)
# rio::export(df_diff_all, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20221226_TPHP_dysregulated_proteins_without_filtering.xlsx')
rio::export(df_diff_all, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_dysregulated_proteins_filter50NAByOrgan.xlsx')

df_diff_all %>% filter(pAdj_t < 0.05, abs(log2FC) > log2(2)) %>% rio::export('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_dysregulated_proteins_filter50NAByOrgan_DEPsOnly.xlsx')

# df_diff_all %>% filter(protein == 'P78367')
# df_diff_all %>% filter(protein == 'Q8WZ60')
'P78367'
'Q8WZ60'
df_diff_all %>% filter(protein == 'P11387')


df_diff_all %>% filter(protein == 'Q96CG3')
df_diff_all %>% filter(protein == 'Q15910')
df_diff_all %>% filter(protein == 'P56282')



# use adjusted t-test (paired, two-tailed)
pValues <- pAdjs_t
# Step2: plotting figures
pdf(pdfPath, width = 50, height = 30)###################
par(mfrow=c(3, 5))##################
for(i in 1:length(types_vec)){
  fc <- fcs[[i]]; pValue <- pValues[[i]]
  if(length(fc) == 0 | length(pValue) == 0){
    next
  }
  # plotting
  strTitle <- paste0(main_volcano_title, ': ', types_vec[i])
  plot(fc, -log10(pValue), col = '#00000033', pch = 19,xlab = 'log2(FC)', ylab = '-log10(Adjusted P)', main = strTitle)
  abline(h = 1.3, v = c(-log2(cutoff_fc),log2(cutoff_fc)), lty = 2, lwd = 1)
  up  <- fc >= log2(cutoff_fc) & pValue <= cuttoff_p
  points(fc[up], -log10(pValue[up]), col = 1,bg = brewer.pal(9,"YlOrRd")[6], pch = 21, cex = 2)
  down <- fc <= -log2(cutoff_fc) & pValue <= cuttoff_p
  points(fc[down], -log10(pValue[down]), col = 1,bg = brewer.pal(11,"RdBu")[9], pch = 21, cex = 2)
}
dev.off()

# Step3: write tables
for(i in 1:length(types_vec)){
  fc <- fcs[[i]]; pValue <- pValues[[i]]
  if(length(fc) == 0 | length(pValue) == 0){
    next
  }
  
  outFile <- paste0(main_tsv_name, types_vec[i], '.xlsx')
  
  up  <- fc >= log2(cutoff_fc) & pValue <= cuttoff_p
  down <- fc <= -log2(cutoff_fc) & pValue <= cuttoff_p
  name <- list(up = data.frame(prot = names_ls[[i]][up],fc = fc[up], p_value = pValue[up],
                               type = rep("Upregulation", sum(up)),stringsAsFactors=F),
               down = data.frame(prot = names_ls[[i]][down],fc = fc[down], p_value = pValue[down],
                                 type = rep("Downregulation",sum(down)),stringsAsFactors=F),
               all=data.frame(prot=names(fc),fC=fc,p_value=pValue))
  
  
  if( !is.null(outFile) ){
    write_xlsx(name,outFile)
  }
}


# #c/adj fc matrix
# si_pm_ca4<-si_pm_ca3
# sum(duplicated(si_pm_ca4$patient_ID))
# si_pm_ca4$patient_ID[grepl("770666",si_pm_ca3$patient_ID)&grepl("SCA_149|SCA_150",si_pm_ca3$DIA_ID)]<-"770666-2"
# si_pm_ca4$patient_ID[grepl("811335",si_pm_ca3$patient_ID)&grepl("SCA_1|SCA_2",si_pm_ca3$DIA_ID)]<-"811335-2"
# plist<-split(si_pm_ca4,f = si_pm_ca4$patient_ID)
# flist<-sapply(plist, function(v){
#   v[which(v$cancer_type=="carcinoma"),-c(1:5)]-v[which(v$cancer_type=="adjacent"),-c(1:5)]
# })
# dim(flist)#11404   508
# colnames(flist)<-names(plist)



```

## CA clustering
```{r}
library(tidyverse)
library(magrittr)
library(readxl)
library(writexl)
library(plyr)
library(Rtsne)
library(RColorBrewer)

sub_com <- rio::import('//172.16.13.136/share/members/yuel/2022/tables/20230318_PUH_submatrix_combine_5_missing.csv')
sub_com[str_detect(sub_com$organ, 'cervi'), 'organ'] <- 'cervix uteri'


# #get abbreviations
# df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
# h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
# sub_com$organ <- sapply(sub_com$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))
# 
# # CHANGE TO CANCER NAME
# ht_organ2cancer <- c('GBM', 'COCA', 'CESC', 'ESCA', 'FTCA', 'GBCA', 'RC', 'HCC', 'DLBCL', 'THYM', 'LUCA', 'BRCA', 'MUT', 'OC', 'PACA', 'PECA', 'PRCA', 'READ', 'GIST', 'GC', 'TGCT', 'LARCA', 'THCA', 'TOCA', 'ENCA')
# names(ht_organ2cancer) <- c('CE', 'CO', 'CU', 'ESO', 'FT', 'GB', 'KI', 'LI', 'LN', 'LTH', 'LU', 'MAG', 'MU', 'OV', 'PA', 'PEN', 'PR', 'REC', 'SI', 'ST', 'TE', 'THR', 'THY', 'TON', 'UTE')
# sub_com$organ <- ht_organ2cancer[sub_com$organ]

ht_organ2cancer <- c('Glioblastoma', 'Cervical carcinoma', 'Colon carcinoma', 'Esophageal carcinoma', 'Fallopian tube carcinoma', 'Gallbladder carcinoma', 'Renal carcinoma', 'Hepatocellular carcinoma', 'Lung carcinoma', 'Diffused large B-cell carcinoma', 'Breast carcinoma', 'Muscle tumor', 'Ovarian carcinoma', 'Pancreas carcinoma', 'Male genitalia carcinoma', 'Prostate carcinoma', 'Rectum carcinoma', 'Gastrointestinal stromal tumors', 'Gastric carcinoma', 'Testis carcinoma', 'Laryngocarcinoma', 'Thymoma and thymic carcinoma', 'Thyroid carcinoma', 'Tongue carcinoma', 'Endometrial carcinoma')
names(ht_organ2cancer) <- c('brain', 'cervix uteri', 'colon', 'esophagus', 'fallopian tube', 'gall bladder', 'kidney', 'liver', 'lung', 'lymph node', 'mammary gland', 'muscle', 'ovary', 'pancreas', 'penis', 'prostate', 'rectum', 'small intestine', 'stomach', 'testis', 'throat', 'thymus', 'thyroid', 'tongue', 'uterus')
sub_com$organ <- ht_organ2cancer[sub_com$organ]

sub_com$sample_type %<>% str_to_sentence()
sub_com$tissue_name %<>% str_to_sentence()


# draw tsne for matrices generated using different NA cutoff
# colors<-read_xlsx("D:/data/1project/TPL/2022/figure/PUH_tissue_colorset.xlsx")
ge.plot.tsne<-function(data,type,title="",label=NULL){
  col2<-rep(brewer.pal(9,"Set1")[1:9],3)[1:25]
  cl <- data.frame(col2,row.names =unique(type),stringsAsFactors = F)
  cl2 <- cl[match(type,row.names(cl)),1]
  set2<-c(rep(0,times=9),
          rep(2,times=9),
          rep(4,times=7))
  st <- data.frame(set2,row.names =unique(type),stringsAsFactors = F)
  st2<-st[match(type,row.names(cl)),1]
  df10 <- data
  df10[is.na(df10)] <- 0 #
  df10 <- t(apply(df10, 1, scale))  #
  colnames(df10) <- type
  tsne <- Rtsne(t(df10), dims = 2, perplexity = (ncol(data)-1)/3-1, verbose = T , check_duplicates = FALSE)
  pdf(paste0(title,"_TSNE.pdf"),height = 7,width = 10)
  if(is.null(label)){
    par(mai=c(0.4,0.5,0.2,2.4))
    plot(tsne$Y,col=cl2, main = "tsne", pch =st2,cex=0.6,cex.axis=2,cex.lab=2)
    legend(x=5.1,y=5,legend=row.names(cl),pch=set2, cex=0.8,pt.cex=1,col=cl$col2,ncol=1,xpd=T,
           x.intersp=0.5,bty='n')
  }else{
    plot(tsne$Y,col=cl2, main = "tsne", pch = 20,cex=2,cex.axis=2,cex.lab=2,xlab='t-SNE 1',ylab='t-SNE 2')
    text(tsne$Y,pos = 1, labels = label, col= "DimGrey",cex = 0.8)
    legend("topright",legend=row.names(cl), fill=cl$col2, lty=1,lwd=1)
  }
  dev.off()
  
  
  return(tsne$Y)
}
ge.plot.tsne_tissue_name <- function(data,type,title="",label=NULL){
  col2<-rep(brewer.pal(9,"Set1")[1:9],4)[1:length(unique(type))]
  cl <- data.frame(col2,row.names =unique(type),stringsAsFactors = F)
  cl2 <- cl[match(type,row.names(cl)),1]
  set2<-c(rep(0,times=9),
          rep(2,times=8),
          rep(3,times=8),
          rep(4,times=8))
  st <- data.frame(set2,row.names =unique(type),stringsAsFactors = F)
  st2<-st[match(type,row.names(cl)),1]
  df10 <- data
  df10[is.na(df10)] <- 0 #
  df10 <- t(apply(df10, 1, scale))  #
  colnames(df10) <- type
  tsne <- Rtsne(t(df10), dims = 2, perplexity = (ncol(data)-1)/3-1, verbose = T , check_duplicates = FALSE)
  pdf(paste0(title,"_TSNE.pdf"),height = 7,width = 10)
  if(is.null(label)){
    par(mai=c(0.4,0.5,0.2,2.4))
    plot(tsne$Y,col=cl2, main = "tsne", pch =st2,cex=0.6,cex.axis=2,cex.lab=2)
    legend(x=5.1,y=5,legend=row.names(cl),pch=set2, cex=0.8,pt.cex=1,col=cl$col2,ncol=1,xpd=T,
           x.intersp=0.5,bty='n')
  }else{
    plot(tsne$Y,col=cl2, main = "tsne", pch = 20,cex=2,cex.axis=2,cex.lab=2,xlab='t-SNE 1',ylab='t-SNE 2')
    text(tsne$Y,pos = 1, labels = label, col= "DimGrey",cex = 0.8)
    legend("topright",legend=row.names(cl), fill=cl$col2, lty=1,lwd=1)
  }
  dev.off()
  
  
  return(tsne$Y)
}
ge.plot.tsne_sample_type<-function(data,type,title="",label=NULL){
  col2<-rep(brewer.pal(9,"Set1")[1:9],3)[1:length(unique(type))]
  cl <- data.frame(col2[1:length(unique(type))],row.names =unique(type),stringsAsFactors = F)
  cl2 <- cl[match(type,row.names(cl)),1]
  set2<-c(rep(0,times=9),
          rep(2,times=9),
          rep(4,times=7))
  st <- data.frame(set2[1:length(unique(type))],row.names =unique(type),stringsAsFactors = F)
  st2<-st[match(type,row.names(cl)),1]
  df10 <- data
  df10[is.na(df10)] <- 0 #
  df10 <- t(apply(df10, 1, scale))  #
  colnames(df10) <- type
  tsne <- Rtsne(t(df10), dims = 2, perplexity = (ncol(data)-1)/3-1, verbose = T , check_duplicates = FALSE)
  pdf(paste0(title,"_TSNE.pdf"),height = 7,width = 10)
  if(is.null(label)){
    par(mai=c(0.4,0.5,0.2,2.4))
    plot(tsne$Y,col=cl2, main = "tsne", pch =st2,cex=0.6,cex.axis=2,cex.lab=2)
    legend(x=5.1,y=5,legend=row.names(cl),pch=set2, cex=0.8,pt.cex=1,col=cl$col2,ncol=1,xpd=T,
           x.intersp=0.5,bty='n')
  }else{
    plot(tsne$Y,col=cl2, main = "tsne", pch = 20,cex=2,cex.axis=2,cex.lab=2,xlab='t-SNE 1',ylab='t-SNE 2')
    text(tsne$Y,pos = 1, labels = label, col= "DimGrey",cex = 0.8)
    legend("topright",legend=row.names(cl), fill=cl$col2, lty=1,lwd=1)
  }
  dev.off()
  
  
  return(tsne$Y)
}
# # setwd("D:/data/1project/TPL/2022/tables/missing_test_sunmatrix")
# # for (i in 1:length(file)){
# # i=1
# set.seed(9)
# # data<-read.csv("20230223_PUH_submatrix_combine_5_missing_v2.csv",row.names = "X")
# data<-sub_com
# t="20230224_PUH_submatrix_combine_05_missing_v2"
# 
# label<-paste(data[,2:4],collapse = "_")
# 
# type<-data$organ
# df<-t(data[,-c(1:7)])
# # dim(df)#11694 probes
# tsne<-ge.plot.tsne(df,type=type,title=t)
# # }
# # umap<-ge.plot.umap(df,type=type,title=t)
# 
# # b<-c(rep('a',times=10),rep('b',times=10),rep('c',times=10),rep('d',times=10),rep('e',times=10),rep('f',times=10))
# # c<-unique(type)
# # c<-c[order(c)]
# # 
# # table<-data.frame(b[1:length(c)])
# # rownames(table)<-c
# # 
# 
# t<-"20230223_PUH_submatrix_combine_5_missing_tissue_name"
# type<-data$tissue_name
# # dim(df)#11694 probes
# 
# 
# # t<-"20230223_PUH_submatrix_combine_5_missing_sample_type"
# # type<-data$sample_type
# # # dim(df)#11694 probes
# # tsne2<-ge.plot.tsne_tissue_name(df,type=type,title=t)
# 

# use organ
set.seed(9)
data<-sub_com
t="20230519_PUH_submatrix_combine_05_missing_v2"
label<-paste(data[,1:3],collapse = "_")
type<-data$organ
df<-t(data[,-c(1:6)])
# dim(df)#11694 probes
tsne<-ge.plot.tsne(df,type=type,title=t)


# use tissue_name
set.seed(9)
data<-sub_com
t="20230519_PUH_submatrix_combine_05_missing_v2_tissuename"
label<-paste(data[,1:3],collapse = "_")
type<-data$tissue_name
df<-t(data[,-c(1:6)])
# dim(df)#11694 probes
tsne<-ge.plot.tsne_tissue_name(df,type=type,title=t)


# use sample_type
set.seed(9)
data<-sub_com
t="20230519_PUH_submatrix_combine_05_missing_v2_sampletype"
label<-paste(data[,1:3],collapse = "_")
type<-data$sample_type
df<-t(data[,-c(1:6)])
# dim(df)#11694 probes
tsne<-ge.plot.tsne_sample_type(df,type=type,title=t)




# unload environment
pacman::p_unload(pacman::p_loaded(), character.only = T)
library(tidyverse)
library(magrittr)
```



# 2023-03-18 TPHP dysregulated protein numbers
```{r}
library(tidyverse)
library(magrittr)
library(RColorBrewer)
setwd("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr")

file_ls <- list.files('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr',
           pattern = '^20230318_CA_ADJ_volcanoplot.*\\.xlsx$', full.names = T)

organs <- str_extract(file_ls, '05p_.+\\.xlsx') %>%
  str_replace('05p_', '') %>% str_replace('\\.xlsx', '')
organs[2]
organs[2] == 'cervix uteri'
organs[2] <- 'cervix uteri'

ht_organ2cancer <- c('Glioblastoma', 'Cervical carcinoma', 'Colon carcinoma', 'Esophageal carcinoma', 'Fallopian tube carcinoma', 'Gallbladder carcinoma', 'Renal carcinoma', 'Hepatocellular carcinoma', 'Lung carcinoma', 'Diffused large B-cell carcinoma', 'Breast carcinoma', 'Muscle tumor', 'Ovarian carcinoma', 'Pancreas carcinoma', 'Male genitalia carcinoma', 'Prostate carcinoma', 'Rectum carcinoma', 'Gastrointestinal stromal tumors', 'Gastric carcinoma', 'Testis carcinoma', 'Laryngocarcinoma', 'Thymoma and thymic carcinoma', 'Thyroid carcinoma', 'Tongue carcinoma', 'Endometrial carcinoma')
names(ht_organ2cancer) <- c('brain', 'cervix uteri', 'colon', 'esophagus', 'fallopian tube', 'gall bladder', 'kidney', 'liver', 'lung', 'lymph node', 'mammary gland', 'muscle', 'ovary', 'pancreas', 'penis', 'prostate', 'rectum', 'small intestine', 'stomach', 'testis', 'throat', 'thymus', 'thyroid', 'tongue', 'uterus')


tbl1_ls <- lapply(file_ls, readxl::read_excel, sheet = 1)
tbl2_ls <- lapply(file_ls, readxl::read_excel, sheet = 2)

for(i in seq_along(file_ls)){
  df_up <- tbl1_ls[[i]]
  df_down <- tbl2_ls[[i]]
  df_tmp <- rbind(df_up, df_down) %>% count(type)
  print(df_tmp)
}

stat_ls <- lapply(seq_along(file_ls), function(i){
  df_up <- tbl1_ls[[i]]
  df_down <- tbl2_ls[[i]]
  df_tmp <- rbind(df_up, df_down) %>% count(type)
})
names(stat_ls) <- ht_organ2cancer[organs]
df_stat <- plyr::ldply(stat_ls, function(dfsub){
  dfsub
}, .id = 'organ')
df_stat[df_stat$type == 'Downregulation', 'n'] <- -df_stat[df_stat$type == 'Downregulation', 'n']

colnames(df_stat)[2] <- 'Type' #  organ           type    n
df_stat_long <- df_stat %>%
  mutate(Type = factor(Type, levels = c('Upregulation', 'Downregulation'), ordered = T)) %>%
  pivot_wider(Type, names_from = 'organ', values_from = 'n') %>%
  arrange(Type) %>%
  mutate_if(is.numeric, abs)

df_stat_long %>% rio::export('TPHP_carcinoma_dysregulated_proteins_20230318.xlsx')


p <- ggplot(df_stat, aes(x=organ, y=n, fill = Type)) + geom_bar(stat="identity", width=0.9, position="stack")


p <- p +
  scale_fill_manual(values = c(Upregulation = "#AB2947", Downregulation = "#17B544"))+
  labs(
    y = "Protein number",
    title = 'Carcinoma dysregulated proteins'
  )+
  guides(fill=guide_legend(nrow = 1))+
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text = element_text(size = 12,color = "black"),
        axis.line = element_line(colour = "black"),
        axis.line.x = element_blank(),
        plot.subtitle = element_text(size = 10, hjust = 0, color="black")
  )+
  theme(legend.text = element_text(size = 10, color = "black"),legend.position = 'bottom',
        legend.title = element_text(size = 10, color="black"),)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, vjust = 1, hjust = 1, color = "black", angle = 45),
        axis.ticks.x = element_blank()
  )+
  theme(axis.title.y = element_text(size = 10, hjust = 0.5, color="black", angle = 90),
        axis.text.y = element_text(size = 10,color = "black", angle = 0),
        axis.ticks.y = element_blank()
  )

df_stat[df_stat$Type == 'Upregulation', 'vjust_n'] <- 0
df_stat[df_stat$Type == 'Downregulation', 'vjust_n'] <- 1

p <- p + geom_text(aes(label = abs(n)), size = 3.5, hjust = 0.5, vjust = df_stat$vjust_n)
ggsave('TPHP_carcinoma_dysregulated_proteins_20230318.pdf', p, width = 10, height = 4.6)



```


# 2023-03-18 Count the number of dysregulated cancer organs for each protein
up-/down- regulation respectively
```{r}
# search DEP tables
path <- '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr'
fileName <- list.files(path, pattern = '^20230318_CA_ADJ_volcanoplot.*\\.xlsx$')


# get organ names
organ <- str_extract(fileName, '05p_.+\\.xlsx') %>%
  str_replace('05p_', '') %>% str_replace('\\.xlsx', '')
organ[2]
organ[2] == 'cervix uteri' # FALSE
organ[2] <- 'cervix uteri'

#get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
organ <- sapply(organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))


# read all DEP
data <- lapply(fileName, function(e) readxl::read_xlsx(str_c(path, e, sep = '/'), sheet = 1))
names(data) <- organ
up <- plyr::ldply(data, .id = 'organ')
up$organ %<>% as.character()

data <- lapply(fileName, function(e) readxl::read_xlsx(str_c(path, e, sep = '/'), sheet = 2))
names(data) <- organ
down <- plyr::ldply(data, .id = 'organ')
down$organ %<>% as.character()

tmp <- rbind(up, down)
all_pro<-reduce(tmp$prot,union)


# for the up-regulated proteins, how many types of carcinoma upregulated
up_wide <- up %>% select(organ, prot) %>%
  pivot_wider(prot, names_from = organ, values_from = organ) %>%
  column_to_rownames('prot') %>% as.data.frame()
up_wide[!is.na(up_wide)] <- T
up_wide[is.na(up_wide)] <- F
up_wide %<>% mutate_each(as.logical)
up_wide %<>% add_column(`Carcinoma upregulated in n/25 types` = apply(up_wide, 1, sum), .before = 1) %>%
  arrange(`Carcinoma upregulated in n/25 types`) %>% rownames_to_column('Protein')


# for the down-regulated proteins, how many types of carcinoma downregulated
down_wide <- down %>% select(organ, prot) %>%
  pivot_wider(prot, names_from = organ, values_from = organ) %>%
  column_to_rownames('prot') %>% as.data.frame()
down_wide[!is.na(down_wide)] <- T
down_wide[is.na(down_wide)] <- F
down_wide %<>% mutate_each(as.logical)
down_wide %<>% add_column(`Carcinoma downregulated in n/25 types` = apply(down_wide, 1, sum), .before = 1) %>%
  arrange(`Carcinoma downregulated in n/25 types`) %>% rownames_to_column('Protein')


list(up = up_wide, down = down_wide) %>%
  rio::export('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/TPHP_dysregulated_organ_number_sheet1_up_sheet2_down_20230318.xlsx')


```


# CA_ADJ_dys_chord_diagram
```{r}
# CA/ADJ Dysregulated proteins analysis
library(readxl)
library(stringr)
library(tidyverse)
library(RColorBrewer)
library(circlize)

setwd("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr")
data<-list()
path = "."
fileName = list.files(pattern = '^20230318_CA_ADJ_volcanoplot.*\\.xlsx$')
for(k in 1:length(fileName)){
  data[[k]] = read_xlsx( path = paste("./",fileName[k],sep = ""),sheet = 1)}
organ <- str_extract(fileName, '05p_.+\\.xlsx') %>%
  str_replace('05p_', '') %>% str_replace('\\.xlsx', '')
organ[2] <- 'cervix uteri'
# ht_organ2cancer <- c('Glioblastoma', 'Cervical carcinoma', 'Colon carcinoma', 'Esophageal carcinoma', 'Fallopian tube carcinoma', 'Gallbladder carcinoma', 'Renal carcinoma', 'Hepatocellular carcinoma', 'Lung carcinoma', 'Diffused large B-cell carcinoma', 'Breast carcinoma', 'Muscle tumor', 'Ovarian carcinoma', 'Pancreas carcinoma', 'Male genitalia carcinoma', 'Prostate carcinoma', 'Rectum carcinoma', 'Gastrointestinal stromal tumors', 'Gastric carcinoma', 'Testis carcinoma', 'Laryngocarcinoma', 'Thymoma and thymic carcinoma', 'Thyroid carcinoma', 'Tongue carcinoma', 'Endometrial carcinoma')
# names(ht_organ2cancer) <- c('brain', 'cervix uteri', 'colon', 'esophagus', 'fallopian tube', 'gall bladder', 'kidney', 'liver', 'lung', 'lymph node', 'mammary gland', 'muscle', 'ovary', 'pancreas', 'penis', 'prostate', 'rectum', 'small intestine', 'stomach', 'testis', 'throat', 'thymus', 'thyroid', 'tongue', 'uterus')+
# get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
organ <- sapply(organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))


for (i in 1:length(organ)){
  data[[i]]$organ =organ[i]
}
up<-do.call(rbind,data)


down<-list()
for(k in 1:length(fileName)){
  down[[k]] = read_xlsx( path = paste("./",fileName[k],sep = ""),sheet = 2)}
# organ=str_match(fileName,"_0.05p(.*?).xlsx")[,2]
for (i in 1:length(organ)){
  down[[i]]$organ =organ[i]
}
down_ALL<-do.call(rbind,down)
tmp<-as.data.frame(rbind(up,down_ALL))
all_pro<-reduce(tmp$prot,union)


# up-DEPs
protls_upset <- plyr::dlply(up, 'organ', function(dfsub) dfsub$prot)
pdf('TPHP_CA_ADJ_dys_overlap_upset_top5_up_20230318.pdf', width = 10, height = 5)
print(
  UpSetR::upset(
    UpSetR::fromList(protls_upset),
    order.by = 'freq',# order.by = c('freq', 'degree'),
    mainbar.y.label = 'Protein number',
    # queries = list(
    #   list(query = UpSetR::intersects, params = list('TE', 'UTE', 'MAG', 'CU', 'MU'), color = "orange", active = T, query.name = 'The greatest DEPs intersection of top 5 organs')),
    # query.legend = "top",
    # group.by = "sets",
    # empty.intersections = "on",
    set_size.show = T, number.angles = 0, text.scale = c(1, 1, 1, 1, 1, 1.5)
  )
)
dev.off()

pdf('TPHP_CA_ADJ_dys_overlap_upset_20sets_95intersects_up_20230318.pdf', width = 21.0, height = 29.7, paper = 'a4r')
print(
  UpSetR::upset(
    UpSetR::fromList(protls_upset),
    order.by = 'freq',
    mainbar.y.label = 'Protein number',
    nsets = length(protls_upset), nintersects = 88,
    set_size.show = T, number.angles = 0, text.scale = c(1, 1, 1, 1, 1, 1)
  )
)
dev.off()


#organ name -> cancer name;
ht_organ2cancer <- c('GBM', 'COCA', 'CESC', 'ESCA', 'FTCA', 'GBCA', 'RC', 'HCC', 'DLBCL', 'THYM', 'LUCA', 'BRCA', 'MUT', 'OC', 'PACA', 'PECA', 'PRCA', 'READ', 'GIST', 'GC', 'TGCT', 'LARCA', 'THCA', 'TOCA', 'ENCA')
names(ht_organ2cancer) <- c('CE', 'CO', 'CU', 'ESO', 'FT', 'GB', 'KI', 'LI', 'LN', 'LTH', 'LU', 'MAG', 'MU', 'OV', 'PA', 'PEN', 'PR', 'REC', 'SI', 'ST', 'TE', 'THR', 'THY', 'TON', 'UTE')
up$organ <- ht_organ2cancer[up$organ]
up %<>% arrange(organ)

up_wide <- up %>% pivot_wider(id_cols = 'prot', names_from = 'organ', values_from = 'type')
up_n <- apply(up_wide, 1, function(x) sum(!is.na(x[-1])))
table(up_n)
#    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15 
# 2038 1334  843  634  501  429  292  222  167  112   64   40   11    4    1 
plot(table(up_n), type = 'b', xlab = 'Upregulated in n organs', ylab = '# Protein')
# ggplot style
df_line <- data.frame(n_organ = as.numeric(names(table(up_n))), n_protein = as.vector(table(up_n)))

p <- ggplot(df_line) +
  aes(x = n_organ, y = n_protein) +
  geom_line(size = 1, color = "#EF562D") +
  geom_point(size = 2, color = "#000000") +
  geom_text(aes(label = n_protein), vjust = -0.5, hjust = 0) +
  labs(x = 'Upregulated in n organs', y = '# Protein') +
  theme_minimal() +
  theme_bw() +
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        # axis.line = element_line(colour = 'black'),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        axis.title.x = element_text(size = 10, vjust = 0.5 ,color = 'black', angle = 0),
        axis.text.x = element_text(size = 8, vjust = 0.5 ,color = 'black', angle = 0),
        axis.text.y = element_text(size = 8, vjust = 0.5 ,color = 'black', angle = 0),
        # axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(size = 10, vjust = 0.5 ,color = 'black', angle = 90),
        # axis.text.y = element_blank(),
        axis.ticks.y = element_blank()
  )
ggsave('TPHP_DEP_up_organ_overlap_20230318.pdf', p, width = 5, height = 2)
rio::export(df_line, 'TPHP_DEP_up_organ_overlap_20230318.xlsx')

quantile(up_n)
# 0%  25%  50%  75% 100% 
#  1    1    2    5   15 
up12 <- up_wide[up_n >= 12, ]
up12_long <- up12 %>%
  pivot_longer(cols = -prot, names_to = 'organ', values_to = 'type', values_drop_na = T) %>% 
  semi_join(up, .)

organ_order <- up12_long %>% count(organ) %>% arrange(desc(n)) %>% pull(organ) %>% unname()
up12 %<>% select(prot, all_of(organ_order))

up12_fc <- up12 %>% column_to_rownames('prot') %>% as.matrix()
up12_fc[!is.na(up12_fc)] <- 1
up12_fc <- apply(up12_fc, 1:2, as.numeric)
for(x in rownames(up12_fc)){
  for(y in colnames(up12_fc)){
    if(!is.na(up12_fc[x, y])){
      up12_fc[x, y] <- up12_long %>% filter(prot == all_of(x), organ == all_of(y)) %>% pull(fc)
    }
  }
}
# colnames(up12_fc) %>% writeClipboard()
# up12_fc %<>% arrange(desc(BRCA), desc(CESC), desc(ENCA), desc(MUT), desc(OC), desc(TOCA), desc(TGCT), desc(READ), desc(PECA), desc(LARCA), desc(GBCA), desc(DLBCL), desc(THCA), desc(LUCA), desc(HCC), desc(GC), desc(COCA), desc(PACA), desc(GBM), desc(GIST))
up12_fc %<>% as.data.frame() %>% arrange(across(everything(), desc))


up12_long$prot <- factor(up12_long$prot, levels = rev(rownames(up12_fc)), ordered = T)
up12_long$organ <- factor(up12_long$organ, levels = organ_order, ordered = T)
up12_long %<>% arrange(prot, organ)



#uniprot -> uniprot_genename
df_uniprot <- rio::import('Y:/members/jiangwenhao/TPHP/20220908/drug/uniprot/uniprot-download_true_fields_accession_2Cid_2Cprotein_name_2Cgene_na-2022.09.21-14.18.23.22.xlsx')
df_uniprot12 <- df_uniprot %>% filter(Entry %in% up12_long$prot)
up12_long <- df_uniprot12 %>%
  rename(prot = Entry) %>% 
  mutate(gene = str_remove(`Entry Name`, '_HUMAN$')) %>% 
  mutate(label = str_c(prot, gene, sep = '_')) %>% 
  select(prot, label) %>%
  inner_join(up12_long, .)

up12_long$label <- factor(up12_long$label, levels = unique(up12_long$label), ordered = T)


# library(ggplot2)
# library(RColorBrewer)
up12_long %<>% rename(log2FC = fc, padj = p_value)
up12_long$color <- -log10(up12_long$padj)
up12_long$size <- up12_long$log2FC
p <- ggplot(up12_long, aes(x = organ, y = label))+
  geom_point(aes(size = size, color = color), alpha=1) +
  labs(x = 'Protein', y = 'Cancer name') +
  # scale_color_continuous(
  #   name = 'padj', low = brewer.pal(9, 'OrRd')[4], high = brewer.pal(9, 'OrRd')[9]
  # ) +
  scale_colour_gradientn(
    name = 'padj',
    colors = c(brewer.pal(9, 'OrRd')[2],
               colorRampPalette(c(brewer.pal(9, 'OrRd')[4], brewer.pal(9, 'OrRd')[9]))(8)),
    limits = c(1, 8),
  ) + 
  # scale_radius(range = c(1, 4.8), name = 'log2FC') +
  scale_size(range = c(.1, 2), limits=c(floor(quantile(up12_long$size)[1]), ceiling(quantile(up12_long$size)[5])), name = 'log2FC') +
  guides(
    color = guide_colorbar(order = 1),
    size = guide_legend(order = 2)
  ) +
  ggtitle("DEPs upregulated in at least 12 kinds of cancer") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        # axis.line = element_line(colour = 'black'),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 6, vjust = 0.5 ,color = 'black', angle = 45),
        axis.text.y = element_text(size = 6, vjust = 0.5 ,color = 'black', angle = 0),
        # axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        # axis.text.y = element_blank(),
        axis.ticks.y = element_blank()
  )
ggsave('TPHP_DEP_up_atleast12_organ_20230318.pdf', p, width = 21.0, height = 29.7, units = 'cm')

dfprot <- rio::import('//172.16.13.136/TPHP/TPL/libs/20220616_fraglib/protein.tsv')

up12_fc %>%
  rownames_to_column('prot') %>%
  left_join(dfprot %>% select(`Protein ID`, Gene, `Entry Name`, `Protein Description`), by = c(prot = 'Protein ID')) %>% 
  right_join(up12_long %>% select(prot, label) %>% distinct(), .) %>%
  slice(nrow(.):1) %>% 
  rio::export('TPHP_DEP_up_atleast12_organ_20230318.xlsx')


# DEPs
protls_upset <- plyr::dlply(tmp, 'organ', function(dfsub) dfsub$prot)
pdf('TPHP_CA_ADJ_dys_overlap_upset_top5_20230318.pdf', width = 10, height = 5)
print(
  UpSetR::upset(
    UpSetR::fromList(protls_upset),
    order.by = 'freq',# order.by = c('freq', 'degree'),
    mainbar.y.label = 'Protein number',
    # queries = list(
    #   list(query = UpSetR::intersects, params = list('TE', 'UTE', 'MAG', 'CU', 'MU'), color = "orange", active = T, query.name = 'The greatest DEPs intersection of top 5 organs')),
    # query.legend = "top",
    # group.by = "sets",
    # empty.intersections = "on",
    set_size.show = T, number.angles = 0, text.scale = c(1, 1, 1, 1, 1, 1.5)
  )
)
dev.off()

# # Regards cervix as uterus
# protls_upset$UTE <- union(protls_upset$UTE, protls_upset$CU)
# protls_upset$CU <- NULL
# protls_upset$LAI <- union(protls_upset$CO, protls_upset$REC)
# protls_upset$CO <- protls_upset$REC <- NULL

pdf('TPHP_CA_ADJ_dys_overlap_upset_20sets_88intersects_20230318.pdf', width = 21.0, height = 29.7, paper = 'a4r')
print(UpSetR::upset(UpSetR::fromList(protls_upset), order.by = 'freq', nsets = length(protls_upset), nintersects = 95, set_size.show = T))
dev.off()






drug<-read.delim("//172.16.13.114/share/members/yuel/1project/0_TPHP/3_tables/protein_class_Disease_HPA_20220714.tsv",sep="\t",header = T)#4514
length(unique(drug$Uniprot))#4485
fda<-read.delim("//172.16.13.114/share/members/yuel/1project/0_TPHP/3_tables/protein_class_FDA_HPA_20220714.tsv",sep="\t",header = T)#812
length(unique(fda$Uniprot))#809

#cell location

libs <- c('stringr', 'magrittr', 'dplyr', 'readxl', 'writexl', 'hash')
sapply(libs, require, character.only=TRUE)
table(sapply(libs, require, character.only=TRUE))
# rm(list = ls())

# read HPA protein lists
df1 <- read.delim('//172.16.13.114/share/members/jiangwenhao/TPHP/tissue_enriched_localization/data/Intracellular_12631.tsv', stringsAsFactors = F, check.names = F)
df2 <- read.delim('//172.16.13.114/share/members/jiangwenhao/TPHP/tissue_enriched_localization/data/Membrane_5331.tsv', stringsAsFactors = F, check.names = F)
df3 <- read.delim('//172.16.13.114/share/members/jiangwenhao/TPHP/tissue_enriched_localization/data/Secreted_1519.tsv', stringsAsFactors = F, check.names = F)
df4 <- read.delim('//172.16.13.114/share/members/jiangwenhao/TPHP/tissue_enriched_localization/data/Membrane&secreted_isoforms_189.tsv', stringsAsFactors = F, check.names = F)

df_intra <- data.frame(protein = unique(df1$Uniprot), classification = 'Intracellular')
df_mem <- data.frame(protein = unique(df2$Uniprot), classification = 'Membrane')
df_secr <- data.frame(protein = unique(df3$Uniprot), classification = 'Secreted')
df_memNsecr <- data.frame(protein = unique(df4$Uniprot), classification = 'Membrane_and_secreted_isoforms')

# generate has table
df_all <- rbind(df_intra, df_mem, df_secr, df_memNsecr) %>% dplyr::filter(protein != '')
ht <- hash(keys = df_all$protein,
           values = df_all$classification)


# generate result
df_tmp <- data.frame(protein = all_pro)
df_tmp$classification <- sapply(df_tmp$protein, function(e){
  if(is.null(ht[[e]])){
    return('Not_found')
  }else{
    return(ht[[e]])
  }
})
table(df_tmp$classification)
rownames(df_tmp)<-df_tmp$protein


#chord plot
tmp$loc<-df_tmp[tmp$prot,]$classification
tmp1<-aggregate(tmp$prot,by=list(tmp$organ,tmp$loc),length)
# t0<-data.frame(orig_reg=tmp1$Group.1,
#                dest_reg=tmp1$Group.2,
#                color=tmp1$Group.3,
#                flow=tmp1$x)
t0<-data.frame(orig_reg=tmp1$Group.1,
               dest_reg=tmp1$Group.2,
               flow=tmp1$x)
all_re<-c(unique(t0$orig_reg),unique(t0$dest_reg))
# tmp1<-aggregate(tmp$prot,by=list(tmp$organ,tmp$loc),length)
t1<-data.frame(region=all_re,
               order=c(1:length(all_re)),
               col= c(brewer.pal(n = 8,name = "Set3"),
                      brewer.pal(n = 8,name = "Set2"),
                      brewer.pal(n = 8,name = "Set1"),"#CCCCFF"))
linkcolor<-brewer.pal(5,"Set1")
tt<-pivot_wider(t0,names_from = "dest_reg",values_from = "flow")
tt1<-tt[,-1]
rownames(tt1)<-tt$orig_reg
# linkcolor<-
chordDiagram(x = t0,
            directional = -1,
            order = t1$region,
            grid.col = t1$col, #
            col = t1$col[],
            # transparency = 0.7,
            annotationTrack = "grid",#diylabelaxis
            transparency = 0.25,#
            annotationTrackHeight = c(0.05, 0.1),#
            direction.type = c("diffHeight","arrows"),
            link.arr.type = "big.arrow",
            diffHeight  = -0.04#
)
# circos.track(track.index = 1, bg.border = NA,
#              panel.fun = function(x, y) {
#                xlim = get.cell.meta.data("xlim")
#                sector.index = get.cell.meta.data("sector.index")
#                reg1 = t1 %>% filter(region == sector.index) %>% pull(reg1)
#                reg2 = t1 %>% filter(region == sector.index) %>% pull(reg2)
#                circos.text(x = mean(xlim), y = ifelse(is.na(reg2), 3, 4),labels = reg1, facing = "bending", cex =0.8)
#                circos.text(x = mean(xlim), y = 2.75, labels = reg2, facing = "bending", cex = 0.8)
#                circos.axis(h = "top", labels.cex = 0.6,labels.niceFacing = FALSE, labels.pos.adjust = FALSE)
#              })


#########-------20220715-----#################
#between organs
cn<-combn(organ,2)
names(data)<-organ
names(down)<-organ
c0<-apply(cn,2, function(v){
  # v=cn[,1]
  # or1<-v[1]
  # or2<- v[2]
  up1<-length(intersect(data[[v[1]]]$prot,data[[v[2]]]$prot))
  down1<-length(intersect(down[[v[1]]]$prot,down[[v[2]]]$prot))
  c(v[1],v[2],up1+down1)
}) %>% t()%>%as.data.frame()
colnames(c0)<-c("orig_reg","dest_reg","flow")
c0$flow<-as.numeric(c0$flow)
hist(c0$flow)
test<-c0[c0$flow>500,]#113

all_re<-organ
# tmp1<-aggregate(tmp$prot,by=list(tmp$organ,tmp$loc),length)
t1<-data.frame(region=all_re,
               order=c(1:length(all_re)),
               col= c(brewer.pal(n = 12,name = "Set3"),
                      brewer.pal(n = 8,name = "Set2"),
                      brewer.pal(n = 5,name = "Set1")),
               reg1 = str_match(all_re, "(.*?) ")[,2],
               reg2 = str_match(all_re, "[ ](.*?)$")[,2] )
t1[t1$region=="cervix_uteri",4:5]<-c("cervix","uteri")
t1$reg1[is.na(t1$reg1)]<-t1$region[is.na(t1$reg1)]

pdf('TPHP_CA_ADJ_dys_chordDiagram_20organs.pdf', width = 20, height = 20)
circos.clear()
chordDiagram(x = c0,
             directional = 0,
             order = t1$region,
             grid.col = t1$col, #
             # col = linkcolor,
             # transparency = 0.7,
             annotationTrack = "grid",#diylabelaxis
             transparency = 0.25,#
             annotationTrackHeight = c(0.05, 0.1),#
             diffHeight  = -0.04#
)

circos.track(track.index = 1, bg.border = NA,
             panel.fun = function(x, y) {
               xlim = get.cell.meta.data("xlim")
               sector.index = get.cell.meta.data("sector.index")
               reg1 = t1 %>% filter(region == sector.index) %>% pull(reg1)
               reg2 = t1 %>% filter(region == sector.index) %>% pull(reg2)
               circos.text(x = mean(xlim), y = ifelse(is.na(reg2), 2, 3),labels = reg1, facing = "inside", cex =2)
               circos.text(x = mean(xlim), y = 1.75, labels = reg2, facing = "inside", cex =2)
               circos.axis(h = "top", labels.cex = 1.2,labels.niceFacing = FALSE, labels.pos.adjust = FALSE)
             })
dev.off()

# pro.list<-split(tmp$prot,f = tmp$organ)
# unique<-Reduce(setdiff, pro.list)
# organ_uni<-sapply(1:length(organ), function(v){
#   # v=organ[1]
#   # v=1
#   li<-c(pro.list[v],pro.list[-v])
#   uni<-Reduce(setdiff,li)
# })
# c1<-data.frame(orig_reg =organ,
#                dest_reg = organ,
#                flow =lengths(organ_uni))
# c2<-as.data.frame(rbind(c0,c1))
# chordDiagram(x = c2,
#              directional = 0,
#              order = t1$region,
#              grid.col = t1$col, #
#              # col = linkcolor,
#              # transparency = 0.7,
#              annotationTrack = "grid",#diylabelaxis
#              transparency = 0.25,#
#              annotationTrackHeight = c(0.05, 0.1),#
#              diffHeight  = -0.04#
# )
#
# circos.track(track.index = 1, bg.border = NA,
#              panel.fun = function(x, y) {
#                xlim = get.cell.meta.data("xlim")
#                sector.index = get.cell.meta.data("sector.index")
#                reg1 = t1 %>% filter(region == sector.index) %>% pull(reg1)
#                reg2 = t1 %>% filter(region == sector.index) %>% pull(reg2)
#                circos.text(x = mean(xlim), y = ifelse(is.na(reg2), 3, 4),labels = reg1, facing = "inside", cex =0.8)
#                circos.text(x = mean(xlim), y = 2.75, labels = reg2, facing = "inside", cex = 0.8)
#                circos.axis(h = "top", labels.cex = 0.6,labels.niceFacing = FALSE, labels.pos.adjust = FALSE)
#              })
# dev.off()

######################
t0<-data.frame(orig_reg=tmp1$Group.1,
               dest_reg=tmp1$Group.2,
               flow=tmp1$x)
all_re<-c(unique(t0$orig_reg),unique(t0$dest_reg))
# tmp1<-aggregate(tmp$prot,by=list(tmp$organ,tmp$loc),length)
t1<-data.frame(region=all_re,
               order=c(1:length(all_re)),
               col= c(brewer.pal(n = 12,name = "Set3"),
                      brewer.pal(n = 8,name = "Set2"),
                      brewer.pal(n = 9,name = "Set1"),"#CCCCFF"),
               reg1 = str_match(all_re, "(.*?) ")[,2],
               reg2 = str_match(all_re, "[ ](.*?)$")[,2] )
t1[t1$region=="cervix_uteri",4:5]<-c("cervix","uteri")
t1[t1$region=="Membrane_and_secreted_isoforms",4:5]<-c("Membrane and","secreted isoforms")
t1$reg1[is.na(t1$reg1)]<-t1$region[is.na(t1$reg1)]
# linkcolor<-brewer.pal(5,"Set1")
tt<-pivot_wider(t0,names_from = "dest_reg",values_from = "flow")
tt1<-tt[,-1]
rownames(tt1)<-tt$orig_reg
colnames(tt1)<-colnames(tt)[-1]
library(canvasXpress)
pdf('TPHP_CA_ADJ_dys_chordDiagram_20organs_5loc.pdf', width = 20, height = 20)
circos.clear()
chordDiagram(t(tt1),grid.col = t1$col,transparency = 0,annotationTrack = "grid",annotationTrackHeight = c(0.05, 0.1),
             diffHeight  = -0.04)
circos.track(track.index = 1, bg.border = NA,
             panel.fun = function(x, y) {
               xlim = get.cell.meta.data("xlim")
               sector.index = get.cell.meta.data("sector.index")
               reg1 = t1 %>% filter(region == sector.index) %>% pull(reg1)
               reg2 = t1 %>% filter(region == sector.index) %>% pull(reg2)
               circos.text(x = mean(xlim), y = ifelse(is.na(reg2), 2, 3),labels = reg1, facing = "inside", cex =2)
               circos.text(x = mean(xlim), y = 1.75, labels = reg2, facing = "inside", cex = 2)
               circos.axis(h = "top", labels.cex = 1.2,labels.niceFacing = FALSE, labels.pos.adjust = FALSE)
             })
dev.off()
##
# Intracellular
# Membrane
# Membrane and secreted isoforms
# Not found
# Secreted



```

# TOP1 (P11387) expression
## read selected diff-proteins
```{r}
library(tidyverse)
library(magrittr)

source('//172.16.13.136/share/members/jiangwenhao/code/myQC.R')
my_uniprot2prot <- function(vec_uni){
  vec_prot <- lapply(vec_uni, function(uniprotid){
    # my_html <- rvest::read_html(stringr::str_glue('https://www.uniprot.org/uniprotkb/{uniprotid}/entry'))
    my_html <- rvest::read_html(stringr::str_glue('https://rest.uniprot.org/genecentric/{uniprotid}')) # 2022-08-08 update; get json
    my_json <- my_html %>%
      rvest::html_text() %>%
      jsonlite::fromJSON()
    
    prot <- my_json$canonicalProtein$proteinName
    return(prot)
  }) %>% unlist
  return(stringr::str_c(vec_uni, vec_prot, sep = '_'))
}
xlsx_vec <- list.files('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr',
           pattern = '^20230116_CA_ADJ.*\\.xlsx$', full.names = T)
name1_ls <- lapply(xlsx_vec, function(xlsx){
  df1 <- readxl::read_excel(xlsx, sheet = 'up')
  df2 <- readxl::read_excel(xlsx, sheet = 'down')
  ret <- rbind(df1, df2)
  return(ret)
})

names(name1_ls) <- str_extract(xlsx_vec, '0\\.05p.+\\.xlsx$') %>%
  str_replace('^0\\.05p_', '') %>%
  str_replace('\\.xlsx$', '')

c_adj_up_list <- list()
c_adj_down_list <- list()
for (i in 1:length(name1_ls)){
    # c_adj_list <- read.delim(paste(path, "\\", c_adj[i], sep=""),
    # sep = "\t", header = T, stringsAsFactors = F, colClasses = c("character", "NULL", "NULL", "character"))
    c_adj_list <- name1_ls[[i]]
    # c_adj_up, less than 50% missing value
    c_adj_up <- c_adj_list[which(c_adj_list$type == "Upregulation"), 1]
    
    # c_adj_down, less than 50% missing value
    c_adj_down <- c_adj_list[which(c_adj_list$type == "Downregulation"), 1]
    
    c_adj_up_list[[i]] <- as.data.frame(c_adj_up)
    c_adj_down_list[[i]] <- as.data.frame(c_adj_down)
}
c_adj_tab_up <- t(plyr::rbind.fill(sapply(c_adj_up_list, function(v){as.data.frame(t(v))})))
c_adj_tab_down <- t(plyr::rbind.fill(sapply(c_adj_down_list, function(v){as.data.frame(t(v))})))
colnames(c_adj_tab_up) <- colnames(c_adj_tab_down) <- names(name1_ls)


c_adj_tab <- plyr::ldply(name1_ls, .id = 'organ')
c_adj_tab %<>% select(organ, prot, fc) %>% setNames(c('organ', 'Uniprot', 'fc'))




```


## read matrix of TOP1 (P11387)
```{r}
setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/clinical_trials_download')

require(magrittr)
require(tidyverse)



df_info <- readxl::read_excel('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/matrix/202207TPHP_1781file_info_edited_v4.xlsx')

df <- readxl::read_excel('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/matrix/20220718TPHP_combined_ca_nomal_info.xlsx',
                         col_types = c(rep('guess', 16), rep('numeric', 13413)), na = '')
dim(df) # 1781 13429
colnames(df) %>% head
colnames(df) %>% tail
colnames(df)[1:17]

pm <- df %>% select(FileName, 17:13429)
df1 <- df_info %>%
  inner_join(pm, by = 'FileName') %>%
  arrange(anatomical_classification, anatomical_location, tissue_name)
dim(df1) # 1781 13431
colnames(df1)[1:19]

# 
df2 <- df1 %>%
  filter(!is.na(anatomical_classification)) %>%
  filter(sample_type %in% c('carcinoma', 'adjacent')) %>% # carcinoma and adjacent
  # filter(sample_type %in% c('carcinoma')) %>% # only carcinoma
  dplyr::select(FileName, sample_type, tissue_name, anatomical_location, anatomical_classification, 19:13431)
dim(df2) # 1101 13418

df2[str_detect(df2$anatomical_location, 'large intestine'), 'anatomical_classification'] <- 'colon'
df2[str_detect(df2$anatomical_location, 'rectum'), 'anatomical_classification'] <- 'rectum'
df2[str_detect(df2$anatomical_location, 'cervix'), 'anatomical_classification'] <- 'cervix_uteri'

df_selected <- df2 %>%
  filter(anatomical_classification %in% names(name1_ls)) %>%
  rename(organ = anatomical_classification,
         cancer_type = sample_type) %>%
  select(FileName, organ, cancer_type, c_adj_tab$Uniprot) %>%
  removeColsAllNa()
dim(df_selected) # 1099 8023


nafill <- min(pm[, -1], na.rm = T) + log2(0.8) # min * 0.8



```


#20230201TPHP_CA_diff_expr
```{r}
# require(tidyverse)
# require(magrittr)
# rm(list = ls())
# setwd('//172.16.13.114/share/members/jiangwenhao/TPHP/202200720/F3')
setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/')
source('//172.16.13.136/share/members/jiangwenhao/code/myQC.R')



# prepare matrix ----------------------------------------------------------
# df <- rio::import('data/20220714TPHP_CA_remove_05NA_1099_9800.xlsx')
df <- readxl::read_excel("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230116TPHP_CA_remove_allNA_1099_13392.xlsx", col_types = c(rep('guess', 5), rep('numeric', 13392)), na = '')

str_subset(df$organ, 'cervix') == 'cervix uteri' # FALSE
df[str_detect(df$organ, 'cervix'), 'organ'] <- 'cervix uteri'

df %>% count(organ)
df %>% count(cancer_type)

df %<>% mutate(cancer_type = factor(cancer_type, levels = c('carcinoma', 'adjacent'), ordered = T))

df_med <- df %>% group_by(organ, cancer_type) %>% # aggregate
  summarise_at(vars(-(1:3)), mean, na.rm = T) %>% # mean
  ungroup()

df_med %<>%
  mutate(label = str_c(organ, cancer_type, sep = '_')) %>%
  relocate(label, .after = 2)



df_info <- df_med %>% select(1:3)
rownames(df_info) <- df_info$label

pm <- df_med %>%
  select(-(1:2)) %>%
  column_to_rownames('label') %>%
  t() %>% as.data.frame()




# selected proteins -------------------------------------------------------
# xlsx_vec <- list.files('//172.16.13.114/share/members/yuel/1project/0_TPHP/2_figures/20220712',
#                        '*\\.xlsx',
#                        full.name = T)
xlsx_vec <- list.files('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/', '^20230116_CA_ADJ_volcanoplot.+?\\.xlsx$', full.name = T)



name1_ls <- lapply(xlsx_vec, function(xlsx){
  df1 <- readxl::read_excel(xlsx, sheet = 'up')
  df2 <- readxl::read_excel(xlsx, sheet = 'down')
  ret <- rbind(df1, df2)
  return(ret)
})

names(name1_ls) <- str_extract(xlsx_vec, '0\\.05p.+\\.xlsx$') %>%
  str_replace('^0\\.05p_', '') %>%
  str_replace('\\.xlsx$', '')



identical(unique(df_med$organ), names(name1_ls)) # FALSE
which(unique(df_med$organ) != names(name1_ls)) # integer(0)
unique(df_med$organ)
names(name1_ls)
names(name1_ls)[2] <- unique(df_med$organ)[2]



# cancer-tissue-specific
c_adj_up_list <- list()
c_adj_down_list <- list()
for (i in 1:length(name1_ls)){
  c_adj_list <- name1_ls[[i]]
  
  # c_adj_up, less than 50% missing value
  c_adj_up <- c_adj_list[which(c_adj_list$type == "Upregulation"), 1]
  
  # c_adj_down, less than 50% missing value
  c_adj_down <- c_adj_list[which(c_adj_list$type == "Downregulation"), 1]
  
  c_adj_up_list[[i]] <- as.data.frame(c_adj_up)
  c_adj_down_list[[i]] <- as.data.frame(c_adj_down)
}


# library("plyr")
c_adj_tab_up <- t(plyr::rbind.fill(sapply(c_adj_up_list, function(v){as.data.frame(t(v))})))
c_adj_tab_down <- t(plyr::rbind.fill(sapply(c_adj_down_list, function(v){as.data.frame(t(v))})))
colnames(c_adj_tab_up) <- colnames(c_adj_tab_down) <- names(name1_ls)



target_list <- list()
for (i in 1:length(name1_ls)){
  # i=1
  type <- names(name1_ls)[i]
  
  # # p1:c_n and c_adj overlap
  cad_up <- c_adj_tab_up[, type]
  up <- na.omit(cad_up)
  
  cad_down <- c_adj_tab_down[, type]
  down <- na.omit(cad_down)
  
  p1 <- c(up,down)
  
  #p2: complementary of p1 to ad_n
  p2 <- p1
  
  #p3:pool of proteins changed in other tissue type
  p3 <- Reduce(union, list(#unlist(c_n_tab_up[, -i]), unlist(c_n_tab_down[, -i]),
    unlist(c_adj_tab_up[, -grep(type, colnames(c_adj_tab_up))]),
    unlist(c_adj_tab_down[,-grep(type, colnames(c_adj_tab_down))])))
  
  #p4:complementary of p2 to p3
  p4 <- setdiff(p2, p3)
  
  
  
  #p5:50% missing
  p5 <- intersect(p4, colnames(df))
  target_list[[i]] <- p5
  
}



na_index <- rev(which(sapply(target_list, function(e){
  is.null(e) | length(e) == 0
}))) # 22 16  7  5  4
for (i in na_index) {
  target_list[[i]] <- NULL
}

target_tab <- t(plyr::rbind.fill(sapply(target_list, function(v){as.data.frame(t(v))})))
colnames(target_tab) <- names(name1_ls)[setdiff(1:length(name1_ls), na_index)]
dim(target_tab) # 522  20


write.csv(target_tab,"20230201yuel_TPHP_CA_targetlist_3_mean.csv", row.names = F)





target_tab <- read.csv("20230201yuel_TPHP_CA_targetlist_3_mean.csv", check.names = F)
tissue_type_number <- apply(target_tab, 2, function(v){sum(!is.na(v))})
target_proteins <- na.omit(as.character(unlist(target_tab)))
length(target_proteins)
#2319 target proteins
tissue_name <- list()
for ( i in 1:ncol(target_tab) ){
  tissue_name[[i]] <- rep(colnames(target_tab)[i], tissue_type_number[i])
}
tissue_name_col <- unlist(tissue_name)

pro_information <- cbind(target_proteins, tissue_name_col)
write.csv(pro_information, "20230201yuel_TPHP_CA_F3_proteins_mean.csv", row.names = F)



pm_select <- t(pm)[, target_proteins]
dim(pm_select) # 50 2319

#2.select samples
tissue_type_final <- unique(tissue_name_col)

pm_select2 <- pm_select
dim(pm_select2) # 50 2319

#2.add cancer type
pm_select3 <- pm_select2 %>%
  as.data.frame() %>%
  rownames_to_column('label') %>%
  inner_join(df_info, ., by = 'label')

dim(pm_select3) # 50 2322
ge.na.ratio(pm_select3[, -(1:3)])#return 0.06231997

#3.order sample first by anatomical_classification, then by sample_type
pm_select3 %<>% arrange(organ, cancer_type)
# pm_select3 %<>%
#   mutate(tissue_name = anatomical_classification) %>%
#   relocate(tissue_name, .before = 2) %>%
#   relocate(sample_type, .before = 2)
pm_select3$cancer_type %<>% as.character()
pm_select3$cancer_type <- ifelse(pm_select3$cancer_type == 'carcinoma', '1_carcinoma', '2_adjacent')
# pm_select3 %<>% arrange(anatomical_classification, sample_type)

write.csv(pm_select3, "20230201yuel_TPHP_CA_F3_selected_matrix_mean.csv",row.names = F)







# heatmap preparation -----------------------------------------------------
protinfo <- read.csv("20230201yuel_TPHP_CA_F3_proteins_mean.csv", check.names = F)
df <- read.csv("20230201yuel_TPHP_CA_F3_selected_matrix_mean.csv", check.names = F)
# df <- df[!duplicated(df), ]


# ------------- add gene name--------------------
# require(org.Hs.eg.db)
uni_entr <- clusterProfiler::bitr(protinfo$target_proteins,fromType = "UNIPROT",toType = "ENTREZID",OrgDb = "org.Hs.eg.db",drop = T)
uni_entr$target_genes <- BiocGenerics::toTable(org.Hs.eg.db::org.Hs.egSYMBOL[uni_entr$ENTREZID])$symbol
uni_entr %<>% dplyr::rename(target_proteins = UNIPROT) %>% dplyr::select(target_proteins, target_genes)
dup_prots <- uni_entr$target_proteins[base::duplicated(uni_entr$target_proteins)]
uni_entr1 <- uni_entr[!(uni_entr$target_proteins %in% dup_prots), ]
uni_entr2 <- uni_entr[uni_entr$target_proteins %in% dup_prots, ]
uni_entr2 %<>%
  dplyr::group_by(target_proteins) %>%
  dplyr::summarise(target_genes = stringr::str_c(target_genes, collapse = ';'))
uni_entr <- rbind(uni_entr1, uni_entr2)
protinfo <- dplyr::full_join(protinfo, uni_entr, by = 'target_proteins')


# # ------------- tissue_type has been combined -------------------
# colnames(df)[1:4]
# tail(colnames(df))
# dim(df) # 50 1520
df2 <- df

# keepna ------------------------------------------------------------------
df3 <- df[, -(1:3)]
df3 <- apply(df3, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(df3) <- df2$label

# heatmap
df3_na_positions <- is.na(df3)
na_fill <- min(df3, na.rm = T) + log2(0.1)
df3[is.na(df3)] <- na_fill
df3.scale <- apply(df3, 1, scale) %>% t() %>% data.frame()
df3.scale[df3_na_positions] <- NA
names(df3.scale) <- df2$label

prot <- colnames(df2)[-(1:3)]
row.tissue <- protinfo$tissue_name_col
# for (i in sort(unique(protinfo$tissue_name_col))) {
#   tmp.prot <- protinfo$target_proteins[which(protinfo$tissue_name_col %in% i)]
#   tmp.df <- df3.scale[tmp.prot,]
#   if(nrow(tmp.df)>=2){
#     d1 <- dist(tmp.df)
#     d2 <- tryCatch(hclust(d1)[["order"]], error = function(x) 1:nrow(tmp.df))
#     prot <- c(prot,row.names(tmp.df)[d2])
#   }else{
#     prot <- c(prot,row.names(tmp.df))
#   }
#   row.tissue <- c(row.tissue,rep(i,nrow(tmp.df)))
# }

df4 <- df3
# df4[grepl("NA",row.names(df4)),] <- NA
df3.scale <- apply(df4, 1, scale) %>% t() %>% data.frame()
# df3.scale[df3_na_positions] <- NA
names(df3.scale) <- df2$label
df4 <- df3.scale[prot,]
# df4[is.na(df4)] <- -4

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo$target_proteins, '_', protinfo$target_genes), row.names = protinfo$target_proteins)
srt <- row.names(df4)
df4 <- merge(df4, uniprot_gene, by = 'row.names')
row.names(df4) <- df4$prot
df4 <- df4[, -grep('^Row\\.names$|^prot$', colnames(df4))]
df4 <- df4[srt, ]



ann_row <- data.frame(row.tissue=row.tissue,row.names =  row.names(df4))


ann_col <- data.frame(tissue = factor(df2$organ),
                      cancer = factor(df2$cancer_type),
                      row.names = names(df4))
ann_col$tissue <- factor(ann_col$tissue)

require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)

tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(cancer=cancer_color,tissue=tissue_color,row.tissue=tissue_color)
# ann_colors <- list(tissue=tissue_color,row.tissue=tissue_color)




a <- pheatmap::pheatmap(df4, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_CA_specific_heatmap20230201_scale_with_na_and_keep_mean.pdf",width=8,height=8)



a <- pheatmap::pheatmap(df4, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[3:1]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_CA_specific_heatmap20230201_scale_with_na_and_keep_red_mean.pdf",width=8,height=8)




# na omit ------------------------------------------------------------------
df3 <- df[, -(1:3)]
df3 <- apply(df3, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(df3) <- df2$label

# heatmap
df3_na_positions <- is.na(df3)
# na_fill <- min(df3, na.rm = T) + log2(0.1)
# df3[is.na(df3)] <- na_fill
df3.scale <- apply(df3, 1, scale) %>% t() %>% data.frame()
# df3.scale[df3_na_positions] <- NA
names(df3.scale) <- df2$label

prot <- colnames(df2)[-(1:3)]
row.tissue <- protinfo$tissue_name_col
# for (i in sort(unique(protinfo$tissue_name_col))) {
#   tmp.prot <- protinfo$target_proteins[which(protinfo$tissue_name_col %in% i)]
#   tmp.df <- df3.scale[tmp.prot,]
#   if(nrow(tmp.df)>=2){
#     d1 <- dist(tmp.df)
#     d2 <- tryCatch(hclust(d1)[["order"]], error = function(x) 1:nrow(tmp.df))
#     prot <- c(prot,row.names(tmp.df)[d2])
#   }else{
#     prot <- c(prot,row.names(tmp.df))
#   }
#   row.tissue <- c(row.tissue,rep(i,nrow(tmp.df)))
# }

df4 <- df3
# df4[grepl("NA",row.names(df4)),] <- NA
df3.scale <- apply(df4, 1, scale) %>% t() %>% data.frame()
# df3.scale[df3_na_positions] <- NA
names(df3.scale) <- df2$label
df4 <- df3.scale[prot,]
# df4[is.na(df4)] <- -4

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo$target_proteins, '_', protinfo$target_genes), row.names = protinfo$target_proteins)
srt <- row.names(df4)
df4 <- merge(df4, uniprot_gene, by = 'row.names')
row.names(df4) <- df4$prot
df4 <- df4[, -grep('^Row\\.names$|^prot$', colnames(df4))]
df4 <- df4[srt, ]



ann_row <- data.frame(row.tissue=row.tissue,row.names =  row.names(df4))


ann_col <- data.frame(tissue = factor(df2$organ),
                      cancer = factor(df2$cancer_type),
                      row.names = names(df4))
ann_col$tissue <- factor(ann_col$tissue)

require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)

tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(cancer=cancer_color,tissue=tissue_color,row.tissue=tissue_color)
# ann_colors <- list(tissue=tissue_color,row.tissue=tissue_color)




a <- pheatmap::pheatmap(df4, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:1]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_CA_specific_heatmap20230201.pdf",width=8,height=8)


na_fill <- min(df4, na.rm = T)
df4[is.na(df4)] <- na_fill
a <- pheatmap::pheatmap(df4, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:1]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_CA_specific_heatmap20230201_lightna.pdf",width=8,height=8)




```


# 2023-03-18 cancer-tissue-specific --0516 edited
## heatmap (organ level)
```{r}
# require(tidyverse)
# require(magrittr)
# rm(list = ls())
# setwd('//172.16.13.114/share/members/jiangwenhao/TPHP/202200720/F3')
setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/')

source('//172.16.13.136/share/members/jiangwenhao/code/myQC.R')



# prepare matrix ----------------------------------------------------------
df <- readxl::read_excel("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230116TPHP_CA_remove_allNA_1099_13392.xlsx", col_types = c(rep('guess', 5), rep('numeric', 13392)), na = '')

str_subset(df$organ, 'cervix') == 'cervix uteri' # FALSE
df[str_detect(df$organ, 'cervix'), 'organ'] <- 'cervix uteri'

df %>% count(organ)
df %>% count(cancer_type)

df %<>% mutate(cancer_type = factor(cancer_type, levels = c('carcinoma', 'adjacent'), ordered = T))

# raw scale
df_raw <- df %>%
  mutate_at(vars(-(1:5)), function(e) 2^e)
# fill NA
na_fill <- min(unlist(df_raw[, -(1:5)]), na.rm = T) * 0.5
df_raw[is.na(df_raw)] <- na_fill

df_med <- df_raw %>%
  group_by(organ, cancer_type) %>% # aggregate
  summarise_at(vars(-(1:3)), median, na.rm = T) %>%
  ungroup()

df_med %<>%
  mutate(label = str_c(organ, cancer_type, sep = '_')) %>% # add label
  relocate(label, .after = 2)

# log2 transform
df_med[, -(1:3)] <- log2(df_med[, -(1:3)])


df_info <- df_med %>% dplyr::select(1:3)
rownames(df_info) <- df_info$label

pm <- df_med %>%
  dplyr::select(-(1:2)) %>%
  column_to_rownames('label') %>%
  t() %>% as.data.frame()


# 0202 --------------------------------------------------------------------
xlsx_vec <- list.files('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/', '^20230318_CA_ADJ_volcanoplot.+?\\.xlsx$', full.name = T)

name1_ls <- lapply(xlsx_vec, function(xlsx){
  df1 <- readxl::read_excel(xlsx, sheet = 'up')
  df2 <- readxl::read_excel(xlsx, sheet = 'down')
  ret <- rbind(df1, df2)
  return(ret)
})

names(name1_ls) <- str_extract(xlsx_vec, '0\\.05p.+\\.xlsx$') %>%
  str_replace('^0\\.05p_', '') %>%
  str_replace('\\.xlsx$', '')



identical(unique(df_med$organ), names(name1_ls))
which(unique(df_med$organ) != names(name1_ls)) # 2

unique(df_med$organ)
names(name1_ls)
names(name1_ls)[2] <- unique(df_med$organ)[2]



# cancer-tissue-specific
c_adj_up_list <- list()
c_adj_down_list <- list()
for (i in 1:length(name1_ls)){
  c_adj_list <- name1_ls[[i]]
  
  # c_adj_up, less than 50% missing value
  c_adj_up <- c_adj_list[which(c_adj_list$type == "Upregulation"), 1] %>% pull()
  c_adj_up_50NA <- df %>%
    filter(cancer_type == 'carcinoma') %>% # carcinoma sample only
    filter(organ == names(name1_ls)[i]) %>% # in specific tissue
    dplyr::select(all_of(intersect(c_adj_up, colnames(df)))) %>%
    apply(2, function(col) sum(is.na(col)) / length(col) ) %>% # calculate missing ratio
    .[. < 0.5] %>%
    names()
  if(!is.null(c_adj_up_50NA)){
    c_adj_up <- c_adj_up_50NA # 5 carcinoma types have no upregulated proteins
  }
  
  # c_adj_down, less than 50% missing value
  c_adj_down <- c_adj_list[which(c_adj_list$type == "Downregulation"), 1] %>% pull()
  
  c_adj_up_list[[i]] <- as.data.frame(c_adj_up)
  c_adj_down_list[[i]] <- as.data.frame(c_adj_down)
}



# library("plyr")
c_adj_tab_up <- t(plyr::rbind.fill(sapply(c_adj_up_list, function(v){as.data.frame(t(v))})))
c_adj_tab_down <- t(plyr::rbind.fill(sapply(c_adj_down_list, function(v){as.data.frame(t(v))})))
colnames(c_adj_tab_up) <- colnames(c_adj_tab_down) <- names(name1_ls)



target_list <- list()
for (i in 1:length(name1_ls)){
  # i=1
  type <- names(name1_ls)[i]
  
  # # p1:c_n and c_adj overlap
  cad_up <- c_adj_tab_up[, type]
  up <- na.omit(cad_up)
  
  cad_down <- c_adj_tab_down[, type]
  down <- na.omit(cad_down)
  
  p1 <- c(up,down)
  
  #p2: complementary of p1 to ad_n
  p2 <- p1
  
  #p3:pool of proteins changed in other tissue type
  p3 <- Reduce(union, list(#unlist(c_n_tab_up[, -i]), unlist(c_n_tab_down[, -i]),
    unlist(c_adj_tab_up[, -grep(type, colnames(c_adj_tab_up))]),
    unlist(c_adj_tab_down[,-grep(type, colnames(c_adj_tab_down))])))
  
  #p4:complementary of p2 to p3
  p4 <- setdiff(p2, p3)
  
  
  
  #p5:50% missing
  p5 <- intersect(p4, colnames(df))
  target_list[[i]] <- p5
  
}


na_index <- rev(which(sapply(target_list, function(e){
  is.null(e) | length(e) == 0
}))) # 22 16  7  5  4
for (i in na_index) {
  target_list[[i]] <- NULL
}

target_tab <- t(plyr::rbind.fill(sapply(target_list, function(v){as.data.frame(t(v))})))
colnames(target_tab) <- names(name1_ls)[setdiff(1:length(name1_ls), na_index)]
dim(target_tab) # 518 20


write.csv(target_tab,"20230318yuel_TPHP_CA_targetlist_3.csv", row.names = F)





target_tab <- read.csv("20230318yuel_TPHP_CA_targetlist_3.csv", check.names = F)
tissue_type_number <- apply(target_tab, 2, function(v){sum(!is.na(v))})
target_proteins <- na.omit(as.character(unlist(target_tab)))
length(target_proteins)
#2300 target proteins
tissue_name <- list()
for ( i in 1:ncol(target_tab) ){
  tissue_name[[i]] <- rep(colnames(target_tab)[i], tissue_type_number[i])
}
tissue_name_col <- unlist(tissue_name)

pro_information <- cbind(target_proteins, tissue_name_col)
write.csv(pro_information, "20230318yuel_TPHP_CA_F3_proteins.csv", row.names = F)



pm_select <- t(pm)[, target_proteins]
dim(pm_select) # 50 2300

#2.select samples
tissue_type_final <- unique(tissue_name_col)

pm_select2 <- pm_select
dim(pm_select2) # 50 2300

#2.add cancer type
pm_select3 <- pm_select2 %>%
  as.data.frame() %>%
  rownames_to_column('label') %>%
  inner_join(df_info, ., by = 'label')

dim(pm_select3) # 50 2303
ge.na.ratio(pm_select3[, -(1:3)])#--return 0.1563976--; 0 after NA filled

#3.order sample first by anatomical_classification, then by sample_type
pm_select3 %<>% arrange(organ, cancer_type)
# pm_select3 %<>%
#   mutate(tissue_name = anatomical_classification) %>%
#   relocate(tissue_name, .before = 2) %>%
#   relocate(sample_type, .before = 2)
pm_select3$cancer_type %<>% as.character()
pm_select3$cancer_type <- ifelse(pm_select3$cancer_type == 'carcinoma', '1_carcinoma', '2_adjacent')
# pm_select3 %<>% arrange(anatomical_classification, sample_type)

write.csv(pm_select3, "20230318yuel_TPHP_CA_F3_selected_matrix.csv",row.names = F)





# heatmap preparation -----------------------------------------------------
protinfo <- read.csv("20230318yuel_TPHP_CA_F3_proteins.csv", check.names = F)
df <- read.csv("20230318yuel_TPHP_CA_F3_selected_matrix.csv", check.names = F)
# df <- df[!duplicated(df), ]


# sort by FC ----
df_dep <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_dysregulated_proteins_filter50NAByOrgan.xlsx')
protinfo <- df_dep %>%
  select(1:3) %>%
  rename('target_proteins' = 'protein',
         'tissue_name_col' = 'organ') %>%
  left_join(protinfo, ., by = c('target_proteins', 'tissue_name_col')) %>%
  arrange(tissue_name_col, desc(log2FC)) %>%
  select(-log2FC)
df[, -(1:3)] <- df[, protinfo$target_proteins]




#get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
df %>% count(organ)
df$organ <- sapply(df$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))
protinfo$tissue_name_col <- sapply(protinfo$tissue_name_col, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))


# CHANGE TO CANCER NAME
ht_organ2cancer <- c('GBM', 'COCA', 'CESC', 'ESCA', 'FTCA', 'GBCA', 'RC', 'HCC', 'DLBCL', 'THYM', 'LUCA', 'BRCA', 'MUT', 'OC', 'PACA', 'PECA', 'PRCA', 'READ', 'GIST', 'GC', 'TGCT', 'LARCA', 'THCA', 'TOCA', 'ENCA')
names(ht_organ2cancer) <- c('CE', 'CO', 'CU', 'ESO', 'FT', 'GB', 'KI', 'LI', 'LN', 'LTH', 'LU', 'MAG', 'MU', 'OV', 'PA', 'PEN', 'PR', 'REC', 'SI', 'ST', 'TE', 'THR', 'THY', 'TON', 'UTE')
protinfo$tissue_name_raw <- protinfo$tissue_name_col
protinfo$tissue_name_col <- ht_organ2cancer[protinfo$tissue_name_col]
df$organ <- ht_organ2cancer[df$organ]

# relabelled
df %<>% unite(label, organ, cancer_type, sep = '&', remove = F) %>%
  mutate(label = str_replace(label, '&\\d+', '')) %>%
  relocate(label, .after = cancer_type)




# ------------- add gene name--------------------
# require(org.Hs.eg.db)
# uni_entr <- clusterProfiler::bitr(protinfo$target_proteins,fromType = "UNIPROT",toType = "ENTREZID",OrgDb = "org.Hs.eg.db",drop = T)
# uni_entr$target_genes <- BiocGenerics::toTable(org.Hs.egSYMBOL[uni_entr$ENTREZID])$symbol
# uni_entr %<>% dplyr::rename(target_proteins = UNIPROT) %>% dplyr::select(target_proteins, target_genes)
# dup_prots <- uni_entr$target_proteins[base::duplicated(uni_entr$target_proteins)]
# uni_entr1 <- uni_entr[!(uni_entr$target_proteins %in% dup_prots), ]
# uni_entr2 <- uni_entr[uni_entr$target_proteins %in% dup_prots, ]
# uni_entr2 %<>%
#   dplyr::group_by(target_proteins) %>%
#   dplyr::summarise(target_genes = stringr::str_c(target_genes, collapse = ';'))
# uni_entr <- rbind(uni_entr1, uni_entr2)
dfprot <- rio::import('//172.16.13.136/TPHP/TPL/libs/20220616_fraglib/protein.tsv')
protinfo <- dfprot %>%
  select(`Protein ID`, Gene) %>%
  setNames(c('target_proteins', 'target_genes')) %>% 
  left_join(protinfo, ., by = 'target_proteins')

pacman::p_unload(pacman::p_loaded(), character.only = T)
pacman::p_load(tidyverse, magrittr)


preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()


# # ------------- tissue_type has been combined -------------------
# colnames(df)[1:4]
# tail(colnames(df))
# dim(df) # 50 1520
df2 <- df

# keepna ------------------------------------------------------------------
df3 <- df[, -(1:3)]
df3 <- apply(df3, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(df3) <- df2$label

# heatmap
df3_na_positions <- is.na(df3)
na_fill <- min(df3, na.rm = T) + log2(0.1)
df3[is.na(df3)] <- na_fill
df3.scale <- apply(df3, 1, scale) %>% t() %>% data.frame()
df3.scale[df3_na_positions] <- NA
names(df3.scale) <- df2$label

prot <- colnames(df2)[-(1:3)]
row.tissue <- protinfo$tissue_name_col
# for (i in sort(unique(protinfo$tissue_name_col))) {
#   tmp.prot <- protinfo$target_proteins[which(protinfo$tissue_name_col %in% i)]
#   tmp.df <- df3.scale[tmp.prot,]
#   if(nrow(tmp.df)>=2){
#     d1 <- dist(tmp.df)
#     d2 <- tryCatch(hclust(d1)[["order"]], error = function(x) 1:nrow(tmp.df))
#     prot <- c(prot,row.names(tmp.df)[d2])
#   }else{
#     prot <- c(prot,row.names(tmp.df))
#   }
#   row.tissue <- c(row.tissue,rep(i,nrow(tmp.df)))
# }

df4 <- df3
# df4[grepl("NA",row.names(df4)),] <- NA
df3.scale <- apply(df4, 1, scale) %>% t() %>% data.frame()
# df3.scale[df3_na_positions] <- NA
names(df3.scale) <- df2$label
df4 <- df3.scale[prot,]
# df4[is.na(df4)] <- -4

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo$target_proteins, '_', protinfo$target_genes), row.names = protinfo$target_proteins)
srt <- row.names(df4)
df4 <- merge(df4, uniprot_gene, by = 'row.names')
row.names(df4) <- df4$prot
df4 <- df4[, -grep('^Row\\.names$|^prot$', colnames(df4))]
df4 <- df4[srt, ]



ann_row <- data.frame(row.tissue=factor(row.tissue, levels = unique(row.tissue), ordered = T),row.names =  row.names(df4))


ann_col <- data.frame(tissue = factor(df2$organ),
                      cancer = factor(df2$cancer_type),
                      row.names = names(df4))
ann_col$tissue <- factor(ann_col$tissue)

require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)

tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
cancer_color <- c('1_carcinoma' = '#CF3F54', '2_adjacent' = '#99CFD1'#, '3_normal' = '#03A2B3'
                    )
ann_colors <- list(cancer=cancer_color,tissue=tissue_color,row.tissue=tissue_color)
# ann_colors <- list(tissue=tissue_color,row.tissue=tissue_color)



dim(df4) # 2300   50

# a <- pheatmap::pheatmap(df4, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
#                         border_color = F,
#                         annotation_col = ann_col, annotation_row = ann_row,
#                         gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
#                         gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
#                         fontsize_row=3,
#                         annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
#                         cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
#                         filename = "TPHP_CA_specific_heatmap20230202_scale_with_na_and_keep_1641protein.pdf",width=8,height=8)
# 

a <- pheatmap::pheatmap(df4, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(ann_row$row.tissue))[-length(cumsum(table(ann_row$row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_CA_specific_heatmap20230516_scale_fill_na_2318protein.pdf",width=8,height=8)



```

### select top3 proteins for each kind of cancer
```{r}
df_dep_ <- df_dep
df_dep_[str_detect(df_dep$organ, 'cervi'), 'organ'] <- 'cervix uteri'
df_dep_$organ <- sapply(df_dep_$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

protinfo_top3 <- plyr::ddply(protinfo, 'tissue_name_col', function(dfsub){
  # df_top3 <- dfsub %>%
  #   left_join(df_dep_, by = c('tissue_name_raw' = 'organ', 'target_proteins' = 'protein')) %>%
  #   filter(abs(log2FC) >= log2(2)) %>%
  #   arrange(pAdj_t) %>%
  #   head(3)

  df_top3 <- dfsub %>%
    left_join(df_dep_, by = c('tissue_name_raw' = 'organ', 'target_proteins' = 'protein')) %>%
    filter(pAdj_t < 0.05, abs(log2FC) >= log2(2)) %>% 
    mutate(log2FC_abs = abs(log2FC)) %>% 
    arrange(desc(log2FC_abs)) %>%
    head(3) %>%
    arrange(desc(log2FC))

  return(df_top3)
})

protinfo_top3$tissue_name_col <- factor(protinfo_top3$tissue_name_col, levels = unique(protinfo$tissue_name_col), ordered = T)
protinfo_top3 %<>% arrange(tissue_name_col)

df2 <- df %>% select(1:3, all_of(protinfo_top3$target_proteins))

# keepna ------------------------------------------------------------------
df3 <- df[, -(1:3)]
df3 <- apply(df3, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(df3) <- df2$label

# heatmap
df3_na_positions <- is.na(df3)
na_fill <- min(df3, na.rm = T) + log2(0.1)
df3[is.na(df3)] <- na_fill
df3.scale <- apply(df3, 1, scale) %>% t() %>% data.frame()
df3.scale[df3_na_positions] <- NA
names(df3.scale) <- df2$label

prot <- colnames(df2)[-(1:3)]
row.tissue <- protinfo_top3$tissue_name_col
# for (i in sort(unique(protinfo$tissue_name_col))) {
#   tmp.prot <- protinfo$target_proteins[which(protinfo$tissue_name_col %in% i)]
#   tmp.df <- df3.scale[tmp.prot,]
#   if(nrow(tmp.df)>=2){
#     d1 <- dist(tmp.df)
#     d2 <- tryCatch(hclust(d1)[["order"]], error = function(x) 1:nrow(tmp.df))
#     prot <- c(prot,row.names(tmp.df)[d2])
#   }else{
#     prot <- c(prot,row.names(tmp.df))
#   }
#   row.tissue <- c(row.tissue,rep(i,nrow(tmp.df)))
# }

df4 <- df3
# df4[grepl("NA",row.names(df4)),] <- NA
df3.scale <- apply(df4, 1, scale) %>% t() %>% data.frame()
# df3.scale[df3_na_positions] <- NA
names(df3.scale) <- df2$label
df4 <- df3.scale[prot,]
# df4[is.na(df4)] <- -4

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_top3$target_proteins, '_', protinfo_top3$target_genes), row.names = protinfo_top3$target_proteins)
srt <- row.names(df4)
df4 <- merge(df4, uniprot_gene, by = 'row.names')
row.names(df4) <- df4$prot
df4 <- df4[, -grep('^Row\\.names$|^prot$', colnames(df4))]
df4 <- df4[srt, ]



ann_row <- data.frame(row.tissue=factor(row.tissue, levels = unique(row.tissue), ordered = T),row.names =  row.names(df4))


ann_col <- data.frame(tissue = factor(df2$organ),
                      cancer = factor(df2$cancer_type),
                      row.names = names(df4))
ann_col$tissue <- factor(ann_col$tissue)

require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)

tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
cancer_color <- c('1_carcinoma' = '#CF3F54', '2_adjacent' = '#99CFD1'#, '3_normal' = '#03A2B3'
                    )
ann_colors <- list(cancer=cancer_color,tissue=tissue_color,row.tissue=tissue_color)
# ann_colors <- list(tissue=tissue_color,row.tissue=tissue_color)



dim(df4) # 60   50

# a <- pheatmap::pheatmap(df4, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
#                         border_color = F,
#                         annotation_col = ann_col, annotation_row = ann_row,
#                         gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
#                         gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
#                         fontsize_row=3,
#                         annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
#                         cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
#                         filename = "TPHP_CA_specific_heatmap20230202_scale_with_na_and_keep_1641protein.pdf",width=8,height=8)
# 

b <- pheatmap::pheatmap(df4,
                        color = c(brewer.pal(11,"RdYlBu")[9:7],
                                  brewer.pal(11,"RdYlBu")[4:2]),
                        # color = colorRampPalette(colors = c(brewer.pal(11,"RdYlBu")[9:7], '#EEEEEE',
                        #            brewer.pal(11,"RdYlBu")[4:2]))(50),
                        # color = colorRampPalette(colors = c("blue","white","red"))(100),
                        # color = colorRampPalette(colors = c("#74ADD1", "#ABD9E9", "#E0F3F8", "white", "#FDAE61", "#F46D43", "#D73027"))(100),
                        fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(ann_row$row.tissue))[-length(cumsum(table(ann_row$row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_CA_specific_heatmap20230727_scale_fill_na_top3_60protein.pdf",width=8,height=8)



```


### heatmap (organ leveluse fold change)
```{r}
protinfo_top3


ordered_names <- colnames(df4) %>% str_subset('carcinoma') %>% str_replace('_carcinoma', '')
df4 <- df_dep_ %>% filter(pAdj_t < 0.05, protein %in% protinfo_top3$target_proteins) %>%
  left_join(protinfo_top3 %>% select(target_proteins, target_genes), by = c('protein' = 'target_proteins')) %>%
  unite(rowname, protein, target_genes, remove = F) %>%
  select(rowname, protein, organ, log2FC) %>%
  pivot_wider(c('rowname', 'protein'), names_from = organ, values_from = log2FC) %>%
  column_to_rownames('protein')

df4 <- df4[protinfo_top3$target_proteins, ]
rownames(df4) <- df4$rowname
df4$rowname <- NULL

colnames(df4) <- ht_organ2cancer[colnames(df4)]
identical(colnames(df4), ordered_names) # FALSE
colnames(df4)
ordered_names


ann_row <- data.frame(row.tissue=factor(row.tissue, levels = unique(row.tissue), ordered = T),row.names =  row.names(df4))


ann_col <- data.frame(tissue = factor(names(df4)),
                      # cancer = factor(df2$cancer_type),
                      row.names = names(df4))
ann_col$tissue <- factor(ann_col$tissue)

require(RColorBrewer)
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

set.seed(10)

tissue_color <- sample(col_vector, length(unique(ann_col$tissue)))
names(tissue_color) <- unique(ann_col$tissue)
# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])[1:2]
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
cancer_color <- c('1_carcinoma' = '#CF3F54', '2_adjacent' = '#99CFD1'#, '3_normal' = '#03A2B3'
)
ann_colors <- list(cancer=cancer_color,tissue=tissue_color,row.tissue=tissue_color)
# ann_colors <- list(tissue=tissue_color,row.tissue=tissue_color)



dim(df4) # 60   20

# a <- pheatmap::pheatmap(df4, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
#                         border_color = F,
#                         annotation_col = ann_col, annotation_row = ann_row,
#                         gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
#                         gaps_row = cumsum(table(row.tissue))[-length(cumsum(table(row.tissue)))],
#                         fontsize_row=3,
#                         annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
#                         cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
#                         filename = "TPHP_CA_specific_heatmap20230202_scale_with_na_and_keep_1641protein.pdf",width=8,height=8)
# 

c <- pheatmap::pheatmap(df4,
                        # color = c(brewer.pal(11,"RdYlBu")[9:7],
                        #           brewer.pal(11,"RdYlBu")[4:2]),
                        color = colorRampPalette(colors = c(brewer.pal(11,"RdYlBu")[11:9], '#EEEEEE',
                                   brewer.pal(11,"RdYlBu")[4:1]))(50),
                        # color = colorRampPalette(colors = c("blue","white","red"))(100),
                        # color = colorRampPalette(colors = c("#74ADD1", "#ABD9E9", "#E0F3F8", "white", "#FDAE61", "#F46D43", "#D73027"))(100),
                        fontsize_col = 8,
                        border_color = F,
                        annotation_col = ann_col, annotation_row = ann_row,
                        gaps_col = cumsum(table(ann_col$tissue))[-length(cumsum(table(ann_col$tissue)))],
                        gaps_row = cumsum(table(ann_row$row.tissue))[-length(cumsum(table(ann_row$row.tissue)))],
                        fontsize_row=3,
                        annotation_colors = ann_colors,na_col = "#CCCCCC",#scale = "row",
                        cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F, 
                        filename = "TPHP_CA_specific_heatmap20230727_scale_fill_na_top3_60protein_FC.pdf",width=5,height=8)


df4 %>% rownames_to_column('protein') %>% rio::export('TPHP_CA_specific_heatmap20230727_scale_fill_na_top3_60protein_FC.xlsx')


```

# 2023-05-16 cancer specific proteins
```{r}
xlsx_vec <- list.files('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/',
                       '^20230318_CA_ADJ_volcanoplot.*\\.xlsx$',
                       full.name = T)
name1_ls <- lapply(xlsx_vec, function(xlsx){
  df1 <- readxl::read_excel(xlsx, sheet = 'up')
  df2 <- readxl::read_excel(xlsx, sheet = 'down')
  ret <- rbind(df1, df2)
  return(ret)
})

names(name1_ls) <- str_extract(xlsx_vec, '0\\.05p.+\\.xlsx$') %>%
  str_replace('^0\\.05p_', '') %>%
  str_replace('\\.xlsx$', '')
names(name1_ls)[2] <- 'cervix_uteri'
df_dep <- plyr::ldply(name1_ls, .id = 'organ')

df_specifc <- df_dep %>% count(prot) %>% filter(n == 1) %>% semi_join(df_dep, .)



#get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
df_specifc$organ <- sapply(df_specifc$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))


# CHANGE TO CANCER NAME
ht_organ2cancer <- c('GBM', 'COCA', 'CESC', 'ESCA', 'FTCA', 'GBCA', 'RC', 'HCC', 'DLBCL', 'THYM', 'LUCA', 'BRCA', 'MUT', 'OC', 'PACA', 'PECA', 'PRCA', 'READ', 'GIST', 'GC', 'TGCT', 'LARCA', 'THCA', 'TOCA', 'ENCA')
names(ht_organ2cancer) <- c('CE', 'CO', 'CU', 'ESO', 'FT', 'GB', 'KI', 'LI', 'LN', 'LTH', 'LU', 'MAG', 'MU', 'OV', 'PA', 'PEN', 'PR', 'REC', 'SI', 'ST', 'TE', 'THR', 'THY', 'TON', 'UTE')
df_specifc$organ <- ht_organ2cancer[df_specifc$organ]




# cancer specific DEPs
protls_upset <- plyr::dlply(df_specifc, 'organ', function(dfsub) dfsub$prot)
pdf('TPHP_cancer_specific_proteins_20230516.pdf', width = 10, height = 5)
print(
    UpSetR::upset(
        UpSetR::fromList(protls_upset),nsets = 20, cutoff = 3,
        order.by = 'freq',# order.by = c('freq', 'degree'),
        mainbar.y.label = 'Protein number',
        # queries = list(
        #   list(query = UpSetR::intersects, params = list('TE', 'UTE', 'MAG', 'CU', 'MU'), color = "orange", active = T, query.name = 'The greatest DEPs intersection of top 5 organs')),
        # query.legend = "top",
        # group.by = "sets",
        # empty.intersections = "on",
        set_size.show = T, number.angles = 0, text.scale = c(1, 1, 1, 1, 1, 1.5)
    )
)
dev.off()



# barplot
df_bar <- df_specifc %>% count(organ, type)
rio::export(df_bar, 'TPHP_cancer_specific_proteins_20230516_v2.xlsx')
df_bar %<>% mutate(type = str_remove(type, 'regulation$'))
df_bar[df_bar$type == 'Down', 'n'] <- -df_bar$n[df_bar$type == 'Down']

organs_ordered <- df_specifc %>% count(organ) %>% arrange(n) %>% pull(organ)
df_bar$organ %<>% factor(levels = organs_ordered, ordered = T)
df_bar %<>% arrange(organ, type)

p <- ggplot(df_bar, aes(x=organ, y=n, fill = type)) +
  geom_bar(stat="identity", width=1, position="stack", color = 'black') +
  scale_fill_manual(values = c(Up = "#AB2947", Down = "#17B544"))+
  labs(
    y = "# Proteins",
    title = 'Cancer specific proteins'
  )+
  guides(fill=guide_legend(nrow = 1))+
  theme(panel.grid = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text = element_text(size = 12,color = "black"),
        axis.line = element_line(colour = "black"),
        axis.line.x = element_blank(),
        plot.subtitle = element_text(size = 10, hjust = 0, color="black")
  )+
  theme(legend.text = element_text(size = 10, color = "black"),legend.position = 'bottom',
        legend.title = element_text(size = 10, color="black"),)+
  theme(axis.title.x = element_text(size = 10, hjust = 0.5, color="black", angle = 0),
        # axis.text.x = element_text(size = 10, vjust = 1, hjust = 1, color = "black", angle = 0),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()
  )+
  theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 10,color = "black", angle = 0),
        axis.ticks.y = element_blank()
  ) +
  coord_flip()

df_bar[df_bar$type == 'Up', 'hjust_n'] <- 0
df_bar[df_bar$type == 'Down', 'hjust_n'] <- 1

p <- p + geom_text(aes(label = abs(n)), size = 5, vjust = 0.5, hjust = df_bar$hjust_n)
ggsave('TPHP_cancer_specific_proteins_20230516_v2.pdf', p, width = 12, height = 5)


```

# 2023-03-18 Carcinoma only enriched proteins
## classification
```{r}
setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr')
rm(list = ls())
require(magrittr)
require(tidyverse)
require(RColorBrewer)
source("//172.16.13.136/share/members/yuel/2022/codes/20230207_ulhen_class.R")

df1 <- read.csv('//172.16.13.136/share/members/yuel/2022/tables/20230318_PUH_submatrix_combine_5_missing.csv', check.names = F) # CA combine 50 missing submatrice
df1 %<>% rename(cancer_type = sample_type)
colnames(df1)[1:7]
i_first_prot <- 7
pm1 <- df1 %>% select(i_first_prot:ncol(df1))
na_filling <- min(pm1, na.rm = T) * 0.5 # calculate min * 0.5
df1 %<>% filter(cancer_type == 'carcinoma') # carcinoma only

pm1 <- df1 %>% select(i_first_prot:ncol(df1))
pm1[is.na(pm1)] <- na_filling

pm1 <- df1 %>%
  select(cancer_type, organ) %>% mutate(Group.1 = str_c(organ, cancer_type, sep = '_')) %>%
  dplyr::select(-cancer_type, -organ) %>% cbind(pm1)
pm2 <- pm1 %>% group_by(Group.1) %>%
  summarise_all(median) %>%
  ungroup()

tissue_type_clas<-list()
tissue_type_clas[[1]]<-ulhen_class(pm2[,1:50])
for (i in 2:floor(ncol(pm2)/50)){
  tissue_type_clas[[i]]<-ulhen_class(pm2[,c(1,(50*(i-1)+1):(50*i))])
  cat(paste("Processed",i*50,"/",ncol(pm2) ,sep = " "),"\n")
}
tissue_type_clas[[ceiling(ncol(pm2)/50)]]<-ulhen_class(pm2[,c(1,(50*floor(ncol(pm2)/50)+1):ncol(pm2))])
tissue_type_clas_all<-tissue_type_clas%>% reduce_right(full_join, by = "tissue_type")
tissue_type_clas_all %<>% dplyr::rename(label = tissue_type)
dim(tissue_type_clas_all) # 25 10733
writexl::write_xlsx(tissue_type_clas_all,"//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318Ulhen_classification_Carcinoma_25_10732.xlsx")


tissue_mean1<-tissue_type_clas_all
symbol<-colnames(tissue_mean1)[-c(1)]
#2984 enriched and group enriched proteins
mean_clas_symbol_list<-apply(tissue_mean1[,-c(1)],1, function (v){
  symbol[which(v=="tissue enriched" | v =="group enriched")]
})
length(unique(unlist(mean_clas_symbol_list)))

#1493 tissue enriched
mean_clas_symbol_list<-apply(tissue_mean1[,-c(1)],1, function (v){
  symbol[which(v=="tissue enriched")]
})
length(unique(unlist(mean_clas_symbol_list)))
en_tab<-sapply(mean_clas_symbol_list,function(v){
  data.frame(t(v))
})
a<-as.data.frame(t(plyr::rbind.fill(en_tab)))

colnames(a)<-tissue_mean1$label

# write.csv(a,"figure/F2A/20210402yuel_TPHP_enriched_proteins.csv",row.names = F)
write.csv(a,"//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318TPHP_Ulhen_classification_Carcinoma_tissue_enriched_proteins.csv",row.names = F)

b<-a[,grep("_carcinoma",colnames(a))]
c<-b[,apply(b, 2, function(y) any(!is.na(y)))]
d<-c[apply(c, 1, function(y) any(!is.na(y))),]
writexl::write_xlsx(d,"20230318ULHEN_CLASS_CarcinomaTargets.xlsx")

tmp <- d %>%
  pivot_longer(everything(), names_to = 'label', values_to = 'prot', values_drop_na = T) %>% 
  mutate(label = str_replace(label, '_carcinoma$', ''))
ht_prot_organ <- tmp$label
names(ht_prot_organ) <- tmp$prot

selected_prots <- na.omit(unlist(d))



tmp <- tissue_mean1 %>%
  pivot_longer(-label, names_to = 'protein', values_to = 'Classification') %>%
  filter(str_detect(Classification, 'enriched')) %>%
  arrange(desc(Classification), label, protein)

length(unique(tmp$protein)) #  2984
tmp %>% filter(Classification == 'tissue enriched') %>% pull(protein) %>% unique() %>% length() # 1493
tmp %>% filter(Classification == 'group enriched') %>% pull(protein) %>% unique() %>% length() # 1586

rio::export(tmp, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_Carcinoma_tissue_enriched1493_group_enriched1586_2984prot.csv')
rio::export(pm2, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318TPHP_Carcinoma_tissue_organ_median.xlsx')

```


## enriched proteins expression heatmap (organ level)
```{r}
# df0 <- rio::import('TPHP_normalData_for_classification_20230207.xlsx')
pm2 <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318TPHP_Carcinoma_tissue_organ_median.xlsx')
pm2 %<>% rename(label = 'Group.1')
tmp <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_Carcinoma_tissue_enriched1493_group_enriched1586_2984prot.csv')
tmp %<>% add_column(organ = str_split(tmp$label, '_') %>% sapply(head, 1),
                   sample_type = str_split(tmp$label, '_') %>% sapply(tail, 1),
                   .before = 2)
tmp[str_detect(tmp$organ, 'cervix'), 'organ'] == 'cervix_uteri' # FALSE
tmp[str_detect(tmp$organ, 'cervix'), 'organ'] <- 'cervix_uteri'
tmp[tmp$sample_type == 'carcinoma', 'sample_type'] <- '1_carcinoma'
tmp[tmp$sample_type == 'adjacent', 'sample_type'] <- '2_adjacent'


# map to abbreviation
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
tmp$organ <- sapply(tmp$organ, function(e){
  ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
})
pm2 <- tmp %>%
  distinct(label, organ, sample_type) %>%
  inner_join(pm2, by = 'label')
# pm2$label %<>% 
#   sapply(function(x) {
#     x %>%
#       str_split('_') %>%
#       .[[1]] %>%
#       sapply(function(e){
#         ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
#       }) %>%
#       str_c(collapse = '_')
#   })

# set order
library(dendextend)
# pm_heat_cor <- pm2 %>% column_to_rownames('label') %>%
#   select(-(1:2)) %>% t() %>% cor(method = 'spearman')
# pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
# pm_heat_tree <- hclust(pm_heat_dist, method="complete")
# pm_heat_dend <- as.dendrogram(pm_heat_tree) # create dendrogram object
# plot(pm_heat_dend, horiz = T#, leaflab = "none"
#      )
pm_heat_cor <- pm2 %>% column_to_rownames('label') %>%
  filter(sample_type == '1_carcinoma') %>%
  select(-(1:2)) %>% t() %>% cor(method = 'spearman')
pm_heat_dist <- as.dist(1 - pm_heat_cor) # 1-Spearman's rho
pm_heat_tree <- hclust(pm_heat_dist, method="complete")
pm_heat_dend <- as.dendrogram(pm_heat_tree) # create dendrogram object
plot(pm_heat_dend, horiz = T#, leaflab = "none"
     )
rownames(pm2) <- pm2$label
organs_ordered <- pm2[pm_heat_tree$labels[pm_heat_tree$order], 'organ']
organs_ordered %<>% rev() # for mapping to barplot



# uniprot to symbol
prot_query <- clusterProfiler::bitr(tmp$protein, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
prot_query <- plyr::ddply(prot_query, 'UNIPROT', function(dfsub){
  if(length(unique(dfsub$SYMBOL)) > 1){
    dfsub <- data.frame(UNIPROT = dfsub$UNIPROT[1],
                        SYMBOL = str_c(dfsub$SYMBOL, collapse = ';'))
  }
  return(dfsub)
})
prot_query %<>% setNames(c('protein', 'symbol'))
protinfo <- full_join(tmp, prot_query, by = 'protein')

# tissue enriched proteins
protinfo_tisen <- protinfo %>%
  filter(Classification == 'tissue enriched') %>%
  dplyr::mutate(organ = factor(organ, levels = organs_ordered, ordered = T)) %>%
  arrange(organ, sample_type) %>%
  dplyr::mutate(organ = as.character(organ))

df_tisen_organ <- pm2 %>%
  select(label, organ, sample_type, all_of(protinfo_tisen$protein)) %>%
  dplyr::mutate(organ = factor(organ, levels = organs_ordered, ordered = T)) %>%
  arrange(organ, sample_type) %>%
  dplyr::mutate(organ = as.character(organ))

identical(colnames(df_tisen_organ)[-(1:3)], protinfo_tisen$protein) # TRUE


# keepna
pm <- df_tisen_organ %>% select(-(1:3))
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ$label

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ)[-(1:3)]
row.organ <- protinfo_tisen$organ

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen$protein, '_', protinfo_tisen$symbol), row.names = protinfo_tisen$protein)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.organ=factor(row.organ, levels = organs_ordered, ordered = T),
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(#Type = df_tisen_organ$sample_type,
                      Organ = factor(df_tisen_organ$organ, levels = organs_ordered, ordered = T),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
# qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
# col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
# set.seed(10)
# organ_color <- sample(col_vector, length(unique(ann_col$Organ)))
# names(organ_color) <- unique(ann_col$Organ)
df_color <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/input/PUH_tissue_colorset_20230210.xlsx')
organs <- c(df_color$tissue[1:51], setdiff(df_tisen_organ$organ, df_color$tissue[1:51]))
organ_color <- str_c('#', df_color$color[1:length(organs)])
names(organ_color) <- organs
organ_color <- organ_color[unique(df_tisen_organ$organ)] # remain organs only exists (25 cancers)

# # cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])
# cancer_color <- c("#EB4444", "#38C95C")
# names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(Organ=organ_color,row.organ=organ_color#, Type=cancer_color
                   )

x <- cumsum(table(ann_row$row.organ))[-length(cumsum(table(ann_row$row.organ)))]
pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                   border_color = F,
                   annotation_col = ann_col, annotation_row = ann_row,
                   gaps_col = cumsum(table(ann_col$Organ))[-length(cumsum(table(ann_col$Organ)))],
                   gaps_row = x[!duplicated(x)],
                   fontsize_row=3,
                   annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                   cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F
)

# plot
dim(pm_heat) # 1493  25
a <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                   border_color = F,
                   annotation_col = ann_col, annotation_row = ann_row,
                   gaps_col = cumsum(table(ann_col$Organ))[-length(cumsum(table(ann_col$Organ)))],
                   gaps_row = x[!duplicated(x)],
                   fontsize_row=3,
                   annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                   cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F,
                   filename = "TPHP_Carcinoma_Ulhen_tissue_enriched_heatmap_scale_1493protein_25labels_20230318.pdf",width=11,height=11
)

b <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                   border_color = F,
                   annotation_col = ann_col, annotation_row = ann_row,
                   gaps_col = cumsum(table(ann_col$Organ))[-length(cumsum(table(ann_col$Organ)))],
                   gaps_row = x[!duplicated(x)],
                   fontsize_row=3,
                   annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                   cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F,
                   filename = "TPHP_Carcinoma_Ulhen_tissue_enriched_heatmap_scale_1493protein_25labels_big_20230318.pdf",width=20,height=50)



```

### use top3 enriched proteins
```{r}
# --------- top3 proteins ----------
enrich_top3_ls <- plyr::dlply(protinfo_tisen, c('organ', 'sample_type'), function(dfsub){
  # dfsub <- protinfo_tisen %>% filter(tissue_type == 'ADG')
  pm <- df_tisen_organ %>% select(all_of(dfsub$protein))
  med1_over_med2 <- apply(pm, 2, function(acol) { # calculate median_1st / median_2nd
    acol_sorted <- sort(acol, decreasing = T)
    return(acol_sorted[1] / acol_sorted[2])
  })
  enrich_top3 <- sort(med1_over_med2, decreasing = T) %>% head(3) %>% names() # top3
  return(enrich_top3)
})
prot_top3 <- unlist(enrich_top3_ls) # top3
protinfo_tisen_top3 <- protinfo_tisen %>%
  filter(protein %in% all_of(prot_top3))

df_tisen_organ_top3 <- df_tisen_organ %>%
  select(label, organ, sample_type, all_of(protinfo_tisen_top3$protein))

identical(colnames(df_tisen_organ_top3)[-(1:3)], protinfo_tisen_top3$protein) # TRUE


# keepna
pm <- df_tisen_organ_top3 %>% select(-(1:3))
pm %<>% log2()
pm <- apply(pm, c(1, 2), as.numeric) %>% t() %>% data.frame()
names(pm) <- df_tisen_organ_top3$label

# # quantile
# pm_qu <- preprocessCore::normalize.quantiles(as.matrix(pm),copy=TRUE) %>% as.data.frame()
# rownames(pm_qu) <- rownames(pm)
# colnames(pm_qu) <- colnames(pm)
# pm <- pm_qu

# heatmap
# na_pos <- is.na(pm)
# na_fill <- min(pm, na.rm = T) + log2(0.1)
# pm[is.na(pm)] <- na_fill
pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# pm.scale[na_pos] <- NA
names(pm.scale) <- names(pm)

prot <- colnames(df_tisen_organ_top3)[-(1:3)]
row.organ <- protinfo_tisen_top3$organ

# pm.scale <- apply(pm, 1, scale) %>% t() %>% data.frame()
# names(pm.scale) <- df_tisen$FileName
pm_heat <- pm.scale[prot,]

# concatenate uniprotid and gene names
uniprot_gene <- data.frame(prot = paste0(protinfo_tisen_top3$protein, '_', protinfo_tisen_top3$symbol), row.names = protinfo_tisen_top3$protein)
srt <- row.names(pm_heat)
pm_heat <- merge(pm_heat, uniprot_gene, by = 'row.names')
row.names(pm_heat) <- pm_heat$prot
pm_heat <- pm_heat[, -grep('^Row\\.names$|^prot$', colnames(pm_heat))]
pm_heat <- pm_heat[srt, ]


# set labels
ann_row <- data.frame(row.organ=factor(row.organ, levels = organs_ordered, ordered = T),
                      row.names =  row.names(pm_heat))
ann_col <- data.frame(#Type = df_tisen_organ_top3$sample_type,
                      Organ = factor(df_tisen_organ_top3$organ, levels = organs_ordered, ordered = T),
                      row.names = names(pm_heat))

# set colors
require(RColorBrewer)
# qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
# col_vector <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
# set.seed(10)
# organ_color <- sample(col_vector, length(unique(ann_col$Organ)))
# names(organ_color) <- unique(ann_col$Organ)
df_color <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/input/PUH_tissue_colorset_20230210.xlsx')
organs <- c(df_color$tissue[1:51], setdiff(df_tisen_organ_top3$organ, df_color$tissue[1:51]))
organ_color <- str_c('#', df_color$color[1:length(organs)])
names(organ_color) <- organs
organ_color <- organ_color[unique(df_tisen_organ_top3$organ)] # remain organs only exists (25 cancers)

# cancer_color <- c(brewer.pal(10,"Paired")[c(6,8,3)])
cancer_color <- c("#EB4444", "#38C95C")
names(cancer_color) <- c('1_carcinoma', '2_adjacent')
ann_colors <- list(Organ=organ_color,row.organ=organ_color#, Type=cancer_color
                   )
dim(pm_heat) # 62 25

x <- cumsum(table(ann_row$row.organ))[-length(cumsum(table(ann_row$row.organ)))]
c <- pheatmap::pheatmap(pm_heat, color = c(brewer.pal(11,"RdYlBu")[9:7],brewer.pal(11,"RdYlBu")[4:2]), fontsize_col = 8,
                   border_color = F,
                   annotation_col = ann_col, annotation_row = ann_row,
                   gaps_col = cumsum(table(ann_col$Organ))[-length(cumsum(table(ann_col$Organ)))],
                   gaps_row = x[!duplicated(x)],
                   fontsize_row=5,
                   annotation_colors = ann_colors,na_col = "grey60",#scale = "row",
                   cluster_rows = F, cluster_cols = F,show_rownames = T, show_colnames = F,
                   filename = "TPHP_Carcinoma_Ulhen_tissue_enriched_heatmap_scale_62protein_25labels_20230318.pdf",width=6,height=7
)


```


# 2023-03-18 TCGA Curated Pathways
```{r}
# TCGA Curated Pathways
library(tidyverse)
library(magrittr)
# source('//172.16.13.136/share/members/jiangwenhao/TPHP/my_fun.R')

# function
read_excel_allsheets <- function(filename, tibble = FALSE) {
  # read all columns as character
  # I prefer straight data.frames
  # but if you like tidyverse tibbles (the default with read_excel)
  # then just pass tibble = TRUE
  sheets <- readxl::excel_sheets(filename)
  x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X, col_types = 'text'))
  if(!tibble) x <- lapply(x, as.data.frame)
  names(x) <- sheets
  x
}

# pathway 10 (Table S3)
TCGA_pathway10 <- read_excel_allsheets('//172.16.13.136/share/members/jiangwenhao/TPHP/input/1-s2.0-S0092867418303593-mmc3.xlsx')
TCGA_pathway10_ <- head(TCGA_pathway10, 10)
colnames(TCGA_pathway10_[["Cell Cycle"]]) <- TCGA_pathway10_[["Cell Cycle"]][2, ]
TCGA_pathway10_[["Cell Cycle"]] %<>% slice(-(1:2))


df_pathway <- plyr::ldply(TCGA_pathway10_, .id = 'Pathway')
df_pathway[!(df_pathway$`OG/TSG` %in% c('OG', 'TSG')), 'OG/TSG'] <- NA


# # check
# df_pathway %>% count(`OG/TSG`)
# TCGA_mat <- read_excel_allsheets('//172.16.13.136/share/members/jiangwenhao/TPHP/input/1-s2.0-S0092867418303593-mmc4.xlsx')
# ptn_na <- df_pathway %>% filter(is.na(`OG/TSG`)) %>% pull(Gene) %>% str_c(collapse = '|')
# str_subset(TCGA_mat$`Alteration level`[2, ], ptn_na)
# ptn <- df_pathway %>% filter(!is.na(`OG/TSG`)) %>% pull(Gene) %>% str_c(collapse = '|')
# str_subset(TCGA_mat$`Alteration level`[2, ], ptn)
# 
# df_check <- TCGA_mat$`Alteration level`
# colnames(df_check) <- df_check[2, ]
# df_check %<>% slice(-(1:2))
# colnames(df_check)[-1] %>% str_split('\\.') %>% sapply(tail, 1) %>% unique() %>% intersect((df_pathway %>% filter(is.na(`OG/TSG`)) %>% pull(Gene)))


# # read carcinoma-adjacent difference matrix
# df1 <- read.csv('//172.16.13.136/share/members/yuel/2022/tables/20230226_PUH_submatrix_combine_05NA_paired_diff_matrix_v2.csv', check.names = F) %>% select(-1) # raw scale
# df1[df1$organ == 'cervix_uteri', 'organ'] <- 'cervix uteri'
# colnames(df1)[1:7]
# # [1] ""DIA_ID"                    "sample_type"               "tissue_name"
# # [4] "patient_ID"                "anatomical_classification" "organ"                     "A0A075B6H7"
# 
# 
# # organ x protein matrix (raw scale)
# df_organ <- df1 %>% select(-(DIA_ID:anatomical_classification)) %>%
#   group_by(organ) %>%
#   summarise_all(median, na.rm = T) # median
# 
# df_organ[2, "organ"] == "cervix uteri" # TRUE
# df_organ[2, "organ"] <- "cervix uteri"


# DEP -------------------------------------------------------
xlsx_vec <- list.files('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/', '^20230318_CA_ADJ_volcanoplot.+?\\.xlsx$', full.name = T)
name1_ls <- lapply(xlsx_vec, function(xlsx){
  df1 <- readxl::read_excel(xlsx, sheet = 'up')
  df2 <- readxl::read_excel(xlsx, sheet = 'down')
  ret <- rbind(df1, df2)
  return(ret)
})
names(name1_ls) <- str_extract(xlsx_vec, '0\\.05p.+\\.xlsx$') %>%
  str_replace('^0\\.05p_', '') %>%
  str_replace('\\.xlsx$', '')
# identical(unique(df_organ$organ), names(name1_ls)) # FALSE
# which(unique(df_organ$organ) != names(name1_ls)) # 2
names(name1_ls)[2] == 'cervix uteri' # FALSE
names(name1_ls)[2] <- 'cervix uteri'
df_dep <- plyr::ldply(name1_ls, .id = 'organ') %>% rename(protein = prot)


# map uniprotid to symbol
gene_uni_map <- clusterProfiler::bitr(df_dep$protein, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T)
gene_uni_map %<>% filter(SYMBOL %in% df_pathway$Gene | SYMBOL %in% df_pathway$`Aliases Used`)
gene_uni_map %>% count(UNIPROT) %>% filter(n > 1) # zero rows
gene_uni_map %>% filter(SYMBOL %in% df_pathway$`Aliases Used`) %>% pull(SYMBOL)
# "STK4", "MST1"

# df_pathway %>% filter(Gene %in% gene_uni_map$SYMBOL)
# df_pathway %>% filter(Gene %in% gene_uni_map$SYMBOL) %>% count(`OG/TSG`)
# intersect(gene_uni_map$SYMBOL, df_pathway$Gene)
# df_pathway %>% filter(Gene %in% gene_uni_map$SYMBOL) %>% count(`OG/TSG`)

# # Swap `Aliases Used` and `Gene` to map `Gene`
# gene_map_alias <- gene_uni_map %>% filter(SYMBOL %in% df_pathway$`Aliases Used`) %>% pull(SYMBOL)
# pos <- which(df_pathway$`Aliases Used` %in% gene_map_alias)
# swap <- df_pathway$Gene[pos]
# df_pathway[pos, 'Gene'] <- df_pathway$`Aliases Used`[pos]
# df_pathway[pos, 'Aliases Used'] <- swap

# # Curated DEPs; remain all UniprotID in PHU dataset
# df_dep1 <- df_dep %>%
#   right_join(., gene_uni_map, by = c('protein' = 'UNIPROT')) # match gene name; remain all UniprotID in PHU dataset
# df_pathway %>%
#   left_join(., gene_uni_map, by = c('SYMBOL' = 'Gene')) %>% # match 10 TCGA curated pathways
#   rename(Gene = SYMBOL) # rename column
# 
# colnames(df_dep1)
# df_dep1 %>% count(organ, Pathway)



# Curated DEPs; remain all UniprotID in PHU dataset
df_dep1 <- df_dep %>%
  right_join(., gene_uni_map, by = c('protein' = 'UNIPROT')) %>% # match gene name; remain all UniprotID in PHU dataset
  inner_join(., df_pathway, by = c('SYMBOL' = 'Gene')) %>% # match 10 TCGA curated pathways
  rename(Gene = SYMBOL) # rename column

df_dep2 <- df_dep %>%
  right_join(., gene_uni_map, by = c('protein' = 'UNIPROT')) %>% # match gene name; remain all UniprotID in PHU dataset
  inner_join(., df_pathway, by = c('SYMBOL' = 'Aliases Used')) %>% # match 10 TCGA curated pathways; with Aliases Used
  rename(`Aliases Used` = SYMBOL) # rename column

df <- bind_rows(df_dep1, df_dep2)
length(unique(df$protein)) == length(unique(gene_uni_map$UNIPROT)) # TRUE


# statistics
df_n <- df %>% count(organ, Pathway)
df_n_wide <- df_n %>% pivot_wider(Pathway, names_from = 'organ', values_from = 'n')
df_n_wide <- df %>%
  distinct(protein, Pathway) %>%
  count(Pathway, name = 'Total DEPs') %>%
  inner_join(df_n_wide, ., by = 'Pathway')


# add total proteins instead of DEPs
df_CA <- readxl::read_excel("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230116TPHP_CA_remove_allNA_1099_13392.xlsx",
                   col_types = c(rep('guess', 5), rep('numeric', 13392)), na = '')
gene_uni_map_all <- clusterProfiler::bitr(na.omit(union(df_pathway$Gene, df_pathway$`Aliases Used`)), fromType = "SYMBOL",toType = "UNIPROT",OrgDb = "org.Hs.eg.db",drop = T)
gene_uni_map_all %<>% filter(UNIPROT %in% colnames(df_CA)) # detected in PHU CA dataset
df_map1 <- gene_uni_map_all %>% inner_join(df_pathway, by = c(SYMBOL = 'Gene'))
df_map2 <- gene_uni_map_all %>% inner_join(df_pathway, by = c(SYMBOL = 'Aliases Used'))
df_map <- bind_rows(df_map1, df_map2)
df_n_wide <- df_map %>%
  distinct(UNIPROT, Pathway) %>%
  count(Pathway, name = 'Total detected') %>%
  inner_join(df_n_wide, ., by = 'Pathway')

# map to abbr
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
colnames(df_n_wide) %<>% sapply(function(e){
  ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e)
})
rio::export(df, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/TPHP_CA_TCGA_curatedPathway_20230318.xlsx')
# rio::export(df_n_wide, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/TPHP_CA_TCGA_curatedPathway_stat_20230306.xlsx')

# heatmap
df_n_long <- df_n_wide %>% pivot_longer(-Pathway, names_to = 'Organ', values_to = 'ProteinNumber')
df_n_long$Pathway %<>% factor(levels = unique(.), ordered = T)
df_n_long[is.na(df_n_long)] <- 0

#set order
# organs_ordered <- c('UTE', 'REC', 'PR', 'LU', 'KI', 'CO', 'SI', 'MAG', 'FT', 'LTH', 'OV', 'CE', 'PA', 'MU', 'THR', 'CU', 'THY', 'ST', 'GB', 'TE', 'LI', 'LN', 'ESO', 'TON', 'PEN')
heat_cor <- df_n_wide %>% column_to_rownames('Pathway') %>% select(-`Total DEPs`, -`Total detected`) %>%
  apply(1:2, as.numeric)
heat_cor[is.na(heat_cor)] <- 0
heat_cor <- cor(heat_cor, method = 'spearman')
heat_dist <- as.dist(1 - heat_cor) # 1-Spearman's rho
heat_tree <- hclust(heat_dist, method="complete")
organs_ordered <- heat_tree$labels[heat_tree$order]
organs_ordered %<>% rev() # for mapping to ggplot
df_n_long$Organ %<>% factor(levels = union(organs_ordered, .), ordered = T)

df_n_wide %<>% select(Pathway, all_of(organs_ordered), `Total DEPs`, `Total detected`)
rio::export(df_n_wide, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/TPHP_CA_TCGA_curatedPathway_stat_20230318.xlsx')

X <- df_pathway %>% select(Gene, Pathway) %>% count(Pathway, name = 'Total in TCGA') %>% 
  inner_join(df_n_wide, ., by = 'Pathway')
rio::export(X, '//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/TPHP_CA_TCGA_curatedPathway_stat_20230318_v2.xlsx')

# heatmap
df_heat <- df_n_long %>% filter(Organ %in% organs_ordered)

p <- ggplot(df_heat) + 
  geom_tile(aes(Organ, Pathway, fill= ProteinNumber)) +
  geom_text(aes(Organ, Pathway, label = ifelse(ProteinNumber > 0, ProteinNumber, NA)), size = 5, color = 'black') +
  scale_fill_gradient(low="white", high="#3388AA") +
  labs(
    x = 'Cancer type',
    y = 'TCGA curated pathways'
  )+
  scale_x_discrete(expand = c(0, 0))+
  coord_cartesian(xlim = c(0, length(unique(df_n_long$Organ))) * 1.05,
                  ylim = c(0, length(unique(df_n_long$Pathway)) * 1.3))+
  #theme_bw()+
  theme(panel.grid = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.text = element_text(size = 12,color = 'black'),
    axis.line = element_line(color = 'black'),
    axis.line.x = element_blank(),
    axis.line.y = element_blank(),
    plot.subtitle = element_text(size = 30, hjust = 0, color = 'black')
  )+
  theme(strip.text.x = element_text(size = 10, colour = "black"),
        legend.text = element_text(size = 12, color = 'black'), legend.position = 'right',
        legend.title = element_text(size = 15, color = 'black'))+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, vjust = 0.5 ,color = 'black', angle = 90),
        # axis.text.x = element_blank(),
        axis.ticks.x = element_blank()
  )+
  theme(axis.title.y = element_text(size = 12, hjust = 0.5, color = 'black', angle = 90),
        axis.text.y = element_text(size = 10,color = 'black', angle = 0),
        axis.ticks.y = element_blank()
  )

p1 <- p +
  annotate("text", x = length(unique(df_heat$Organ)) + 1, y = 1:length(unique(df_n_long$Pathway)), parse = T, label = filter(df_n_long, Organ == 'Total DEPs') %>% pull(ProteinNumber), size = 5, color = "black") +
  annotate("text", x = length(unique(df_heat$Organ)) + 2, y = 1:length(unique(df_n_long$Pathway)), parse = T, label = filter(df_n_long, Organ == 'Total detected') %>% pull(ProteinNumber), size = 5, color = "black") +
  annotate("text", x = length(unique(df_heat$Organ)) + 1, y = length(unique(df_n_long$Pathway)) * 1.05, label = 'Total DEPs', size = 5, color = "black", vjust = 0.5, hjust = 0, angle = 90) +
  annotate("text", x = length(unique(df_heat$Organ)) + 2, y = length(unique(df_n_long$Pathway)) * 1.05, label = 'Total detected', size = 5, color = "black", vjust = 0.5, hjust = 0, angle = 90)

ggsave('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/TPHP_CA_TCGA_curatedPathway_stat_20230318.pdf', p1, width = 12, height = 6.5)

```


# ==========================================
# 2023-03-18 DEP of three subtypes of gastric carcinoma
## DEPs were only in adenocarcinoma
```{r}
df_tmp %>% count(tissue_name)
#                         tissue_name  n
# 1            gastric adenocarcinoma 40
# 2           gastric mixed carcinoma 14
# 3 gastric poorly cohesive carcinoma  4

# reset df_tmp ------------
df_tmp <- df_pair[sapply(df_pair[, type_col], function(e){grepl(e, types_vec[i])}), ]
pm_tmp <- df_tmp %>% select(-(1:5))
pm_tmp <- pm_tmp[, apply(pm_tmp, 2, function(x) sum(is.na(x)) / length(x)) <= 0.5] # remove NA > 50%
tmp_ls[[i]] <- cbind(df_tmp[, (1:5)], pm_tmp) # save unfilled tables

pm_tmp[is.na(pm_tmp)] <- sample(na_pools, size = sum(is.na(unlist(pm_tmp))))
df_tmp <- cbind(df_tmp[, (1:5)], pm_tmp)

tmp <- table(df_tmp$cancer_type)
# continue to the next loop if the runs of any label less than two or the label types_vec less than two
if( any(tmp < 2) | length(tmp) %% 2 | length(tmp) < 2 ){ print(str_c('Skipped: ', i, ' -- ', types_vec[i])); next; }
# select rows and remove columns with all values being NA
df_tmp <- df_tmp[, !(colnames(df_tmp) %in% c(type_col, 'DDA_lib_type'))]
df_tmp <- df_tmp[, apply(df_tmp, 2, function(v){ sum(is.na(v)) < nrow(df_tmp) })]

# prepare plotting information
cancer_type <- df_tmp$cancer_type
lbls <- label_vec



# gastric adenocarcinoma------------
df_tmp %<>% filter(tissue_name == 'gastric adenocarcinoma')
mat <- apply(df_tmp[, !(colnames(df_tmp)) %in% colnames(df)[1:5]], c(1, 2), as.numeric)
dim(mat)

fc <- apply(2 ^ mat, 2, function(x){
  log2(mean(na.omit(x[cancer_type==lbls[1]])) / mean(na.omit(x[cancer_type == lbls[2]])))
})
pValue_t <- apply(mat, 2, function(v) {
  p1 <- try(t.test(v[cancer_type == lbls[1]], v[cancer_type == lbls[2]], paired = T, var.equal = F)$p.value)
  return(p1)
})
pAdj_t <- p.adjust(pValue_t,method="BH")
sum(abs(fc) >= 1 & pAdj_t < 0.05) # 205

# gastric mixed carcinoma------------
df_tmp %<>% filter(tissue_name == 'gastric mixed carcinoma')
mat <- apply(df_tmp[, !(colnames(df_tmp)) %in% colnames(df)[1:5]], c(1, 2), as.numeric)
dim(mat)

fc <- apply(2 ^ mat, 2, function(x){
  log2(mean(na.omit(x[cancer_type==lbls[1]])) / mean(na.omit(x[cancer_type == lbls[2]])))
})
pValue_t <- apply(mat, 2, function(v) {
  p1 <- try(t.test(v[cancer_type == lbls[1]], v[cancer_type == lbls[2]], paired = T, var.equal = F)$p.value)
  return(p1)
})
pAdj_t <- p.adjust(pValue_t,method="BH")
sum(abs(fc) >= 1 & pAdj_t < 0.05) # 0

# gastric mixed carcinoma------------
df_tmp %<>% filter(tissue_name == 'gastric poorly cohesive carcinoma')
mat <- apply(df_tmp[, !(colnames(df_tmp)) %in% colnames(df)[1:5]], c(1, 2), as.numeric)
dim(mat)

fc <- apply(2 ^ mat, 2, function(x){
  log2(mean(na.omit(x[cancer_type==lbls[1]])) / mean(na.omit(x[cancer_type == lbls[2]])))
})
pValue_t <- apply(mat, 2, function(v) {
  p1 <- try(t.test(v[cancer_type == lbls[1]], v[cancer_type == lbls[2]], paired = T, var.equal = F)$p.value)
  return(p1)
})
pAdj_t <- p.adjust(pValue_t,method="BH")
sum(abs(fc) >= 1 & pAdj_t < 0.05) # 0

```


# locally enriched proteins
## read data
```{r}
pacman::p_unload(pacman::p_loaded(), character.only = T)
rm(list = ls())
gc()
library(tidyverse)
library(magrittr)
source('//172.16.13.136/share/members/jiangwenhao/code/myQC.R')
setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/')

# cancer data
protinfo <- read.csv("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318yuel_TPHP_CA_F3_proteins.csv", check.names = F)
protinfo[protinfo$tissue_name_col == 'cervix uteri', 'tissue_name_col'] <- 'uterus'
protinfo[protinfo$tissue_name_col == 'colon', 'tissue_name_col'] <- 'large intestine'
protinfo[protinfo$tissue_name_col == 'rectum', 'tissue_name_col'] <- 'large intestine'

# normal data
normal_enrich <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/20230207yuel_TPHP_tissue_enriched1465_group_enriched2807_4086prot.csv')
normal_enrich %<>% filter(Classification == 'tissue enriched')
normal_enrich %<>% dplyr::select(tissue_type, UniprotID) %>% setNames(c('tissue_enrich', 'target_proteins'))

x <- normal_enrich$tissue_enrich %>% unique %>% sort
y <- protinfo$tissue_name_col %>% unique %>% sort
setdiff(x, y)
setdiff(y, x) # "lymph node"    "mammary gland" "pancreas"      "penis" 

protinfo <- inner_join(protinfo, normal_enrich, by = 'target_proteins')
protinfo %<>% filter(!(tissue_name_col %in% c('brain'))) # remove samples of brain which are too few
protinfo %<>% arrange(tissue_name_col, tissue_enrich)
protinfo1 <- protinfo %>% filter(tissue_name_col == tissue_enrich)
protinfo2 <- protinfo %>% filter(tissue_name_col != tissue_enrich)
View(protinfo2) # manually checked; without missing anything

protinfo1 %>% rio::export("20230318yuel_TPHP_CA_F3_proteins_normal_enriched_overlap.csv")


```


## carcinoma_specific_dysregulated & normal_enriched
```{r}
# locally enriched proteins
df_prot <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318yuel_TPHP_CA_F3_proteins_normal_enriched_overlap.csv')
df_prot$target_proteins
df_prot$tissue_name_col
dim(df_prot) # 15 3

# read CA and normal data
df_CA <- read.csv('//172.16.13.136/share/members/yuel/2022/tables/20230318_PUH_submatrix_combine_5_missing.csv', check.names = F) # CA combine 50 missing submatrice





```


# 2023-05-13 DIA data expression of `c('Q8WZ60', 'P78367', 'P56282')`
```{r}
library(tidyverse)
library(magrittr)
library(readxl)
library(writexl)
library(RColorBrewer)
setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/')

source("//172.16.13.136/share/members/yuel/2022/codes/20230207_ulhen_class.R")
# source("//172.16.13.114/share/members/yuel/1project/QC.R")
source('//172.16.13.136/share/members/jiangwenhao/code/myQC.R')
source('//172.16.13.136/share/members/jiangwenhao/TPHP/my_fun.R')



# crawl protein name from uniprot.org -------------------------------------
my_uniprot2prot <- function(vec_uni){
  vec_prot <- lapply(vec_uni, function(uniprotid){
    # my_html <- rvest::read_html(stringr::str_glue('https://www.uniprot.org/uniprotkb/{uniprotid}/entry'))
    my_html <- rvest::read_html(stringr::str_glue('https://rest.uniprot.org/genecentric/{uniprotid}')) # 2022-08-08 update; get json
    my_json <- my_html %>%
      rvest::html_text() %>%
      jsonlite::fromJSON()
    
    prot <- my_json$canonicalProtein$proteinName
    return(prot)
  }) %>% unlist
  return(stringr::str_c(vec_uni, vec_prot, sep = '_'))
}

# read matrix
df1 <- read.csv('//172.16.13.136/share/members/yuel/2022/tables/20230318_PUH_submatrix_combine_5_missing.csv', check.names = F) # CA combine 50 missing submatrice
df_pair <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_CA_ADJ_pairs_for_DPA_998_13390prot.xlsx')


# read dia specific proteins
dia_target <- read.csv('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318yuel_TPHP_CA_targetlist_3.csv', check.names = F)
#get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
colnames(dia_target) <- sapply(colnames(dia_target), function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

dia_specific <- dia_target %>% pivot_longer(cols = everything(), names_to = 'organ', values_to = 'prot', values_drop_na = T)
# tbl <- dia_specific %>% filter(prot %in% prot_validated) %>% mutate(data = 'DIA')

protinfo <- dia_specific
protinfo$cancer_type <- 'carcinoma'
protinfo %<>% arrange(organ, desc(cancer_type))
# add gene name
uni_entr <- clusterProfiler::bitr(protinfo$prot,fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T) %>% setNames(c('UniprotID', 'target_genes'))
protinfo <- dplyr::full_join(protinfo, uni_entr, by = c('prot' = 'UniprotID'))
protinfo %<>% rename(UniprotID = prot)


# df_prot <- rio::import('20230318_PUH_PRM_submatrix_combine_5_missing.csv') # use submatrix combine matrix
df_prot <- df1 %>% rename(cancer_type = sample_type) %>% select(-anatomical_classification)
colnames(df_prot)[1:6]
df_prot[str_detect(df_prot$organ, 'cervix'), 'organ'] <- 'cervix uteri'
df_prot$organ <- sapply(df_prot$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))
df_prot %>% count(organ)

# CHANGE TO CANCER NAME
ht_organ2cancer <- c('GBM', 'COCA', 'CESC', 'ESCA', 'FTCA', 'GBCA', 'RC', 'HCC', 'DLBCL', 'THYM', 'LUCA', 'BRCA', 'MUT', 'OC', 'PACA', 'PECA', 'PRCA', 'READ', 'GIST', 'GC', 'TGCT', 'LARCA', 'THCA', 'TOCA', 'ENCA')
names(ht_organ2cancer) <- c('CE', 'CO', 'CU', 'ESO', 'FT', 'GB', 'KI', 'LI', 'LN', 'LTH', 'LU', 'MAG', 'MU', 'OV', 'PA', 'PEN', 'PR', 'REC', 'SI', 'ST', 'TE', 'THR', 'THY', 'TON', 'UTE')
protinfo$organ <- ht_organ2cancer[protinfo$organ]
df_prot$organ <- ht_organ2cancer[df_prot$organ]
df_prot %<>% arrange(organ)
protinfo %<>% arrange(organ)

# 
# # remove brain and skin
# protinfo %<>% filter(!(organ %in% c('CE', 'SKI')))
# df_prot %<>% filter(!(organ %in% c('CE', 'SKI')))




# # filter missing ratio < 50%
# na_ratio <- c()
# for(i in 1:nrow(protinfo)){
#   this_prot <- protinfo$UniprotID[i]
#   this_organ <- protinfo$organ[i]
#   this_cancer <- protinfo$cancer_type[i]
# 
#   x <- df_prot %>% filter(organ == this_organ, cancer_type == this_cancer) %>%
#     pull(all_of(this_prot))
#   na_ratio[i] <- sum(is.na(x)) / length(x)
# }
# protinfo %<>% filter(all_of(na_ratio) < 0.5)

df_diff_all <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_dysregulated_proteins_filter50NAByOrgan.xlsx')
df_diff_all[str_detect(df_diff_all$organ, 'cervix'), 'organ'] <- 'cervix uteri'
df_diff_all$organ <- sapply(df_diff_all$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))


protinfo %<>% left_join(df_diff_all, by = c('organ', UniprotID = 'protein'))
df_prot %<>% dplyr::select(1:5, all_of(protinfo$UniprotID))


df_info <- df_prot %>% dplyr::select(1:5)
rownames(df_info) <- df_info$DIA_ID


# remark
df_prot[df_prot$cancer_type == 'carcinoma', 'cancer_type'] <- '1_carcinoma'
df_prot[df_prot$cancer_type == 'adjacent', 'cancer_type'] <- '2_adjacent'

# data prepare
df_expr <- df_prot %>%
  select(-DIA_ID) %>%
  select(organ, cancer_type, everything())
df_expr[df_expr$cancer_type == '1_carcinoma', 'cancer_type'] <- 'C'
df_expr[df_expr$cancer_type == '2_adjacent', 'cancer_type'] <- 'Adj'



source('//172.16.13.136/share/members/jiangwenhao/code/myQC.R')
df_log10 <- df_expr %>% mutate_if(is.numeric, log10)
na_filling <- log10(min(df_prot[, -(1:5)],na.rm = T)) + log10(0.5)


protinfo1 <- protinfo %>% filter(UniprotID %in% c('Q8WZ60', 'P78367', 'P56282'))
df_diff_all %>% filter(protein %in% protinfo1$UniprotID)
plots <- list()
for(i in 1:nrow(protinfo1)){
  # anno_txt <- str_glue("log2FC={round(protinfo$log2FC[i], 2)},\npAdj={signif(protinfo$pAdj[i], 3)}")
  # anno_txt <- sprintf("%1.2f (%1.2e)", 2 ^ protinfo$log2FC[i], protinfo$pAdj[i])
  anno_txt <- sprintf("%1.2e", protinfo1$pAdj_t[i])
  plots[[i]] <- df_log10 %>%
    select(organ, cancer_type, patient_ID, all_of(protinfo1$UniprotID[i])) %>%
    my_plot_CA_boxviolin_new(organ = protinfo1$organ[i], na_cutoff = 1, refer = 'local',
                         anno_txt = anno_txt, drawline = T)
}

p <- eval(parse(text = stringr::str_c('ggpubr::ggarrange(', stringr::str_c('plots[[', 1:length(plots), ']]$p', collapse = ', '), ', nrow = length(plots))')))
ggsave('TPHP_DIA_CA_specific_expr_boxviolin_line_F5_3prots_20230513_v3.pdf', p, width = 297, height = 210 / 2, units = "mm")
protinfo1 %>% rio::export('TPHP_DIA_CA_specific_expr_boxviolin_line_F5_3prots_20230513.xlsx')

```



# 2023-10-09 DIA data expression of `c('P54821', 'Q8TF66', 'Q9NRF2', 'Q9Y6X5', 'Q32P28')`
## function
```{r}
my_uniprot2prot <- function(vec_uni){
  vec_prot <- lapply(vec_uni, function(uniprotid){
    # my_html <- rvest::read_html(stringr::str_glue('https://www.uniprot.org/uniprotkb/{uniprotid}/entry'))
    my_html <- rvest::read_html(stringr::str_glue('https://rest.uniprot.org/genecentric/{uniprotid}')) # 2022-08-08 update; get json
    my_json <- my_html %>%
      rvest::html_text() %>%
      jsonlite::fromJSON()
    
    prot <- my_json$canonicalProtein$uniProtkbId %>% str_remove('_HUMAN$')
    return(prot)
  }) %>% unlist
  return(stringr::str_c(vec_uni, vec_prot, sep = '_'))
}



my_uniprot2gene <- function(vec_uni){
  vec_gene <- lapply(vec_uni, function(uniprotid){
    # my_html <- rvest::read_html(stringr::str_glue('https://www.uniprot.org/uniprotkb/{uniprotid}/entry'))
    my_html <- rvest::read_html(stringr::str_glue('https://rest.uniprot.org/genecentric/{uniprotid}')) # 2022-08-08 update; get json
    my_json <- my_html %>%
      rvest::html_text() %>%
      jsonlite::fromJSON()
    
    gene <- my_json$canonicalProtein$geneName
    return(gene)
  }) %>% unlist
  return(stringr::str_c(vec_uni, vec_gene, sep = '_'))
}

myplot <- function(df, na_cutoff = 0.5, refer = 'local', label_simple = F, anno_txt = NULL, drawviolin = F, drawline = F){
  df %<>%
    add_column(label = stringr::str_c(df$organ, ' (', df$cancer_type, ')'), .before = 1) %>%
    dplyr::mutate(cancer_type = factor(cancer_type, levels = c('Adj', 'C'))) %>%
    arrange(organ, cancer_type) %>%
    dplyr::mutate(cancer_type = as.character(cancer_type))
  
  #remove organ with all subtypes > na_cutoff NA ratio
  na_ratio <- function(x) sum(is.na(x)) / length(x)
  organ_selected <- df %>% dplyr::group_by(organ, cancer_type) %>%
    summarise_at(vars(2), list(na_ratio = 'na_ratio')) %>%
    ungroup() %>%
    filter(na_ratio <= na_cutoff) %>%
    pull(organ) %>%
    unique()
  
  df %<>% filter(organ %in% organ_selected)
  
  rlt <- list()
  my_uni <- colnames(df) %>% tail(1)
  set.seed(2023)
  if(!exists('na_filling')){
    na_filling <- min(df[, ncol(df)], na.rm = T)
  }
  df[is.na(df %>% pull(all_of(my_uni))), my_uni] <- na_filling+log10(rnorm(sum(is.na(df %>% select(all_of(my_uni)))),mean=1,sd=0.05))
  df_fillrate <- df
  if(refer == 'uniprot'){
    my_title <- my_uniprot2gene(my_uni)
  } else if(refer == 'local'){
    my_title <- clusterProfiler::bitr(my_uni, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T) %>% unite(label) %>% pull()
  }
  # 
  # if(!is.null(organ)){
  #   my_title <- str_c(my_title, organ, sep = '_')
  # }
  colnames(df_fillrate)[ncol(df_fillrate)] <- colnames(df)[ncol(df)] <- c('intensity')
  
  
  # df <- na.omit(df)
  
  
  library(ggplot2)
  df_lines_wide <- df %>%
    pivot_wider(id_cols = c('patient_ID'), names_from = 'cancer_type', values_from = 'intensity',
                values_fn = mean) %>%
    mutate(Type = ifelse(Adj < C, 'Up', 'Down'))
  
  df_lines <- df_lines_wide %>%
    pivot_longer(c('Adj', 'C'), names_to = 'cancer_type', values_to = 'intensity') %>%
    left_join(df %>% select(-cancer_type, -intensity, -label) %>% distinct(), by = 'patient_ID') %>%
    mutate(label = str_glue("{organ} ({cancer_type})"))
  
  p <- #df %>% select(-patient_ID) %>% group_by(label, organ, cancer_type) %>% summarise_at(vars(intensity), median) %>%
    ggplot(df) +
    aes(x = label, y = intensity) +
    geom_jitter(color = '#000000', size=0.3, alpha=0.5) +
    geom_boxplot(aes(color = cancer_type), outlier.shape = NA, width = 0.3, fill = 'white') +
    # geom_col(aes(color = cancer_type), width = 0.3, fill = 'white') +
    scale_color_manual(values = c(C = '#E41A1C', Adj = '#377EB8')) +
    geom_vline(xintercept = str_which(unique(df$label), '\\(C\\)') + 0.5, color = '#000000', linetype = 'dashed') +
    labs(
      y = 'Log10 Intensity Median', title = my_title
    )+
    theme(panel.grid = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.text = element_text(size = 12,color = 'black'),
          axis.line = element_line(color = 'black'),
          axis.line.x = element_blank(),
          plot.subtitle = element_text(size = 30, hjust = 0, color = 'black')
    )+
    theme(legend.text = element_text(size = 12, color = 'black'), legend.position = 'none',
          legend.title = element_text(size = 15, color = 'black'))+
    theme(axis.title.x = element_blank(),
          #axis.text.x = element_text(size = 12, vjust = 0.5 ,color = 'black', angle = 90),
          axis.text.x = element_blank(),
          #axis.ticks.x = element_blank()
    )+
    theme(axis.title.y = element_text(size = 12, hjust = 0.5, color = 'black', angle = 90),
          axis.text.y = element_text(size = 10,color = 'black', angle = 0),
          #axis.ticks.y = element_blank()
    )
  
  if(!label_simple){
    p <- p + annotate('text', x = seq(1.5, by = 2, length.out = length(unique(df$organ))), y = max(df$intensity, na.rm = T) * 1.1, label = unique(df$organ), size = 4, hjust = 0.5, vjust = 1)
  }
  
  anno_txt <- anno_txt[anno_txt < 0.05] %>% setNames(names(anno_txt)[anno_txt < 0.05])
  p <- p + ggpubr::geom_signif(comparisons = data.frame(str_c(names(anno_txt), c('(C)'), sep = ' '), str_c(names(anno_txt), c('(Adj)'), sep = ' ')) %>% t() %>% as.data.frame() %>% as.list(),
                               annotations = sprintf('%1.2e', anno_txt), size = 0.5, textsize = 2.5,
                               y_position = df %>% select(-patient_ID) %>% group_by(label, organ, cancer_type) %>% summarise_at(vars(intensity), median) %>% pull(intensity) %>% max(),
                               # tip_length = 0.04,
                               hjust = 0.5, vjust = 0)
  
  rlt$p <- p
  return(rlt)
}


myplot_N <- function(df, organ, na_cutoff = 0.5, refer = 'local', anno_txt = NULL, drawviolin = F){
  # for locally enriched proteins
  df %<>%
    add_column(label = stringr::str_c(df$organ, ' (', df$cancer_type, ')'), .before = 1) %>%
    dplyr::mutate(cancer_type = factor(cancer_type, levels = c('N', 'Adj', 'C'), ordered = T)) %>%
    arrange(organ, cancer_type) %>%
    dplyr::mutate(label = factor(label, levels = unique(label), ordered = T))
  
  #remove organ with all subtypes >= na_cutoff NA ratio50% in default
  na_ratio <- function(x) sum(is.na(x)) / length(x)
  organ_selected <- df %>% dplyr::group_by(organ, cancer_type) %>%
    summarise_at(vars(2), list(na_ratio = 'na_ratio')) %>%
    ungroup() %>%
    filter(na_ratio <= na_cutoff) %>%
    pull(organ) %>%
    unique()
  
  df %<>% filter(organ %in% organ_selected)
  
  rlt <- list()
  my_uni <- colnames(df) %>% tail(1)
  set.seed(2023)
  if(!exists('na_filling')){
    na_filling <- min(df[, ncol(df)], na.rm = T)
  }
  df[is.na(df %>% pull(all_of(my_uni))), my_uni] <- na_filling+log10(rnorm(sum(is.na(df %>% select(all_of(my_uni)))),mean=1,sd=0.05))
  df_fillrate <- df
  if(refer == 'uniprot'){
    my_title <- my_uniprot2gene(my_uni)
  } else if(refer == 'local'){
    my_title <- clusterProfiler::bitr(my_uni, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T) %>% unite(label) %>% pull()
  }
  
  if(!is.null(organ)){
    my_title <- str_c(my_title, organ, sep = '_')
  }
  colnames(df_fillrate)[ncol(df_fillrate)] <- colnames(df)[ncol(df)] <- c('intensity')
  
  
  # df <- na.omit(df)
  
  
  # sort by median (decreasing)
  df_med <- df %>% group_by(label) %>% summarise(med = median(intensity)) %>% arrange(desc(med))
  df %<>% mutate(label = factor(label, levels = df_med$label, ordered = T)) %>%
    arrange(label)
  
  
  library(ggplot2)
  
  p <- df %>% select(-patient_ID) %>% group_by(label, organ, cancer_type) %>% summarise_at(vars(intensity), median) %>% 
    ggplot() +
    aes(x = label, y = intensity) +
    # geom_col(aes(color = cancer_type), width = 0.3, fill = 'white') +
    geom_col(aes(fill = cancer_type), width = 0.3, color = NA) +
    # scale_color_manual(values = c(N = 'green4')) +
    scale_fill_manual(values = c(N = 'green4')) +
    # geom_violin(width = 1, color = '#888888') +
    # geom_boxplot(outlier.shape = NA, width = 0.3, color = '#888888') +
    # stat_summary(fun = median, geom = 'point', size = 2, color = '#666666')+
    # stat_summary(data = df[df$organ == organ, ], fun = median, geom = 'point', size = 2, color = 'blue')+
    # geom_jitter(aes(color = cancer_type), size=1.5, alpha=0.1) +
    # scale_fill_manual(values = c(C = '#CF3F54', Adj = '#99CFD1', N = 'blue')) +
    # scale_color_manual(values = c(C = '#CF3F54', Adj = '#99CFD1', N = 'blue')) +
    # geom_vline(xintercept = str_which(unique(df$label), '\\(C\\)') + 0.5, color = '#000000', linetype='dashed') +
    annotate('text', x = seq_along(unique(df$label)), y = max(df %>% select(-patient_ID) %>% group_by(label, organ, cancer_type) %>% summarise_at(vars(intensity), median) %>% pull(intensity), na.rm = T) * 1.05, label = unique(df$organ), size = 3, hjust = 0.5, vjust = 0.5, angle = 90) +
    labs(
      y = 'Log10 Intensity Median', title = my_title
    )+
    scale_y_continuous(limits = c(0, 16), breaks = seq(0, 15, 5)) +
    theme(panel.grid = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.text = element_text(size = 8,color = 'black'),
          axis.line = element_line(color = 'black'),
          axis.line.x = element_blank(),
          plot.title = element_text(size = 8, hjust = 0, color = 'black'),
          plot.subtitle = element_text(size = 8, hjust = 0, color = 'black')
    )+
    theme(legend.text = element_text(size = 8, color = 'black'), legend.position = 'none',
          legend.title = element_text(size = 8, color = 'black'))+
    theme(axis.title.x = element_blank(),
          # axis.text.x = element_text(size = 12, vjust = 0.5 ,color = 'black', angle = 90),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()
    )+
    theme(axis.title.y = element_text(size = 8, hjust = 0.5, color = 'black', angle = 90),
          axis.text.y = element_text(size = 8,color = 'black', angle = 0),
          #axis.ticks.y = element_blank()
    )
  if(!is.null(anno_txt)){
    p <- p + annotate('text', x = seq_along(unique(df$label)),
                      y = max(df$intensity, na.rm = T) * 1.03,
                      label = anno_txt, size = 4, hjust = 0.5, vjust = 1)
  }
  rlt$p <- p
  return(rlt)
}


```

## main
### CA
```{r}
library(tidyverse)
library(magrittr)
library(readxl)
library(writexl)
library(RColorBrewer)
setwd('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/')

source("//172.16.13.136/share/members/yuel/2022/codes/20230207_ulhen_class.R")
# source("//172.16.13.114/share/members/yuel/1project/QC.R")
source('//172.16.13.136/share/members/jiangwenhao/code/myQC.R')
source('//172.16.13.136/share/members/jiangwenhao/TPHP/my_fun.R')



# crawl protein name from uniprot.org -------------------------------------
my_uniprot2prot <- function(vec_uni){
  vec_prot <- lapply(vec_uni, function(uniprotid){
    # my_html <- rvest::read_html(stringr::str_glue('https://www.uniprot.org/uniprotkb/{uniprotid}/entry'))
    my_html <- rvest::read_html(stringr::str_glue('https://rest.uniprot.org/genecentric/{uniprotid}')) # 2022-08-08 update; get json
    my_json <- my_html %>%
      rvest::html_text() %>%
      jsonlite::fromJSON()
    
    prot <- my_json$canonicalProtein$proteinName
    return(prot)
  }) %>% unlist
  return(stringr::str_c(vec_uni, vec_prot, sep = '_'))
}

# read matrix
df1 <- read.csv('//172.16.13.136/share/members/yuel/2022/tables/20230318_PUH_submatrix_combine_5_missing.csv', check.names = F) # CA combine 50 missing submatrice
df_pair <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_CA_ADJ_pairs_for_DPA_998_13390prot.xlsx')


# dia_target <- read.csv('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318yuel_TPHP_CA_targetlist_3.csv', check.names = F)
#get abbreviations
df_abbr <- read.delim('//172.16.13.136/share/members/jiangwenhao/TPHP/input/sample_types_abbr_20230113.txt', stringsAsFactors = F, check.names = F, na.strings = '')
h <- hash::hash(keys = df_abbr$'Entire', values = df_abbr$'Abbr')
# colnames(dia_target) <- sapply(colnames(dia_target), function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))

# dia_specific <- dia_target %>% pivot_longer(cols = everything(), names_to = 'organ', values_to = 'prot', values_drop_na = T)
# tbl <- dia_specific %>% filter(prot %in% prot_validated) %>% mutate(data = 'DIA')

# protinfo <- dia_specific
protinfo <- data.frame(prot = c('P54821', 'Q8TF66', 'Q9NRF2', 'Q9Y6X5', 'Q32P28'), cancer_type = 'carcinoma')
# protinfo$cancer_type <- 'carcinoma'
# protinfo %<>% arrange(organ, desc(cancer_type))
# add gene name
uni_entr <- clusterProfiler::bitr(protinfo$prot,fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db",drop = T) %>% setNames(c('UniprotID', 'target_genes'))
protinfo <- dplyr::full_join(protinfo, uni_entr, by = c('prot' = 'UniprotID'))
protinfo %<>% rename(UniprotID = prot)


# df_prot <- rio::import('20230318_PUH_PRM_submatrix_combine_5_missing.csv') # use submatrix combine matrix
df_prot <- df1 %>% rename(cancer_type = sample_type) %>% select(-anatomical_classification)
colnames(df_prot)[1:6]
df_prot[str_detect(df_prot$organ, 'cervix'), 'organ'] <- 'cervix uteri'
df_prot$organ <- sapply(df_prot$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))
df_prot %>% count(organ)

# CHANGE TO CANCER NAME
ht_organ2cancer <- c('GBM', 'COCA', 'CESC', 'ESCA', 'FTCA', 'GBCA', 'RC', 'HCC', 'DLBCL', 'THYM', 'LUCA', 'BRCA', 'MUT', 'OC', 'PACA', 'PECA', 'PRCA', 'READ', 'GIST', 'GC', 'TGCT', 'LARCA', 'THCA', 'TOCA', 'ENCA')
names(ht_organ2cancer) <- c('CE', 'CO', 'CU', 'ESO', 'FT', 'GB', 'KI', 'LI', 'LN', 'LTH', 'LU', 'MAG', 'MU', 'OV', 'PA', 'PEN', 'PR', 'REC', 'SI', 'ST', 'TE', 'THR', 'THY', 'TON', 'UTE')
# protinfo$organ <- ht_organ2cancer[protinfo$organ]
df_prot$organ <- ht_organ2cancer[df_prot$organ]
df_prot %<>% arrange(organ)
# protinfo %<>% arrange(organ)

# 
# # remove brain and skin
# protinfo %<>% filter(!(organ %in% c('CE', 'SKI')))
# df_prot %<>% filter(!(organ %in% c('CE', 'SKI')))




# # filter missing ratio < 50%
# na_ratio <- c()
# for(i in 1:nrow(protinfo)){
#   this_prot <- protinfo$UniprotID[i]
#   this_organ <- protinfo$organ[i]
#   this_cancer <- protinfo$cancer_type[i]
# 
#   x <- df_prot %>% filter(organ == this_organ, cancer_type == this_cancer) %>%
#     pull(all_of(this_prot))
#   na_ratio[i] <- sum(is.na(x)) / length(x)
# }
# protinfo %<>% filter(all_of(na_ratio) < 0.5)

df_diff_all <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_dysregulated_proteins_filter50NAByOrgan.xlsx')
df_diff_all[str_detect(df_diff_all$organ, 'cervix'), 'organ'] <- 'cervix uteri'
df_diff_all$organ <- sapply(df_diff_all$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))


protinfo %<>% left_join(df_diff_all, by = c(UniprotID = 'protein'))
df_prot %<>% dplyr::select(1:5, all_of(protinfo$UniprotID))


df_info <- df_prot %>% dplyr::select(1:5)
rownames(df_info) <- df_info$DIA_ID


# remark
df_prot[df_prot$cancer_type == 'carcinoma', 'cancer_type'] <- '1_carcinoma'
df_prot[df_prot$cancer_type == 'adjacent', 'cancer_type'] <- '2_adjacent'

# data prepare
df_expr <- df_prot %>%
  select(-DIA_ID) %>%
  select(organ, cancer_type, everything())
df_expr[df_expr$cancer_type == '1_carcinoma', 'cancer_type'] <- 'C'
df_expr[df_expr$cancer_type == '2_adjacent', 'cancer_type'] <- 'Adj'



source('//172.16.13.136/share/members/jiangwenhao/code/myQC.R')
df_log10 <- df_expr %>% mutate_if(is.numeric, log10)
na_filling <- log10(min(df_prot[, -(1:5)],na.rm = T)) + log10(0.5)

protinfo$organ <- ht_organ2cancer[protinfo$organ]
protinfo1 <- protinfo %>% filter(UniprotID %in% c('P54821', 'Q8TF66', 'Q9NRF2', 'Q9Y6X5', 'Q32P28'))
df_diff_all %>% filter(protein %in% protinfo1$UniprotID)
plots <- list()
plots_simple <- list()
for(i in 1:length(unique(protinfo1$UniprotID))){
  prot <- unique(protinfo1$UniprotID)[i]
  anno_txt <- protinfo1 %>% filter(UniprotID == prot) %>% pull(p_t)
  names(anno_txt) <- protinfo1 %>% filter(UniprotID == prot) %>% pull(organ)
  
  plots[[i]] <- df_log10 %>%
  select(organ, cancer_type, patient_ID, all_of(prot)) %>% 
    myplot(na_cutoff = 1, refer = 'uniprot', anno_txt = anno_txt, drawline = T)
  
  plots_simple[[i]] <- df_log10 %>%
  select(organ, cancer_type, patient_ID, all_of(prot)) %>% 
    myplot(na_cutoff = 1, refer = 'uniprot', label_simple = T, anno_txt = anno_txt, drawline = T)
}

p <- eval(parse(text = stringr::str_c('ggpubr::ggarrange(', stringr::str_c('plots[[', 1:length(plots), ']]$p', collapse = ', '), ', nrow = length(plots))')))
p_simple <- eval(parse(text = stringr::str_c('ggpubr::ggarrange(', stringr::str_c('plots_simple[[', 1:length(plots_simple), ']]$p', collapse = ', '), ', nrow = length(plots_simple))')))
ggsave('TPHP_DIA_CA_expr_5prots_20231010.pdf', p, width = 210, height = 297 / 2, units = "mm")
ggsave('TPHP_DIA_CA_expr_5prots_simple_20231010.pdf', p_simple, width = 210, height = 297 / 2, units = "mm")
protinfo1 %>% rio::export('TPHP_DIA_CA_expr_5prots_20231010.xlsx')

```

### N
```{r}
df<-readxl::read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/20220719_rm_randomNA_normal.xlsx")
ai<-readxl::read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/1_202207TPHP_1781file_info_edited_v4.xlsx")
di<-inner_join(ai,df[,c(1,16:ncol(df))],by="FileName")
table(di$patient_ID)
df0<-di[which(di$patient_ID %in% c("1","2","3","4","7","JD-1","JD-2","JD-3","JD-4")),]
dim(df0) # 497 12410
colnames(df0)[1:19]
pm1<-apply(df0[,-c(1:18)],c(1,2),as.numeric)
# # min(pm1,na.rm = T) # 9.795163
# # max(pm1,na.rm=T) # 24.00716
pm1 <- 2 ^ pm1 # log2 -> raw scale
# pm1[is.na(pm1)] <- min(pm1, na.rm = T) * 0.5
df0[,-c(1:18)] <- pm1
df_N <- df0 %>%
  select(DIA_ID, sample_type, tissue_name, patient_ID, anatomical_classification, DDA_lib_type, 19:ncol(df0)) %>%
  rename(organ = DDA_lib_type)


dim(df_N)
colnames(df_N)[1:7]
pm <- df_N %>% select(-(1:6))
# pm[is.na(pm)] <- min(pm, na.rm = T) * 0.5 # raw scale
pm[is.na(pm)] <- 2 # raw scale
pmlog2 <- log2(pm)

dfNlog2 <- df_N
dfNlog2[, -(1:6)] <- pmlog2
dfNlog2$organ <- sapply(dfNlog2$organ, function(e) ifelse(!is.null(h[[tolower(e)]]), h[[tolower(e)]], e))



# locally enriched
df_expr <- dfNlog2 %>%
  select(organ, sample_type, tissue_name, patient_ID, all_of(unique(protinfo1$UniprotID))) %>%
  rename(cancer_type = sample_type)
df_expr[df_expr$cancer_type == 'carcinoma', 'cancer_type'] <- 'C'
df_expr[df_expr$cancer_type == 'adjacent', 'cancer_type'] <- 'Adj'
df_expr[df_expr$cancer_type == 'Normal', 'cancer_type'] <- 'N'
# 
# types_CA <- df_expr %>% filter(cancer_type != 'N') %>% pull(organ)
# types_N <- df_expr %>% filter(cancer_type == 'N') %>% pull(organ)
# setdiff(types_CA, types_N) # "CO"  "CU"  "PEN" "REC"
# df_expr[df_expr$organ == 'LAI', ] # CO/REC
# df_expr[df_expr$organ == 'UTE' & df_expr$cancer_type == 'N', ] # UTE/CU
df_expr[df_expr$organ == 'CU', 'organ'] <- 'UTE'
df_expr[df_expr$organ %in% c('CO', 'REC'), 'organ'] <- 'LAI'



# normal only
plots <- list()
for(i in 1:length(unique(protinfo1$UniprotID))){
  prot <- unique(protinfo1$UniprotID)[i]
  # anno_txt <- protinfo1 %>% filter(UniprotID == prot) %>% pull(p_t)
  # names(anno_txt) <- protinfo1 %>% filter(UniprotID == prot) %>% pull(organ)
  
  # plots[[i]] <- df_log2 %>%
  #   select(organ, cancer_type, patient_ID, all_of(prot)) %>% 
  #   myplot(na_cutoff = 1, refer = 'uniprot', anno_txt = anno_txt, drawline = T)
  # 
  
  df <- df_expr %>%
    select(organ, cancer_type, patient_ID, all_of(prot)) %>%
    filter(cancer_type == 'N')
  plots[[i]] <- myplot_N(df, organ = NULL, na_cutoff = 1, refer = 'uniprot', anno_txt = NULL)
}
p <- eval(parse(text = stringr::str_c('ggpubr::ggarrange(', stringr::str_c('plots[[', 1:length(plots), ']]$p', collapse = ', '), ', nrow = length(plots))')))
ggsave('TPHP_DIA_N_expr_5prots_20231212.pdf', p, width = 210, height = 297 / 2, units = "mm")


```

# 2023-10-23 brain & liver
## read data
```{r}
pacman::p_unload(pacman::p_loaded(), character.only = T)
library(tidyverse)
library(magrittr)

# DEA results
df_dea <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/diff_expr/20230318_TPHP_dysregulated_proteins_filter50NAByOrgan.xlsx')
df_dep <- df_dea %>% filter(pAdj_t < 0.05, abs(log2FC) >= log2(2))
# df_dep_b <- df_dep %>% filter(organ == 'brain')
# df_dep_l <- df_dep %>% filter(organ == 'liver')

tsne_df <- rio::import('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/all_sample_tSNE/20230710_PUH_tsne_1731samples_cancer_type_v2.xlsx')
dfprot <- rio::import('//172.16.13.136/TPHP/TPL/libs/20220616_fraglib/protein.tsv')


# matrix and info
all<-readxl::read_excel('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/QC/20220701TPHP_1783file_117pool_info_onlyfilename-id_pm_swissprot1025.xlsx', col_types = c(rep('guess', 21), rep('numeric', 13479)))
head(colnames(all),n=25)
# info<-read_xlsx("//172.16.13.136/share/members/yuel/2022/tables/20230223_PUH_sample_information_1781files_info_edited_v6.xlsx")
info<-readxl::read_xlsx("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/QC/20230223_PUH_sample_information_1781files_info_edited_v6.xlsx")


all1<-merge(info,all[,c(1,18:ncol(all))],by="FileName",all.X=T) %>% select(-contains('iRT'))
head(colnames(all1),n=25)
# type<-all1$sample_type
df<-apply(t(all1[,-c(1:21)]),c(1,2),as.numeric)
colnames(df)<-all1$FileName

# NA imputation
nafill <- min(df, na.rm = T) * 0.5
df[is.na(df)] <- nafill


file_info <- all1 %>%
  # filter(anatomical_classification != 'plasma') %>% # do not remove plasma
  select(FileName, tissue_name, sample_type, anatomical_classification) %>% 
  rename(organ = anatomical_classification) %>% 
  mutate(sample_type = sapply(sample_type, function(x) {switch(x, adjacent = 'Noncancerous', carcinoma = 'Cancerous', x)}))
# file_info[file_info$tissue_name %in% c('fetal telencephalon', 'fetal mesencephalon', 'fetal myelencephalon', 'fetal metencephalon'), 'organ'] <- 'brain' # set fetal brain to organ brain

# file_info[which(file_info$organ == 'brain'), 'sample_type'] <- 'Brain'
rownames(file_info) <- file_info$FileName
file_info %<>% select(-FileName) %>%
  mutate(sample_type = factor(sample_type, levels = c('Fetal', 'Cancerous', 'Noncancerous', 'Normal'), ordered = T)) %>% 
  arrange(sample_type, organ)



```

## DEPs for Metascape
```{r}
df_dep_gene <- dfprot %>% select(`Protein ID`, Gene) %>% 
  rename(protein = `Protein ID`) %>% 
  inner_join(df_dep)


dep_brain <- df_dep_gene %>% filter(organ == 'brain') %>% pull(Gene)
dep_liver <- df_dep_gene %>% filter(organ == 'liver') %>% pull(Gene)

sum(is.na(dep_brain)) # 0
sum(is.na(dep_liver)) # 0
```


## GSEA (clusterProfiler 4.4.4, org.Hs.eg.db 3.15.0)
```{r}
# ht_prot2gene <- dfprot$Gene
# names(ht_prot2gene) <- dfprot$`Protein ID`

# brain
df_dea_b <- df_dea %>% filter(organ == 'brain')
genelist_b <- -log10(df_dea_b$p_t) * sign(df_dea_b$log2FC)
# names(genelist_b) <- ht_prot2gene[df_dea_b$protein]
# gn_rm <- table(names(genelist_b)) %>% .[. > 1] %>% names()
# genelist_b <- genelist_b[-which(names(genelist_b) %in% gn_rm)]
names(genelist_b) <- df_dea_b$protein
genelist_b %<>% sort(decreasing = T)

gse_b <- clusterProfiler::gseGO(geneList = genelist_b, 
             ont ="ALL", 
             keyType = "UNIPROT", 
             # nPerm = 10000,
             minGSSize = 10, 
             maxGSSize = 500, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = 'org.Hs.eg.db', 
             pAdjustMethod = "BH")

enrichplot::dotplot(gse_b, showCategory=10, split=".sign") + facet_grid(.~.sign)
# enrichplot::emapplot(gse_b, showCategory = 10)
enrichplot::cnetplot(gse_b, categorySize="pvalue", foldChange=genelist_b, showCategory = 3)
enrichplot::ridgeplot(gse_b) + labs(x = "enrichment distribution")
enrichplot::gseaplot(gse_b, by = "all", title = gse_b$Description[1], geneSetID = 1)
enrichplot::gseaplot2(gse_b, title = gse_b$Description[1], geneSetID = 1)
terms <- gse_b$Description[1:10]
enrichplot::pmcplot(terms, 2012:2022, proportion=FALSE)


# liver
df_dea_l <- df_dea %>% filter(organ == 'liver')
genelist_l <- -log10(df_dea_l$p_t) * sign(df_dea_l$log2FC)
# names(genelist_l) <- ht_prot2gene[df_dea_l$protein]
# gn_rm <- table(names(genelist_l)) %>% .[. > 1] %>% names()
# genelist_l <- genelist_l[-which(names(genelist_l) %in% gn_rm)]
names(genelist_l) <- df_dea_l$protein
genelist_l %<>% sort(decreasing = T)

gse_l <- clusterProfiler::gseGO(geneList = genelist_l, 
             ont ="ALL", 
             keyType = "UNIPROT", 
             # nPerm = 10000,
             minGSSize = 10, 
             maxGSSize = 500, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = 'org.Hs.eg.db', 
             pAdjustMethod = "BH")

enrichplot::dotplot(gse_l, showCategory=10, split=".sign") + facet_grid(.~.sign)
# enrichplot::emapplot(gse_l, showCategory = 10)
enrichplot::cnetplot(gse_l, categorySize="pvalue", foldChange=genelist_l, showCategory = 3)
enrichplot::ridgeplot(gse_l) + labs(x = "enrichment distribution")
enrichplot::gseaplot(gse_l, by = "all", title = gse_l$Description[1], geneSetID = 1)
enrichplot::gseaplot2(gse_l, title = gse_l$Description[1], geneSetID = 1)
terms <- gse_l$Description[1:10]
enrichplot::pmcplot(terms, 2012:2022, proportion=FALSE)

# save(gse_b, gse_l, file = 'TPHP_DEA_brain_liver_GSEA_20231023.RData')


# visualization
pdf('TPHP_GSEA_brain.pdf', width = 12, height = 12)
enrichplot::dotplot(gse_b, showCategory=10, split=".sign") + facet_grid(.~.sign)
enrichplot::cnetplot(gse_b, categorySize="pvalue", foldChange=genelist_b, showCategory = 3)
enrichplot::ridgeplot(gse_b) + labs(x = "enrichment distribution")
for(i in 1:10){
  enrichplot::gseaplot2(gse_b, title = gse_b$Description[i], geneSetID = i) %>% print()
}
graphics.off()

pdf('TPHP_GSEA_liver.pdf', width = 12, height = 12)
enrichplot::dotplot(gse_l, showCategory=10, split=".sign") + facet_grid(.~.sign)
enrichplot::cnetplot(gse_l, categorySize="pvalue", foldChange=genelist_l, showCategory = 3)
enrichplot::ridgeplot(gse_l) + labs(x = "enrichment distribution")
for(i in 1:10){
  enrichplot::gseaplot2(gse_l, title = gse_b$Description[i], geneSetID = i) %>% print()
}
graphics.off()



# GeneSets for ssGSEA
gse_b@geneSets # 22700
gse_l@geneSets # 22700
sig_gsid_b <- gse_b@result %>% filter(ONTOLOGY == 'BP') %>% pull(ID) # 389
sig_gsid_l <- gse_l@result %>% filter(ONTOLOGY == 'BP') %>% pull(ID) # 749
sig_gsid <- union(sig_gsid_b, sig_gsid_l) # 951
gse_b@geneSets[sig_gsid]

```



## ssGSEA
```{r}
library(GSVA)
library(GSEABase)


df_log2 <- log2(df)
mat <- df_log2[unique(df_dep$protein), rownames(file_info)]

# UniprotID to Gene names
ht_prot2gene <- dfprot$Gene
names(ht_prot2gene) <- dfprot$`Protein ID`

mat_g <- mat
rownames(mat_g) <- ht_prot2gene[rownames(mat_g)]

gogmt <- getGmt("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/all_sample_tSNE/c5.go.bp.v2023.1.Hs.symbols.gmt") # GO
ssgsea <- gsva(
  expr = mat_g,# a matrix of expression values where rows correspond to genes and columns correspond to samples.
  gset.idx.list = gogmt,
  method = 'ssgsea', kcdf = 'Gaussian', abs.ranking = T
)
ssgsea %>% as.data.frame() %>% rownames_to_column() %>% rio::export('TPHP_7641DEPs_ssgsea_20231023.tsv')
# save(ssgsea, file = 'TPHP_7641DEPs_ssgsea_20231023.RData')


X <- ssgsea %>% t() %>% as.data.frame() %>% 
  merge(file_info, ., by = 'row.names')

XX <- X %>% group_by(sample_type, organ) %>% # median matrix
  summarise_at(vars(-(1:2)), median)

XX %>% filter(organ == 'brain')


```

### new plot
```{r}
#### brain
mat_gse_bs <- df_gse %>% filter(organ == 'brain') %>% pull(ID) %>% simplifyEnrichment::GO_similarity(ont = 'BP', db = 'org.Hs.eg.db')
df_gse_bs <- simplifyEnrichment::simplifyGO(mat_gse_bs)
df_gse_bs <- df_gse %>% filter(organ == 'brain') %>% inner_join(df_gse_bs, by = c(ID = 'id'))

df_gse_bs %>% count(cluster)
df_gse_bs %>% filter(GSEA.p.adjust < 0.01) %>% count(cluster)

plyr::ddply(df_gse_bs, 'cluster', function(dfsub){
  quantile(dfsub$GSEA.pvalue)
})

df_gse_bs %>% filter(cluster == 1) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 2) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 3) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 4) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 5) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 6) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 7) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 8) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 9) %>% pull(Description) %>% writeClipboard()
df_gse_bs %>% filter(cluster == 10) %>% pull(Description) %>% writeClipboard()


df_gse_bs[1:20, ] %>% # too much bias
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 9), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT brain samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))



df_gse_bs %>% plyr::ddply('cluster', function(dfsub){ # cluster10+ with mild significance
  dfsub[1, ]
}) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 9), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT brain samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))




df_gse_bs %>%
  filter(cluster %in% 1:10) %>% 
  plyr::ddply('cluster', function(dfsub){
  dfsub %>% slice(1)
}) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  # facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 9), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  scale_y_continuous(breaks = seq(-4, 4, by = 2), labels = seq(-4, 4, by = 2))+
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT brain samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))



goid_b <- c('GO:0006120',
'GO:0008380',
'GO:1903861', 'GO:0022613',
'GO:0048168', 'GO:0006974',
'GO:0032259',
'GO:0015837', 'GO:1903651',
'GO:0044774', #'GO:0044773',
'GO:0008306', 'GO:0030858',
'GO:0140694',
'GO:0061351'
)



p1 <- df_gse_bs %>%
  filter(ID %in% goid_b) %>% 
  arrange(GSEA.pvalue) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  # facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 22/3), breaks = c(100, 200, 300), labels = c(100, 200, 300), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  scale_y_continuous(breaks = seq(-4, 4, by = 2), labels = seq(-4, 4, by = 2))+
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT brain samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))

ggsave('TPHP_brain_tumor_GSEA_bubble_20231026.pdf', p1, width = 20, height = 8)


#### liver
mat_gse_ls <- df_gse %>% filter(organ == 'liver') %>% pull(ID) %>% simplifyEnrichment::GO_similarity(ont = 'BP', db = 'org.Hs.eg.db')
df_gse_ls <- simplifyEnrichment::simplifyGO(mat_gse_ls)
df_gse_ls <- df_gse %>% filter(organ == 'liver') %>% inner_join(df_gse_ls, by = c(ID = 'id'))

df_gse_ls %>% count(cluster)
df_gse_ls %>% filter(GSEA.p.adjust < 0.01) %>% count(cluster) #20

plyr::ddply(df_gse_ls, 'cluster', function(dfsub){
  quantile(dfsub$GSEA.pvalue)
})

df_gse_ls %>% filter(cluster == 1) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 2) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 3) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 4) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 5) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 6) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 7) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 8) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 9) %>% pull(Description) %>% writeClipboard()
df_gse_ls %>% filter(cluster == 10) %>% pull(Description) %>% writeClipboard()


df_gse_ls[1:40, ] %>% # too much bias
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 9), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT liver samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))



df_gse_ls %>% plyr::ddply('cluster', function(dfsub){ # cluster20+ with mild significance
  dfsub[1, ]
}) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 9), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT liver samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))




df_gse_ls %>%
  filter(cluster %in% 1:20) %>% 
  plyr::ddply('cluster', function(dfsub){
  dfsub %>% slice(1)
}) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  # facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 9), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  scale_y_continuous(breaks = seq(-4, 4, by = 2), labels = seq(-4, 4, by = 2))+
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT liver samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))



goid_l <- c('GO:0006281',
'GO:0098754',
'GO:0071466', 'GO:0006974',
'GO:0000278',
'GO:0071826',
'GO:0006403',
'GO:0007059',
'GO:0006457',
'GO:0051301',
'GO:0140694',
'GO:0007017',
'GO:0019748',
'GO:0051338',
'GO:0055088',
#'GO:0042440',
'GO:0019827',
'GO:0016032',
#'GO:1901568',
'GO:0019882'
#'GO:0019953'
)



p2a <- df_gse_ls %>%
  filter(ID %in% goid_l) %>% 
  arrange(GSEA.pvalue) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  # facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 9), breaks = c(100, 200, 300, 400), labels = c(100, 200, 300, 400), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  scale_y_continuous(breaks = seq(-4, 4, by = 2), labels = seq(-4, 4, by = 2))+
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT liver samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))

View(df_gse_ls %>% filter(cluster == 1))
View(df_gse_ls %>% filter(cluster == 2))
View(df_gse_ls %>% filter(cluster == 3))
View(df_gse_ls %>% filter(cluster == 4))
View(df_gse_ls %>% filter(cluster == 5))
View(df_gse_ls %>% filter(cluster == 6))
View(df_gse_ls %>% filter(cluster == 7))
View(df_gse_ls %>% filter(cluster == 8))
View(df_gse_ls %>% filter(cluster == 9))
View(df_gse_ls %>% filter(cluster == 10))
View(df_gse_ls %>% filter(cluster == 11))
View(df_gse_ls %>% filter(cluster == 12))
View(df_gse_ls %>% filter(cluster == 13))
View(df_gse_ls %>% filter(cluster == 14))
View(df_gse_ls %>% filter(cluster == 15))
View(df_gse_ls %>% filter(cluster == 16))
View(df_gse_ls %>% filter(cluster == 17))
View(df_gse_ls %>% filter(cluster == 18))
View(df_gse_ls %>% filter(cluster == 19))
View(df_gse_ls %>% filter(cluster == 20))


p2b <- df_gse_ls %>% filter(cluster == 1, GSEA.pvalue == 1e-10, GSEA.NES < 0) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize)) +
  # facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black", fill = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[1]) +
  scale_size(range = c(4, 9), breaks = c(100, 200, 300, 400), labels = c(100, 200, 300, 400), name = "SetSize") +
  # scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
  #                      breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  # ) +
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT liver samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))

ggsave('TPHP_liver_tumor_GSEA_bubble1_20231026.pdf', p2a, width = 20, height = 8)
ggsave('TPHP_liver_tumor_GSEA_bubble2_20231026.pdf', p2b, width = 20, height = 11)

```

### new simplify
```{r}
### new simplify
gse_b_sim <- clusterProfiler::simplify(gse_b, cutoff = 0.7, by = 'p.adjust', select_fun = min)
# enrichplot::dotplot(gse_b_sim, showCategory=10, split=".sign") + facet_grid(.~.sign)

gse_l_sim <- clusterProfiler::simplify(gse_l, cutoff = 0.7, by = 'p.adjust', select_fun = min)
# enrichplot::dotplot(gse_l_sim, showCategory=10, split=".sign") + facet_grid(.~.sign)

pdf('TPHP_liver_brain_tumor_GSEA_top5_bubble_20231112.pdf', width = 6.5, height = 9)
enrichplot::dotplot(gse_l_sim, showCategory=5, split=".sign") + facet_grid(.sign~., scale='free')
enrichplot::dotplot(gse_b_sim, showCategory=5, split=".sign") + facet_grid(.sign~., scale='free')
graphics.off()



```


## ssGSEA with ssGSEA selected GeneSets
```{r}
library(GSVA)
library(GSEABase)


df_log2 <- log2(df)
file_info_n <- file_info %>% filter(sample_type == 'Normal')
mat <- df_log2[, rownames(file_info_n)]
dim(mat) # 13477 proteins, 560 normal samples

# gogmt <- getGmt("//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/all_sample_tSNE/c5.go.bp.v2023.1.Hs.symbols.gmt") # GO
ssgsea <- gsva(
  expr = mat,# a matrix of expression values where rows correspond to genes and columns correspond to samples.
  # gset.idx.list = gogmt,
  gset.idx.list = gse_b@geneSets[sig_gsid], # including 951 GOBP terms
  method = 'ssgsea', kcdf = 'Gaussian', abs.ranking = T
)
ssgsea %>% as.data.frame() %>% rownames_to_column() %>% rio::export('TPHP_13477proteins_560normalSamples_ssgsea_20231023.tsv')
# save(ssgsea, file = 'TPHP_13477proteins_560normalSamples_ssgsea_921GOBP_20231023.RData')


pacman::p_unload(pacman::p_loaded(), character.only = T)
library(tidyverse)
library(magrittr)
```

## bubble plot
```{r}
load('TPHP_DEA_brain_liver_GSEA_20231023.RData') # gse_b; gse_l
load('TPHP_13477proteins_560normalSamples_ssgsea_921GOBP_20231023.RData') # ssgsea

df_gse <- list(gse_b@result, gse_l@result) %>% setNames(c('brain', 'liver')) %>% 
  plyr::ldply(.id = 'organ', .fun = function(dfsub) dfsub %>% filter(ONTOLOGY == 'BP'))

X <- ssgsea %>% t() %>% as.data.frame() %>% 
  merge(file_info_n, ., by = 'row.names')

XX <- X %>% group_by(sample_type, organ) %>% # median matrix
  summarise_at(vars(-(1:2)), median) %>% ungroup()

df_ssgsea <- XX %>% select(-sample_type) %>% 
  filter(organ %in% c('brain', 'liver')) %>% 
  pivot_longer(-organ, names_to = 'ID', values_to = 'ssGSEA.NES')



# bubble plot
# library(hrbrthemes)
# library(viridis)
# library(gapminder)
# 
# library(showtext)
# font_add('Arial','/Library/Fonts/Arial.ttf') #MAC  /Library/Fonts
# showtext_auto() #showtextggsave()ggsave
# 

df_bubble <- df_ssgsea %>% full_join(df_gse)
df_bubble$Gene.Ratio <- sapply(1:nrow(df_bubble), function(i){
  df_bubble$setSize[i] / length(gse_b@geneSets[[df_bubble$ID[i]]])
})

p_brain <- df_bubble %>% filter(organ == 'brain') %>% 
  ggplot(aes(x = ssGSEA.NES, y = NES, size = `Gene.Ratio`, fill=-log10(pvalue))) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(1, 8), name="Gene.Ratio") +
  scale_fill_gradientn(colours = rev(paletteer_c(`"grDevices::Blues"`, n = 100)),
                       # limits=c(0, 10)
                       ) +
  # scale_fill_viridis(discrete=TRUE, guide='right', option="D") +
  # scale_fill_brewer(palette = 'Blues')+
  # scale_fill_manual(values = c('#d78160', '#303054'))+
  # scale_fill_continuous(type = 'gradient') +
  # theme_ipsum() +
  theme_bw() +
  ylab("ssGSEA NES of normal brain samples") +
  xlab("GSEA NES of T/NT brain samples") +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  labs(
    #title = '',
    #subtitle = '',
    #caption = '',
    #tag = '',
    #x = '',
    #y = 'Protein intensity CV'
  )+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))

p_liver <- df_bubble %>% filter(organ == 'liver') %>% 
  ggplot(aes(x = ssGSEA.NES, y = NES, size = `Gene.Ratio`, fill=-log10(pvalue))) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(1, 8), name="Gene.Ratio") +
  scale_fill_gradientn(colours = rev(paletteer_c(`"grDevices::Blues"`, n = 100)),
                       # limits=c(0, 10)
                       ) +
  # scale_fill_viridis(discrete=TRUE, guide='right', option="D") +
  # scale_fill_brewer(palette = 'Blues')+
  # scale_fill_manual(values = c('#d78160', '#303054'))+
  # scale_fill_continuous(type = 'gradient') +
  # theme_ipsum() +
  theme_bw() +
  ylab("ssGSEA NES of normal liver samples") +
  xlab("GSEA NES of T/NT liver samples") +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  labs(
    #title = '',
    #subtitle = '',
    #caption = '',
    #tag = '',
    #x = '',
    #y = 'Protein intensity CV'
  )+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))

pdf('TPHP_brain_liver_tumor_GSEA_normal_ssGSEA_bubble_20231023.pdf', width = 17, height = 12)
print(p_brain)
print(p_liver)
graphics.off()


list(brain = df_bubble %>% filter(organ == 'brain') %>% relocate(NES, .before = ssGSEA.NES) %>% arrange(NES, ssGSEA.NES),
     liver = df_bubble %>% filter(organ == 'liver') %>% relocate(NES, .before = ssGSEA.NES) %>% arrange(NES, ssGSEA.NES)) %>% 
  rio::export('TPHP_brain_liver_tumor_GSEA_normal_ssGSEA_bubble_20231023.xlsx')

```

## normal enriched centroid
```{r}
source('//172.16.13.136/share/members/jiangwenhao/code/my_fun.R')
boxlist <- read_excel_allsheets('//172.16.13.136/share/members/jiangwenhao/TPHP/20220908/normal_classification/20230717_box_list.xlsx')

bf.list<-list()
for (i in seq_along(boxlist)){
  cat(i, '...\r')
  bx<-as.data.frame(t(boxlist[[i]]))
  bx$UNIPROT<-rownames(bx)
  goall <- clusterProfiler::enrichGO(
    bx$UNIPROT, OrgDb = "org.Hs.eg.db", keyType = "UNIPROT", ont = "ALL",
    minGSSize = 10, maxGSSize = 500, readable = T,
    pvalueCutoff = 0.05, pAdjustMethod = "BH"
  )
  df_GO <- DOSE::gsfilter(goall, min = 10, max = 500)[]
  bf.list[[i]] <- df_GO
  # pro.list<-strsplit(bf.list[[i]]$geneID,split = "/")
  # bf.list[[i]]$medain<-sapply(pro.list,function(v){median(bx[v,]$Median)})
  # bf.list[[i]]$sum<-sapply(pro.list,function(v){sum(bx[v,]$Median)})  
}
names(bf.list)<-names(boxlist)


# GOBP of brain and liver
df_GO_brain <- bf.list[['brain']] # 32nd
df_GO_liver <- bf.list[['liver']] # 35th
df_GOBP <- list(brain = df_GO_brain, liver = df_GO_liver) %>%
  plyr::ldply(.id = 'organ') %>% 
  filter(ONTOLOGY == 'BP')



# combine GOBP and GSEA
colnames(df_GOBP)[-(1:4)] %<>% str_c('GOBP.', .)
colnames(df_gse)[-(1:4)] %<>% str_c('GSEA.', .)
df_bar <- df_GOBP %>% full_join(df_gse)

```

## normal + GSEA without filtering
```{r}
# GSEA without filtering
gse_b_new <- clusterProfiler::gseGO(geneList = genelist_b, 
                                ont ="ALL", 
                                keyType = "UNIPROT", 
                                # nPerm = 10000,
                                minGSSize = 10, 
                                maxGSSize = 500, 
                                pvalueCutoff = 1, 
                                verbose = TRUE, 
                                OrgDb = 'org.Hs.eg.db', 
                                pAdjustMethod = "BH")


gse_l_new <- clusterProfiler::gseGO(geneList = genelist_l, 
                                ont ="ALL", 
                                keyType = "UNIPROT", 
                                # nPerm = 10000,
                                minGSSize = 10, 
                                maxGSSize = 500, 
                                pvalueCutoff = 1, 
                                verbose = TRUE, 
                                OrgDb = 'org.Hs.eg.db', 
                                pAdjustMethod = "BH")



df_gse_new <- list(gse_b_new@result, gse_l_new@result) %>% setNames(c('brain', 'liver')) %>% 
  plyr::ldply(.id = 'organ', .fun = function(dfsub) dfsub %>% filter(ONTOLOGY == 'BP'))


colnames(df_gse_new)[-(1:4)] %<>% str_c('GSEA.', .)
# df_bar_new <- df_GOBP %>% full_join(df_gse_new)
# rio::export(df_bar_new, 'TPHP_brain_liver_GOBP_GSEA_combine_20231024.xlsx')

GOBP_GSE <- df_GOBP %>% full_join(df_gse_new) %>%
  filter(!is.na(GOBP.pvalue)) %>% arrange(organ, GOBP.pvalue)

df_bar1 <- GOBP_GSE %>% filter(organ == 'brain') %>% arrange(GOBP.pvalue)
df_bar2 <- GOBP_GSE %>% filter(organ == 'liver') %>% arrange(GOBP.pvalue)

```

### GO similratiry
#### brain
```{r}
# remotes::install_github("jokergoo/simplifyEnrichment")
sim_mat <- simplifyEnrichment::GO_similarity(df_bar1$ID, ont = 'BP', db = 'org.Hs.eg.db')
sim_df <- simplifyEnrichment::simplifyGO(sim_mat)

sim_df %>% count(cluster)

goid1 <- sim_df %>% filter(cluster == 1) %>% pull(id) # organics metabolic process
goid2 <- sim_df %>% filter(cluster == 2) %>% pull(id) # cellular respiration
goid3 <- sim_df %>% filter(cluster == 3) %>% pull(id) # synaptic vesicle cycle
goid4 <- sim_df %>% filter(cluster == 4) %>% pull(id) # cytoskeleton
goid6 <- sim_df %>% filter(cluster == 6) %>% pull(id) # autophagy
goid9 <- sim_df %>% filter(cluster == 9) %>% pull(id) # regulation of synaptic plasticity
goid10 <- sim_df %>% filter(cluster == 10) %>% pull(id) # cytokinesis
goid11 <- sim_df %>% filter(cluster == 11) %>% pull(id) # virus
goid12 <- sim_df %>% filter(cluster == 12) %>% pull(id) # Ras superfamily
goid14 <- sim_df %>% filter(cluster == 14) %>% pull(id) # neuron development
goid15 <- sim_df %>% filter(cluster == 15) %>% pull(id) # cell response to stimulation

goid5 <- sim_df %>% filter(cluster == 5) %>% pull(id) # protein folding
goid8 <- sim_df %>% filter(cluster == 8) %>% pull(id) # establishment or maintenance of cell polarity

goid7 <- sim_df %>% filter(cluster == 7) %>% pull(id) # membrane docking
goid13 <- sim_df %>% filter(cluster == 13) %>% pull(id) # regulation of microtubule-based process
goid16 <- sim_df %>% filter(cluster == 16) %>% pull(id) # regulation of cell-substrate adhesion; homotypic cell-cell adhesion
goid17 <- sim_df %>% filter(cluster == 17) %>% pull(id) # intermediate filament-based process
goid18 <- sim_df %>% filter(cluster == 18) %>% pull(id) # regulation of RNA binding; negative regulation of transferase activity
goid19 <- sim_df %>% filter(cluster == 19) %>% pull(id) # negative regulation of neuron death
goid20 <- sim_df %>% filter(cluster == 20) %>% pull(id) # adult behavior


df_bar1 %>% filter(ID %in% goid20) %>% pull(Description) %>% writeClipboard()

df_bar1 %>% full_join(sim_df, by = c(ID = 'id'))
df_bar1s <- df_bar1 %>% full_join(sim_df, by = c(ID = 'id')) %>%
  plyr::ddply('cluster', function(dfsub) dfsub[1, ])


df_bar1s$Description %<>% factor(., levels = rev(.), ordered = T)
ggplot(df_bar1s) +
  aes(x = Description, y = -log10(GOBP.pvalue), group = Description, fill = ONTOLOGY) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity",position = 'dodge')+
  geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
            size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c('green3'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10P") +
  coord_flip() +
  ggthemes::theme_base()# + theme(legend.position='none')


# top20
df_bar1ss <- df_bar1s %>% select(Description, GOBP.pvalue, GSEA.pvalue, GSEA.NES) %>% 
  pivot_longer(cols = c('GOBP.pvalue', 'GSEA.pvalue'), names_to = 'Type', values_to = 'P') %>% 
  mutate(Type = str_remove(Type, '\\.pvalue$')) %>% 
  mutate(P = -log10(P))

df_bar1ss[df_bar1ss$Type == 'GSEA', 'P'] %<>% `*`(-1)
df_bar1ss[which(df_bar1ss$Type == 'GSEA' & df_bar1ss$GSEA.NES > 0), 'Type'] <- 'Tumor-up'
df_bar1ss[which(df_bar1ss$Type == 'GSEA' & df_bar1ss$GSEA.NES < 0), 'Type'] <- 'Tumor-down'
df_bar1ss[which(df_bar1ss$Type == 'GSEA'), 'Type'] <- 'NA'
df_bar1ss[which(df_bar1ss$Type == 'GOBP'), 'Type'] <- 'Normal-enriched'

p_brain <- ggplot(df_bar1ss) +
  aes(x = Description, y = P, group = Description, fill = Type) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity", position = 'dodge', color = 'black')+
  geom_hline(yintercept = c(log10(0.05), -log10(0.05)), color = 'black') + 
  # geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
  #           size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c(`Tumor-up` = 'red3', `Tumor-down` = 'blue3', `Normal-enriched` = 'green3', 'NA' = 'gray'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10 P value") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-8, 26, by = 4), labels = abs(seq(-8, 26, by = 4))) +
  ggthemes::theme_base()# + theme(legend.position='none')

ggsave('TPHP_brain_normalEnrich_GOBP_tumor_GSEA_barplot_20231025.pdf', p_brain, width = 16, height = 8)

list(barplot = df_bar1ss,
     GOBP.enrichment = df_bar1 %>% full_join(sim_df, by = c(ID = 'id')),
     GOBP.similarity = sim_mat) %>% 
  rio::export('TPHP_brain_normalEnrich_GOBP_tumor_GSEA_barplot_20231025.xlsx')

df_bar1_top20 <- df_bar1 %>% slice(1:20) %>% mutate(Description = factor(Description, levels = rev(Description), ordered = T)) %>% 
  select(Description, GOBP.pvalue, GSEA.pvalue, GSEA.NES) %>% 
  pivot_longer(cols = c('GOBP.pvalue', 'GSEA.pvalue'), names_to = 'Type', values_to = 'P') %>% 
  mutate(Type = str_remove(Type, '\\.pvalue$')) %>% 
  mutate(P = -log10(P))

df_bar1_top20[df_bar1_top20$Type == 'GSEA', 'P'] %<>% `*`(-1)
df_bar1_top20[which(df_bar1_top20$Type == 'GSEA' & df_bar1_top20$GSEA.NES > 0), 'Type'] <- 'Tumor-up'
df_bar1_top20[which(df_bar1_top20$Type == 'GSEA' & df_bar1_top20$GSEA.NES < 0), 'Type'] <- 'Tumor-down'
df_bar1_top20[which(df_bar1_top20$Type == 'GSEA'), 'Type'] <- 'NA'
df_bar1_top20[which(df_bar1_top20$Type == 'GOBP'), 'Type'] <- 'Normal-enriched'

p_brain_top <- ggplot(df_bar1_top20) +
  aes(x = Description, y = P, group = Description, fill = Type) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity", position = 'dodge', color = 'black')+
  geom_hline(yintercept = c(log10(0.05), -log10(0.05)), color = 'black') + 
  # geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
  #           size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c(`Tumor-up` = 'red3', `Tumor-down` = 'blue3', `Normal-enriched` = 'green3', 'NA' = 'gray'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10 P value") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-8, 26, by = 4), labels = abs(seq(-8, 26, by = 4))) +
  ggthemes::theme_base()# + theme(legend.position='none')

ggsave('TPHP_brain_normalEnrich_GOBP_tumor_GSEA_barplot_top20_20231025.pdf', p_brain, width = 20, height = 8)

```

#### liver
```{r}
sim_mat <- simplifyEnrichment::GO_similarity(df_bar2$ID, ont = 'BP', db = 'org.Hs.eg.db')
sim_df <- simplifyEnrichment::simplifyGO(sim_mat)

sim_df %>% count(cluster)

goid1 <- sim_df %>% filter(cluster == 1) %>% pull(id) # organics metabolic process
goid2 <- sim_df %>% filter(cluster == 2) %>% pull(id) # cytoskeleton
goid3 <- sim_df %>% filter(cluster == 3) %>% pull(id) # protein folding
goid4 <- sim_df %>% filter(cluster == 4) %>% pull(id) # transport
goid5 <- sim_df %>% filter(cluster == 5) %>% pull(id) # cell response to stimulation
goid6 <- sim_df %>% filter(cluster == 6) %>% pull(id) # virus
goid7 <- sim_df %>% filter(cluster == 7) %>% pull(id) # coagulation
goid8 <- sim_df %>% filter(cluster == 8) %>% pull(id) # interaction with host
goid9 <- sim_df %>% filter(cluster == 9) %>% pull(id) # homeostasis
goid10 <- sim_df %>% filter(cluster == 10) %>% pull(id) # cytokinesis

goid11 <- sim_df %>% filter(cluster == 11) %>% pull(id) # cell adhesion
goid12 <- sim_df %>% filter(cluster == 12) %>% pull(id) # establishment or maintenance of cell polarity
goid14 <- sim_df %>% filter(cluster == 14) %>% pull(id) # RNA binding


goid13 <- sim_df %>% filter(cluster == 13) %>% pull(id) # membrane docking
goid15 <- sim_df %>% filter(cluster == 15) %>% pull(id) # actin filament severing
goid16 <- sim_df %>% filter(cluster == 16) %>% pull(id) # substantia nigra development
goid17 <- sim_df %>% filter(cluster == 17) %>% pull(id) # amyloid-beta clearance
goid18 <- sim_df %>% filter(cluster == 18) %>% pull(id) # antigen processing and presentation of peptide antigen via MHC class I
goid19 <- sim_df %>% filter(cluster == 19) %>% pull(id) # low-density lipoprotein particle clearance

df_bar2 %>% filter(ID %in% goid1) %>% pull(Description) %>% writeClipboard()


df_bar2 %>% full_join(sim_df, by = c(ID = 'id'))
df_bar2s <- df_bar2 %>% full_join(sim_df, by = c(ID = 'id')) %>%
  plyr::ddply('cluster', function(dfsub) dfsub[1, ])


df_bar2s$Description %<>% factor(., levels = rev(.), ordered = T)
ggplot(df_bar2s) +
  aes(x = Description, y = -log10(GOBP.pvalue), group = Description, fill = ONTOLOGY) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity",position = 'dodge')+
  geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
            size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c('green3'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10P") +
  coord_flip() +
  ggthemes::theme_base()# + theme(legend.position='none')


df_bar2ss <- df_bar2s %>% select(Description, GOBP.pvalue, GSEA.pvalue, GSEA.NES) %>% 
  pivot_longer(cols = c('GOBP.pvalue', 'GSEA.pvalue'), names_to = 'Type', values_to = 'P') %>% 
  mutate(Type = str_remove(Type, '\\.pvalue$')) %>% 
  mutate(P = -log10(P))

df_bar2ss[df_bar2ss$Type == 'GSEA', 'P'] %<>% `*`(-1)
df_bar2ss[which(df_bar2ss$Type == 'GSEA' & df_bar2ss$GSEA.NES > 0), 'Type'] <- 'Tumor-up'
df_bar2ss[which(df_bar2ss$Type == 'GSEA' & df_bar2ss$GSEA.NES < 0), 'Type'] <- 'Tumor-down'
df_bar2ss[which(df_bar2ss$Type == 'GSEA'), 'Type'] <- 'NA'
df_bar2ss[which(df_bar2ss$Type == 'GOBP'), 'Type'] <- 'Normal-enriched'

p_liver <- ggplot(df_bar2ss) +
  aes(x = Description, y = P, group = Description, fill = Type) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity", position = 'dodge', color = 'black')+
  geom_hline(yintercept = c(log10(0.05), -log10(0.05)), color = 'black') + 
  # geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
  #           size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c(`Tumor-up` = 'red3', `Tumor-down` = 'blue3', `Normal-enriched` = 'green3', 'NA' = 'gray'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10 P value") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-8, 38, by = 4), labels = abs(seq(-8, 38, by = 4))) +
  ggthemes::theme_base()# + theme(legend.position='none')

ggsave('TPHP_liver_normalEnrich_GOBP_tumor_GSEA_barplot_20231025.pdf', p_liver, width = 20, height = 8)

list(barplot = df_bar2ss,
     GOBP.enrichment = df_bar2 %>% full_join(sim_df, by = c(ID = 'id')),
     GOBP.similarity = sim_mat) %>% 
  rio::export('TPHP_liver_normalEnrich_GOBP_tumor_GSEA_barplot_20231025.xlsx')


# top20
df_bar2_top20 <- df_bar2 %>% slice(1:20) %>% mutate(Description = factor(Description, levels = rev(Description), ordered = T)) %>% 
  select(Description, GOBP.pvalue, GSEA.pvalue, GSEA.NES) %>% 
  pivot_longer(cols = c('GOBP.pvalue', 'GSEA.pvalue'), names_to = 'Type', values_to = 'P') %>% 
  mutate(Type = str_remove(Type, '\\.pvalue$')) %>% 
  mutate(P = -log10(P))

df_bar2_top20[df_bar2_top20$Type == 'GSEA', 'P'] %<>% `*`(-1)
df_bar2_top20[which(df_bar2_top20$Type == 'GSEA' & df_bar2_top20$GSEA.NES > 0), 'Type'] <- 'Tumor-up'
df_bar2_top20[which(df_bar2_top20$Type == 'GSEA' & df_bar2_top20$GSEA.NES < 0), 'Type'] <- 'Tumor-down'
df_bar2_top20[which(df_bar2_top20$Type == 'GSEA'), 'Type'] <- 'NA'
df_bar2_top20[which(df_bar2_top20$Type == 'GOBP'), 'Type'] <- 'Normal-enriched'

p_liver_top <- ggplot(df_bar2_top20) +
  aes(x = Description, y = P, group = Description, fill = Type) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity", position = 'dodge', color = 'black')+
  geom_hline(yintercept = c(log10(0.05), -log10(0.05)), color = 'black') + 
  # geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
  #           size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c(`Tumor-up` = 'red3', `Tumor-down` = 'blue3', `Normal-enriched` = 'green3', 'NA' = 'gray'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10 P value") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-8, 38, by = 4), labels = abs(seq(-8, 38, by = 4))) +
  ggthemes::theme_base()# + theme(legend.position='none')

ggsave('TPHP_liver_normalEnrich_GOBP_tumor_GSEA_barplot_top20_20231025.pdf', p_liver_top, width = 20, height = 8)




pdf('TPHP_liver_brain_normalEnrich_GOBP_tumor_GSEA_barplot_20231025.pdf', width = 12, height = 8)
print(p_liver)
print(p_brain)
graphics.off()

pdf('TPHP_liver_brain_normalEnrich_GOBP_tumor_GSEA_barplot_top_20231025.pdf', width = 10, height = 8)
print(p_liver_top)
print(p_brain_top)
graphics.off()
```

#### normal only
```{r}
# GOBP only
p_bn <- df_bar1ss %>% 
  filter(Type == 'Normal-enriched') %>% 
  ggplot() +
  aes(x = Description, y = P, group = Description, fill = Type) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity", position = 'dodge', color = 'black')+
  # geom_hline(yintercept = c(log10(0.05), -log10(0.05)), color = 'black') + 
  # geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
  #           size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c(`Tumor-up` = '#E41A1C', `Tumor-down` = '#377EB8', `Normal-enriched` = '#4DAF4A', 'NA' = 'gray'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10 P value") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-8, 26, by = 4), labels = abs(seq(-8, 26, by = 4))) +
  ggthemes::theme_base()# + theme(legend.position='none')
ggsave('TPHP_brain_normalEnrich_GOBP_barplot_20231026.pdf', p_bn, width = 12, height = 8)


p_ln <- df_bar2ss %>% 
  filter(Type == 'Normal-enriched') %>% 
  ggplot() +
  aes(x = Description, y = P, group = Description, fill = Type) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity", position = 'dodge', color = 'black')+
  # geom_hline(yintercept = c(log10(0.05), -log10(0.05)), color = 'black') + 
  # geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
  #           size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c(`Tumor-up` = '#E41A1C', `Tumor-down` = '#377EB8', `Normal-enriched` = '#4DAF4A', 'NA' = 'gray'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10 P value") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-8, 38, by = 4), labels = abs(seq(-8, 38, by = 4))) +
  ggthemes::theme_base()# + theme(legend.position='none')
ggsave('TPHP_liver_normalEnrich_GOBP_barplot_20231026.pdf', p_ln, width = 14, height = 8)



```

## new
```{r}
library(paletteer)
# save(df_bar1ss, df_bar2ss, df_gse_bs, goid_b, df_gse_ls, goid_l, file = 'TPHP_liver_brain_normalEnrich_GOBP_tumor_GSEA_20231026.RData')
load('TPHP_liver_brain_normalEnrich_GOBP_tumor_GSEA_20231026.RData')

p1 <- df_gse_bs %>%
  filter(ID %in% goid_b) %>% 
  arrange(GSEA.pvalue) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  # facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 22/3), breaks = c(100, 200, 300), labels = c(100, 200, 300), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  scale_y_continuous(breaks = seq(-4, 4, by = 2), labels = seq(-4, 4, by = 2))+
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT brain samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))

p2a <- df_gse_ls %>%
  filter(ID %in% goid_l) %>% 
  arrange(GSEA.pvalue) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize, fill=GSEA.logP)) +
  # facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black") +
  scale_size(range = c(4, 9), breaks = c(100, 200, 300, 400), labels = c(100, 200, 300, 400), name = "SetSize") +
  scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
                       breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  ) +
  scale_y_continuous(breaks = seq(-4, 4, by = 2), labels = seq(-4, 4, by = 2))+
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT liver samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))

p2b <- df_gse_ls %>% filter(cluster == 1, GSEA.pvalue == 1e-10, GSEA.NES < 0) %>% 
  mutate(Description = factor(Description, levels = rev(Description), ordered = T),
         GSEA.logP = ifelse(GSEA.NES > 0, -log10(GSEA.pvalue), log10(GSEA.pvalue)),
         Type = ifelse(GSEA.NES > 0, 'Activated', 'Suppressed') %>% factor(levels = c('Suppressed', 'Activated'))) %>% 
  ggplot(aes(x = Description, y = GSEA.NES, size = GSEA.setSize)) +
  # facet_grid(cols = vars(Type)) +
  geom_point(alpha=0.8, shape=21, color="black", fill = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[1]) +
  scale_size(range = c(4, 9), breaks = c(100, 200, 300, 400), labels = c(100, 200, 300, 400), name = "SetSize") +
  # scale_fill_gradientn(colours = paletteer_c(`"grDevices::Blue-Red"`, n = 100)[c(1:40, 61:100)], name = "log10(P value)",
  #                      breaks = seq(-10, 10, by = 5), labels = abs(seq(-10, 10, by = 5)), #limits = c(-10, 10),
  # ) +
  coord_flip() +
  labs(x = "", y = "GSEA NES of T/NT liver samples") +
  theme_bw() +
  theme(#legend.position = 'right',
    legend.text = element_text(size = 20,color = 'black'),legend.position = 'right',
    legend.title = element_text(size = 20,color = 'black'),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(colour = 'black'))+
  # theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = 30,color = 'black'))+
  theme(axis.text.x = element_text(size = 30,color = 'black'))+
  theme(axis.text.y = element_text(size = 30,color = 'black'))+
  theme(plot.subtitle = element_text(size = 30, hjust = 0, color = 'black'))+
  theme(axis.title.x = element_text(size = 30, hjust = 0.5, color = 'black'))+
  theme(axis.title.y = element_text(size = 30, hjust = 0.5, color = 'black'))

ggsave('TPHP_brain_tumor_GSEA_bubble_20231026.pdf', p1, width = 20, height = 8)
ggsave('TPHP_liver_tumor_GSEA_bubble1_20231026.pdf', p2a, width = 20, height = 8)
ggsave('TPHP_liver_tumor_GSEA_bubble2_20231026.pdf', p2b, width = 20, height = 11)




p_bn <- df_bar1ss %>% 
  filter(Type == 'Normal-enriched') %>% 
  ggplot() +
  aes(x = Description, y = P, group = Description, fill = Type) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity", position = 'dodge', color = 'black')+
  # geom_hline(yintercept = c(log10(0.05), -log10(0.05)), color = 'black') + 
  # geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
  #           size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c(`Tumor-up` = '#E41A1C', `Tumor-down` = '#377EB8', `Normal-enriched` = '#4DAF4A', 'NA' = 'gray'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10 P value") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-8, 26, by = 4), labels = abs(seq(-8, 26, by = 4))) +
  theme_bw()# + theme(legend.position='none')

p_ln <- df_bar2ss %>% 
  filter(Type == 'Normal-enriched') %>% 
  ggplot() +
  aes(x = Description, y = P, group = Description, fill = Type) +
  #geom_col(position = position_dodge(0.1)) +
  geom_bar(stat="identity", position = 'dodge', color = 'black')+
  # geom_hline(yintercept = c(log10(0.05), -log10(0.05)), color = 'black') + 
  # geom_text(aes(label = GOBP.BgRatio), # set the second columns as label of numbers
  #           size = 3, hjust = 0.5, vjust = 0, position = "stack", color = 'black')+
  scale_fill_manual(values = c(`Tumor-up` = '#E41A1C', `Tumor-down` = '#377EB8', `Normal-enriched` = '#4DAF4A', 'NA' = 'gray'))+
  # scale_color_brewer(palette = "Set3", direction = 1) +
  labs(x = "", y = "-log10 P value") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-8, 38, by = 4), labels = abs(seq(-8, 38, by = 4))) +
  theme_bw()# + theme(legend.position='none')

ggsave('TPHP_brain_normalEnrich_GOBP_barplot_20231026.pdf', p_bn, width = 12, height = 8)
ggsave('TPHP_liver_normalEnrich_GOBP_barplot_20231026.pdf', p_ln, width = 13, height = 8)

```

## new simplify
```{r}
### new simplify
bf.list<-list()
for (i in seq_along(boxlist)){
  cat(i, '...\r')
  bx<-as.data.frame(t(boxlist[[i]]))
  bx$UNIPROT<-rownames(bx)
  goall <- clusterProfiler::enrichGO(
    bx$UNIPROT, OrgDb = "org.Hs.eg.db", keyType = "UNIPROT", ont = "ALL",
    minGSSize = 10, maxGSSize = 500, readable = T,
    pvalueCutoff = 0.05, pAdjustMethod = "BH"
  )
  df_GO <- DOSE::gsfilter(goall, min = 10, max = 500)[]
  bf.list[[i]] <- df_GO
  # pro.list<-strsplit(bf.list[[i]]$geneID,split = "/")
  # bf.list[[i]]$medain<-sapply(pro.list,function(v){median(bx[v,]$Median)})
  # bf.list[[i]]$sum<-sapply(pro.list,function(v){sum(bx[v,]$Median)})  
}
names(bf.list)<-names(boxlist)
df_GO_brain <- bf.list[['brain']] # 32nd
df_GO_liver <- bf.list[['liver']] # 35th





goeliver <- clusterProfiler::enrichGO(
  rownames(as.data.frame(t(boxlist[[35]]))), OrgDb = "org.Hs.eg.db", keyType = "UNIPROT", ont = "ALL",
  minGSSize = 10, maxGSSize = 500, readable = T,
  pvalueCutoff = 0.05, pAdjustMethod = "BH"
)

goebrain <- clusterProfiler::enrichGO(
  rownames(as.data.frame(t(boxlist[[32]]))), OrgDb = "org.Hs.eg.db", keyType = "UNIPROT", ont = "ALL",
  minGSSize = 10, maxGSSize = 500, readable = T,
  pvalueCutoff = 0.05, pAdjustMethod = "BH"
)


goeliver_sim <- clusterProfiler::simplify(goeliver, cutoff = 0.7, by = 'p.adjust', select_fun = min)
goebrain_sim <- clusterProfiler::simplify(goebrain, cutoff = 0.7, by = 'p.adjust', select_fun = min)

pdf('TPHP_liver_brain_enriched_proteins_GOBP_top10_bubble_20231112.pdf', width = 6.5, height = 9)
enrichplot::dotplot(goeliver_sim, showCategory=10)
enrichplot::dotplot(goebrain_sim, showCategory=10)
graphics.off()

```


# EOF
```{r}
gse_b@geneSets['GO:0050804']

```



